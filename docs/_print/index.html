<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://horaedb.apache.org/docs/><link rel=alternate type=application/rss+xml href=https://horaedb.apache.org/docs/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Docs | Apache HoraeDB</title>
<meta name=description content="HoraeDB License CI OpenIssue Apache HoraeDB™ (incubating) is a high-performance, distributed, cloud native time-series database.
Motivation In the classic timeseries database, the Tag columns (InfluxDB calls them Tag and Prometheus calls them Label) are normally indexed by generating an inverted index. However, it is found that the cardinality of Tag varies in different scenarios. And in some scenarios the cardinality of Tag is very high, and it takes a very high cost to store and retrieve the inverted index. On the other hand, it is observed that scanning+pruning often used by the analytical databases can do a good job to handle such these scenarios."><meta property="og:url" content="https://horaedb.apache.org/docs/"><meta property="og:site_name" content="Apache HoraeDB"><meta property="og:title" content="Docs"><meta property="og:description" content="HoraeDB License CI OpenIssue Apache HoraeDB™ (incubating) is a high-performance, distributed, cloud native time-series database.
Motivation In the classic timeseries database, the Tag columns (InfluxDB calls them Tag and Prometheus calls them Label) are normally indexed by generating an inverted index. However, it is found that the cardinality of Tag varies in different scenarios. And in some scenarios the cardinality of Tag is very high, and it takes a very high cost to store and retrieve the inverted index. On the other hand, it is observed that scanning+pruning often used by the analytical databases can do a good job to handle such these scenarios."><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="Docs"><meta itemprop=description content="HoraeDB License CI OpenIssue Apache HoraeDB™ (incubating) is a high-performance, distributed, cloud native time-series database.
Motivation In the classic timeseries database, the Tag columns (InfluxDB calls them Tag and Prometheus calls them Label) are normally indexed by generating an inverted index. However, it is found that the cardinality of Tag varies in different scenarios. And in some scenarios the cardinality of Tag is very high, and it takes a very high cost to store and retrieve the inverted index. On the other hand, it is observed that scanning+pruning often used by the analytical databases can do a good job to handle such these scenarios."><meta itemprop=dateModified content="2024-08-21T10:34:40+08:00"><meta itemprop=wordCount content="133"><meta name=twitter:card content="summary"><meta name=twitter:title content="Docs"><meta name=twitter:description content="HoraeDB License CI OpenIssue Apache HoraeDB™ (incubating) is a high-performance, distributed, cloud native time-series database.
Motivation In the classic timeseries database, the Tag columns (InfluxDB calls them Tag and Prometheus calls them Label) are normally indexed by generating an inverted index. However, it is found that the cardinality of Tag varies in different scenarios. And in some scenarios the cardinality of Tag is very high, and it takes a very high cost to store and retrieve the inverted index. On the other hand, it is observed that scanning+pruning often used by the analytical databases can do a good job to handle such these scenarios."><link rel=preload href=/scss/main.min.5e43f8574351718e9b44966c9f3a571202ed048c082f457fb574c10b1a1bc56c.css as=style integrity="sha256-XkP4V0NRcY6bRJZsnzpXEgLtBIwIL0V/tXTBCxobxWw=" crossorigin=anonymous><link href=/scss/main.min.5e43f8574351718e9b44966c9f3a571202ed048c082f457fb574c10b1a1bc56c.css rel=stylesheet integrity="sha256-XkP4V0NRcY6bRJZsnzpXEgLtBIwIL0V/tXTBCxobxWw=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>Apache HoraeDB</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class="nav-link active" href=/docs/><i class='fa-solid fa-book'></i><span>Docs</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class='fa-brands fa-blogger'></i><span>Blog</span></a></li><li class=nav-item><a class=nav-link href=/downloads/><i class='fa-solid fa-download'></i><span>Downloads</span></a></li><li class=nav-item><a class=nav-link href=/community/><span>Community</span></a></li><li class="nav-item dropdown d-none d-lg-block"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><ul class=dropdown-menu><li><a class=dropdown-item href=/cn/docs/>中文</a></li></ul></div></li><li class="td-light-dark-menu nav-item dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown data-bs-display=static aria-label="Toggle theme (auto)"><svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class="dropdown-menu dropdown-menu-end" aria-labelledby=bd-theme-text><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></li></ul></div><div class="d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.ac4e18edf67e184de782ba34f2619be1.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/>Return to the regular view of this page</a>.</p></div><h1 class=title>Docs</h1><ul><li>1: <a href=#pg-a39c9f7aa728d5fa3b973bc6ba49228a>Getting Started</a></li><li>2: <a href=#pg-ecf7e357d2a131135219db95eddda49c>User Guide</a></li><ul><li>2.1: <a href=#pg-4d4e596e6b7e203d272697ba3d050c05>SQL Syntax</a></li><ul><li>2.1.1: <a href=#pg-b44ac2bc6defc768462e155ee00151eb>Data Model</a></li><ul><li>2.1.1.1: <a href=#pg-74978ec47e9ec45be0829b82a6a1cad7>Data Types</a></li><li>2.1.1.2: <a href=#pg-84266c71d3220e01f99899ea692d4688>Special Columns</a></li></ul><li>2.1.2: <a href=#pg-7d861cbbbb946005aa361b47211951d3>Identifier</a></li><li>2.1.3: <a href=#pg-a56eddbde23fb9aec1ef2f67e7dfaec3>Data Definition Statements</a></li><ul><li>2.1.3.1: <a href=#pg-68dd845e51ad6e6c2c8d0e90d0386830>ALTER TABLE</a></li><li>2.1.3.2: <a href=#pg-6d8b07bab2bfacd40385ad0d54b7f17c>CREATE TABLE</a></li><li>2.1.3.3: <a href=#pg-5f7ab6b13fb6fbd5ae2e2ca6e05687fd>DROP TABLE</a></li></ul><li>2.1.4: <a href=#pg-bc38c5a475ad6316c41c4e31be03630d>Data Manipulation Statements</a></li><ul><li>2.1.4.1: <a href=#pg-55eb2b9d918713a31388dd5e355f569d>INSERT</a></li><li>2.1.4.2: <a href=#pg-ae9a3b5e9aba5151ee26972acc9f7e2e>SELECT</a></li></ul><li>2.1.5: <a href=#pg-b503efb26df2941b96a344484d6a91a2>Utility Statements</a></li><li>2.1.6: <a href=#pg-6eb5d8309a31ca1c8c3311aae4346b17>Options</a></li><li>2.1.7: <a href=#pg-0ef89f21a5acc9b299f40523cb5ab1f8>Scalar Functions</a></li><li>2.1.8: <a href=#pg-efa48a3298c70ae47edb1fd4b128cd3e>Aggregate Functions</a></li></ul><li>2.2: <a href=#pg-661cb4aa667b1fa4642a1ab0fdc6656c>Cluster Deployment</a></li><ul><li>2.2.1: <a href=#pg-b594c5402ac7944a3ffa540117ff40ad>NoMeta</a></li><li>2.2.2: <a href=#pg-f8177b6910dfd52c70228b40053918c4>WithMeta</a></li></ul><li>2.3: <a href=#pg-09534b543d63f00c41f30de2514d312b>SDK</a></li><ul><li>2.3.1: <a href=#pg-c736df40c4147174f6f2d1eaeb49bdca>Go</a></li><li>2.3.2: <a href=#pg-66074b15694ea31d990c645c25042bca>Java</a></li><li>2.3.3: <a href=#pg-d8c6cac92b3914596fc657a1fa438885>Python</a></li><li>2.3.4: <a href=#pg-8b17bc3ecdfd6226bf296cc8d8c38345>Rust</a></li></ul><li>2.4: <a href=#pg-3c025d4e044df01b41b46653bf151f0b>Operation and Maintenance</a></li><ul><li>2.4.1: <a href=#pg-738a2f3b8314089a64b49e9b83ab85e7>Block List</a></li><li>2.4.2: <a href=#pg-5ee6dffed65012da62e99d132c3d88a0>Cluster Operation</a></li><li>2.4.3: <a href=#pg-8075e68e25cc23e412d57385899cca86>Observability</a></li><li>2.4.4: <a href=#pg-a415e58936001e7befe959b3318dac0e>Table Operation</a></li><li>2.4.5: <a href=#pg-5a18a99c1e89b2e34e598ab36e5b8980>Table Operation</a></li></ul><li>2.5: <a href=#pg-c93dd709b75734feb3f3eb452bb3638a>Ecosystem</a></li><ul><li>2.5.1: <a href=#pg-12941b77e52512197bc3e2eabb976682>InfluxDB</a></li><li>2.5.2: <a href=#pg-1fb5a05253c98bdbe5c288caa145feda>OpenTSDB</a></li><li>2.5.3: <a href=#pg-136053bf48d308f01c84dea97b7eed0c>Prometheus</a></li></ul></ul><li>3: <a href=#pg-cde904b13b4c787d29f40d57853861f5>Development</a></li><ul><li>3.1: <a href=#pg-efe75bc5164c17b0dd3f809d1b6dce17>Supported Platform</a></li><li>3.2: <a href=#pg-d093397cbed5d3c7c71c2c5a3d990c59>Conventional Commit Guide</a></li><li>3.3: <a href=#pg-b43b85bf4c5d805b655422565c67aaee>Compile</a></li><li>3.4: <a href=#pg-aa0192c7ef282112fff2d5b9ef838169>Profiling</a></li><li>3.5: <a href=#pg-1248c0925cc367a4f87de9dac846b46d>Rationale and Goals</a></li><li>3.6: <a href=#pg-998d0585ca29638d7ea6bebdd5056382>RoadMap</a></li><li>3.7: <a href=#pg-040fc3aac83bad085ea6f9dab4c775ce>SDK Development</a></li></ul><li>4: <a href=#pg-ddd7fbe6fc5666af530b7ac47a4a5fca>Technical and Design</a></li><ul><li>4.1: <a href=#pg-c844952d05d3541d0915cbebea8f4c2a>Compaction Offload</a></li><li>4.2: <a href=#pg-9cb1119c134a0f5bde0ea4b1c00fea17>Introduction to Architecture of HoraeDB Cluster</a></li><li>4.3: <a href=#pg-65252b1200ceedab2612d2d8e8e37aec>Introduction to HoraeDB's Architecture</a></li><li>4.4: <a href=#pg-6355ad384a13652a272ba53f173f2c7c>Storage</a></li><li>4.5: <a href=#pg-c9e7f93a52a47c5f64f3865a148a8e7e>Table Partitioning</a></li><li>4.6: <a href=#pg-87f506fcaf75ce14798677d99f59d7f6>Wal</a></li><li>4.7: <a href=#pg-0754b13496965933f1163bf7cf753a30>WAL on Disk</a></li><li>4.8: <a href=#pg-12f8303a42cd1145a4db8658c1b26f87>WAL on Kafka</a></li><li>4.9: <a href=#pg-a98f50743cbedab55a9aa0f5136cd5ff>WAL on RocksDB</a></li></ul></ul><div class=content><p><figure><img src=/images/horaedb-banner-white-small.jpg alt=HoraeDB loading=lazy><figcaption><center>HoraeDB</center></figcaption></figure></p><p><figure><img src=https://img.shields.io/badge/license-Apache--2.0-green.svg alt=License loading=lazy><figcaption><center>License</center></figcaption></figure><a href=https://github.com/apache/horaedb/actions/workflows/ci.yml><figure><img src=https://github.com/apache/horaedb/actions/workflows/ci.yml/badge.svg alt=CI loading=lazy><figcaption><center>CI</center></figcaption></figure></a><a href=https://github.com/apache/horaedb/issues><figure><img src=https://img.shields.io/github/issues/apache/horaedb alt=OpenIssue loading=lazy><figcaption><center>OpenIssue</center></figcaption></figure></a></p><p>Apache HoraeDB™ (incubating) is a high-performance, distributed, cloud native time-series database.</p><h1 id=motivation>Motivation</h1><p>In the classic timeseries database, the <code>Tag</code> columns (InfluxDB calls them <code>Tag</code> and Prometheus calls them <code>Label</code>) are normally indexed by generating an inverted index. However, it is found that the cardinality of <code>Tag</code> varies in different scenarios. And in some scenarios the cardinality of <code>Tag</code> is very high, and it takes a very high cost to store and retrieve the inverted index. On the other hand, it is observed that scanning+pruning often used by the analytical databases can do a good job to handle such these scenarios.</p><p>The basic design idea of HoraeDB is to adopt a hybrid storage format and the corresponding query method for a better performance in processing both timeseries and analytic workloads.</p></div></div><div class=td-content style=page-break-before:always><h1 id=pg-a39c9f7aa728d5fa3b973bc6ba49228a>1 - Getting Started</h1><p>This page shows you how to get started with HoraeDB quickly. You&rsquo;ll start a standalone HoraeDB server, and then insert and read some sample data using SQL.</p><h2 id=start-server>Start server</h2><p><a href=https://github.com/apache/incubator-horaedb/pkgs/container/horaedb-server>HoraeDB docker image</a> is the easiest way to get started, if you haven&rsquo;t installed Docker, go <a href=https://www.docker.com/products/docker-desktop/>there</a> to install it first.</p><blockquote><p>Note: please choose tag version >= v1.0.0, others are mainly for testing.</p></blockquote><p>You can use command below to start a standalone server</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -d --name horaedb-server <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  -p 8831:8831 <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  -p 3307:3307 <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  -p 5440:5440 <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  apache/horaedb-server
</span></span></code></pre></td></tr></table></div></div><p>HoraeDB will listen three ports when start:</p><ul><li>8831, gRPC port</li><li>3307, MySQL port</li><li>5440, HTTP port</li></ul><p>The easiest to use is HTTP, so sections below will use it for demo. For production environments, gRPC/MySQL are recommended.</p><h3 id=customize-docker-configuration>Customize docker configuration</h3><p>Refer the command as below, you can customize the configuration of horaedb-server in docker, and mount the data directory <code>/data</code> to the hard disk of the docker host machine.</p><pre tabindex=0><code>wget -c https://raw.githubusercontent.com/apache/incubator-horaedb/main/docs/minimal.toml -O horaedb.toml

sed -i &#39;s/\/tmp\/horaedb/\/data/g&#39; horaedb.toml

docker run -d --name horaedb-server \
  -p 8831:8831 \
  -p 3307:3307 \
  -p 5440:5440 \
  -v ./horaedb.toml:/etc/horaedb/horaedb.toml \
  -v ./data:/data \
  apache/horaedb-server
</code></pre><h2 id=write-and-read-data>Write and read data</h2><h3 id=create-table>Create table</h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --location --request POST <span style=color:#ba2121>&#39;http://127.0.0.1:5440/sql&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>-d <span style=color:#ba2121>&#39;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>CREATE TABLE `demo` (
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    `name` string TAG,
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    `value` double NOT NULL,
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    `t` timestamp NOT NULL,
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    timestamp KEY (t))
</span></span></span><span style=display:flex><span><span style=color:#ba2121>ENGINE=Analytic
</span></span></span><span style=display:flex><span><span style=color:#ba2121>  with
</span></span></span><span style=display:flex><span><span style=color:#ba2121>(enable_ttl=&#34;false&#34;)
</span></span></span><span style=display:flex><span><span style=color:#ba2121>&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=write-data>Write data</h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --location --request POST <span style=color:#ba2121>&#39;http://127.0.0.1:5440/sql&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>-d <span style=color:#ba2121>&#39;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>INSERT INTO demo (t, name, value)
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    VALUES (1651737067000, &#34;horaedb&#34;, 100)
</span></span></span><span style=display:flex><span><span style=color:#ba2121>&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=read-data>Read data</h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --location --request POST <span style=color:#ba2121>&#39;http://127.0.0.1:5440/sql&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>-d <span style=color:#ba2121>&#39;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>SELECT
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    *
</span></span></span><span style=display:flex><span><span style=color:#ba2121>FROM
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    `demo`
</span></span></span><span style=display:flex><span><span style=color:#ba2121>&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=show-create-table>Show create table</h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --location --request POST <span style=color:#ba2121>&#39;http://127.0.0.1:5440/sql&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>-d <span style=color:#ba2121>&#39;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>SHOW CREATE TABLE `demo`
</span></span></span><span style=display:flex><span><span style=color:#ba2121>&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=drop-table>Drop table</h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --location --request POST <span style=color:#ba2121>&#39;http://127.0.0.1:5440/sql&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>-d <span style=color:#ba2121>&#39;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>DROP TABLE `demo`
</span></span></span><span style=display:flex><span><span style=color:#ba2121>&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=using-the-sdks>Using the SDKs</h2><p>See <a href=https://horaedb.apache.org/docs/user-guide/sdk/>sdk</a>.</p><h2 id=next-step>Next Step</h2><p>Congrats, you have finished this tutorial. For more information about HoraeDB, see the following:</p><ul><li><a href=https://horaedb.apache.org/docs/user-guide/sql/>SQL Syntax</a></li><li><a href=https://horaedb.apache.org/docs/user-guide/cluster_deployment/>Deployment</a></li><li><a href=https://horaedb.apache.org/docs/user-guide/operation/>Operation</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ecf7e357d2a131135219db95eddda49c>2 - User Guide</h1></div><div class=td-content><h1 id=pg-4d4e596e6b7e203d272697ba3d050c05>2.1 - SQL Syntax</h1></div><div class=td-content><h1 id=pg-b44ac2bc6defc768462e155ee00151eb>2.1.1 - Data Model</h1><p>This chapter introduces the data model of HoraeDB.</p></div><div class=td-content><h1 id=pg-74978ec47e9ec45be0829b82a6a1cad7>2.1.1.1 - Data Types</h1><p>HoraeDB implements table model, and the supported data types are similar to MySQL.
The following table lists the mapping relationship between MySQL and HoraeDB.</p><h2 id=support-data-typecase-insensitive>Support Data Type(case-insensitive)</h2><table><thead><tr><th>SQL</th><th>HoraeDB</th></tr></thead><tbody><tr><td>null</td><td>Null</td></tr><tr><td>timestamp</td><td>Timestamp</td></tr><tr><td>double</td><td>Double</td></tr><tr><td>float</td><td>Float</td></tr><tr><td>string</td><td>String</td></tr><tr><td>Varbinary</td><td>Varbinary</td></tr><tr><td>uint64</td><td>UInt64</td></tr><tr><td>uint32</td><td>UInt32</td></tr><tr><td>uint16</td><td>UInt16</td></tr><tr><td>uint8</td><td>UInt8</td></tr><tr><td>int64/bigint</td><td>Int64</td></tr><tr><td>int32/int</td><td>Int32</td></tr><tr><td>int16/smallint</td><td>Int16</td></tr><tr><td>int8/tinyint</td><td>Int8</td></tr><tr><td>boolean</td><td>Boolean</td></tr><tr><td>date</td><td>Date</td></tr><tr><td>time</td><td>Time</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-84266c71d3220e01f99899ea692d4688>2.1.1.2 - Special Columns</h1><p>Tables in HoraeDB have the following constraints:</p><ul><li>Primary key is required</li><li>The primary key must contain a time column, and can only contain one time column</li><li>The primary key must be non-null, so all columns in primary key must be non-null.</li></ul><h2 id=timestamp-column>Timestamp Column</h2><p>Tables in HoraeDB must have one timestamp column maps to timestamp in timeseries data, such as timestamp in OpenTSDB/Prometheus.
The timestamp column can be set with <code>timestamp key</code> keyword, like <code>TIMESTAMP KEY(ts)</code>.</p><h2 id=tag-column>Tag Column</h2><p><code>Tag</code> is use to defined column as tag column, similar to tag in timeseries data, such as tag in OpenTSDB and label in Prometheus.</p><h2 id=primary-key>Primary Key</h2><p>The primary key is used for data deduplication and sorting. The primary key is composed of some columns and one time column.
The primary key can be set in the following some ways：</p><ul><li>use <code>primary key</code> keyword</li><li>use <code>tag</code> to auto generate TSID, HoraeDB will use <code>(TSID,timestamp)</code> as primary key</li><li>only set Timestamp column, HoraeDB will use <code>(timestamp)</code> as primary key</li></ul><p>Notice: If the primary key and tag are specified at the same time, then the tag column is just an additional information identification and will not affect the logic.</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:green;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>TABLE</span><span style=color:#bbb> </span>with_primary_key(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>ts<span style=color:#bbb> </span><span style=color:green;font-weight:700>TIMESTAMP</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>c1<span style=color:#bbb> </span>STRING<span style=color:#bbb> </span><span style=color:green;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>c2<span style=color:#bbb> </span>STRING<span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>c4<span style=color:#bbb> </span>STRING<span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>c5<span style=color:#bbb> </span>STRING<span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>TIMESTAMP</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>KEY</span>(ts),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>PRIMARY</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>KEY</span>(c1,<span style=color:#bbb> </span>ts)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb> </span>ENGINE<span style=color:#666>=</span>Analytic<span style=color:#bbb> </span><span style=color:green;font-weight:700>WITH</span><span style=color:#bbb> </span>(ttl<span style=color:#666>=</span><span style=color:#ba2121>&#39;7d&#39;</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>TABLE</span><span style=color:#bbb> </span>with_tag(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>ts<span style=color:#bbb> </span><span style=color:green;font-weight:700>TIMESTAMP</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>c1<span style=color:#bbb> </span>STRING<span style=color:#bbb> </span>TAG<span style=color:#bbb> </span><span style=color:green;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>c2<span style=color:#bbb> </span>STRING<span style=color:#bbb> </span>TAG<span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>c3<span style=color:#bbb> </span>STRING<span style=color:#bbb> </span>TAG<span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>c4<span style=color:#bbb> </span>DOUBLE<span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>c5<span style=color:#bbb> </span>STRING<span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>c6<span style=color:#bbb> </span>STRING<span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>TIMESTAMP</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>KEY</span>(ts)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb> </span>ENGINE<span style=color:#666>=</span>Analytic<span style=color:#bbb> </span><span style=color:green;font-weight:700>WITH</span><span style=color:#bbb> </span>(ttl<span style=color:#666>=</span><span style=color:#ba2121>&#39;7d&#39;</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>TABLE</span><span style=color:#bbb> </span>with_timestamp(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>ts<span style=color:#bbb> </span><span style=color:green;font-weight:700>TIMESTAMP</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>c1<span style=color:#bbb> </span>STRING<span style=color:#bbb> </span><span style=color:green;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>c2<span style=color:#bbb> </span>STRING<span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>c3<span style=color:#bbb> </span>STRING<span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>c4<span style=color:#bbb> </span>DOUBLE<span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>c5<span style=color:#bbb> </span>STRING<span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>c6<span style=color:#bbb> </span>STRING<span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>TIMESTAMP</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>KEY</span>(ts)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb> </span>ENGINE<span style=color:#666>=</span>Analytic<span style=color:#bbb> </span><span style=color:green;font-weight:700>WITH</span><span style=color:#bbb> </span>(ttl<span style=color:#666>=</span><span style=color:#ba2121>&#39;7d&#39;</span>);<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=tsid>TSID</h2><p>If <code>primary key</code>is not set, and tag columns is provided, TSID will auto generated from hash of tag columns.
In essence, this is also a mechanism for automatically generating id.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-7d861cbbbb946005aa361b47211951d3>2.1.2 - Identifier</h1><p>Identifier in HoraeDB can be used as table name, column name etc. It cannot be preserved keywords or start with number and punctuation symbols. HoraeDB allows to quote identifiers with back quotes (`). In this case it can be any string like <code>00_table</code> or <code>select</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a56eddbde23fb9aec1ef2f67e7dfaec3>2.1.3 - Data Definition Statements</h1><p>This chapter introduces the data definition statements.</p></div><div class=td-content><h1 id=pg-68dd845e51ad6e6c2c8d0e90d0386830>2.1.3.1 - ALTER TABLE</h1><p><code>ALTER TABLE</code> can change the schema or options of a table.</p><h2 id=alter-table-schema>ALTER TABLE SCHEMA</h2><p>HoraeDB current supports <code>ADD COLUMN</code> to alter table schema.</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#408080;font-style:italic>-- create a table and add a column to it
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>TABLE</span><span style=color:#bbb> </span><span style=color:#666>`</span>t<span style=color:#666>`</span>(a<span style=color:#bbb> </span><span style=color:green>int</span>,<span style=color:#bbb> </span>t<span style=color:#bbb> </span><span style=color:green;font-weight:700>timestamp</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb> </span><span style=color:green;font-weight:700>TIMESTAMP</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>KEY</span>(t))<span style=color:#bbb> </span>ENGINE<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Analytic;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>ALTER</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>TABLE</span><span style=color:#bbb> </span><span style=color:#666>`</span>t<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>ADD</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>COLUMN</span><span style=color:#bbb> </span>(b<span style=color:#bbb> </span>string);<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>It now becomes:</p><pre tabindex=0><code>-- DESCRIBE TABLE `t`;

name    type        is_primary  is_nullable is_tag

t       timestamp   true        false       false
tsid    uint64      true        false       false
a       int         false       true        false
b       string      false       true        false
</code></pre><h2 id=alter-table-options>ALTER TABLE OPTIONS</h2><p>HoraeDB current supports <code>MODIFY SETTING</code> to alter table schema.</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#408080;font-style:italic>-- create a table and add a column to it
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>TABLE</span><span style=color:#bbb> </span><span style=color:#666>`</span>t<span style=color:#666>`</span>(a<span style=color:#bbb> </span><span style=color:green>int</span>,<span style=color:#bbb> </span>t<span style=color:#bbb> </span><span style=color:green;font-weight:700>timestamp</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb> </span><span style=color:green;font-weight:700>TIMESTAMP</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>KEY</span>(t))<span style=color:#bbb> </span>ENGINE<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Analytic;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>ALTER</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>TABLE</span><span style=color:#bbb> </span><span style=color:#666>`</span>t<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>MODIFY</span><span style=color:#bbb> </span>SETTING<span style=color:#bbb> </span>write_buffer_size<span style=color:#666>=</span><span style=color:#ba2121>&#39;300M&#39;</span>;<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>The SQL above tries to modify the <code>write_buffer_size</code> of the table, and the table&rsquo;s option becomes:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:green;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>TABLE</span><span style=color:#bbb> </span><span style=color:#666>`</span>t<span style=color:#666>`</span><span style=color:#bbb> </span>(<span style=color:#666>`</span>tsid<span style=color:#666>`</span><span style=color:#bbb> </span>uint64<span style=color:#bbb> </span><span style=color:green;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb> </span><span style=color:#666>`</span>t<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>timestamp</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb> </span><span style=color:#666>`</span>a<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:green>int</span>,<span style=color:#bbb> </span><span style=color:green;font-weight:700>PRIMARY</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>KEY</span>(tsid,t),<span style=color:#bbb> </span><span style=color:green;font-weight:700>TIMESTAMP</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>KEY</span>(t))<span style=color:#bbb> </span>ENGINE<span style=color:#666>=</span>Analytic<span style=color:#bbb> </span><span style=color:green;font-weight:700>WITH</span>(arena_block_size<span style=color:#666>=</span><span style=color:#ba2121>&#39;2097152&#39;</span>,<span style=color:#bbb> </span>compaction_strategy<span style=color:#666>=</span><span style=color:#ba2121>&#39;default&#39;</span>,<span style=color:#bbb> </span>compression<span style=color:#666>=</span><span style=color:#ba2121>&#39;ZSTD&#39;</span>,<span style=color:#bbb> </span>enable_ttl<span style=color:#666>=</span><span style=color:#ba2121>&#39;true&#39;</span>,<span style=color:#bbb> </span>num_rows_per_row_group<span style=color:#666>=</span><span style=color:#ba2121>&#39;8192&#39;</span>,<span style=color:#bbb> </span>segment_duration<span style=color:#666>=</span><span style=color:#ba2121>&#39;&#39;</span>,<span style=color:#bbb> </span>storage_format<span style=color:#666>=</span><span style=color:#ba2121>&#39;AUTO&#39;</span>,<span style=color:#bbb> </span>ttl<span style=color:#666>=</span><span style=color:#ba2121>&#39;7d&#39;</span>,<span style=color:#bbb> </span>update_mode<span style=color:#666>=</span><span style=color:#ba2121>&#39;OVERWRITE&#39;</span>,<span style=color:#bbb> </span>write_buffer_size<span style=color:#666>=</span><span style=color:#ba2121>&#39;314572800&#39;</span>)<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>Besides, the <code>ttl</code> can be altered from 7 days to 10 days by such SQL:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:green;font-weight:700>ALTER</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>TABLE</span><span style=color:#bbb> </span><span style=color:#666>`</span>t<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>MODIFY</span><span style=color:#bbb> </span>SETTING<span style=color:#bbb> </span>ttl<span style=color:#666>=</span><span style=color:#ba2121>&#39;10d&#39;</span>;<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-6d8b07bab2bfacd40385ad0d54b7f17c>2.1.3.2 - CREATE TABLE</h1><h2 id=basic-syntax>Basic syntax</h2><p>Basic syntax:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:green;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>TABLE</span><span style=color:#bbb> </span>[<span style=color:green;font-weight:700>IF</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>EXISTS</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>table_name</span><span style=color:#bbb> </span>(<span style=color:#bbb> </span>column_definitions<span style=color:#bbb> </span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>[partition_options]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>ENGINE<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>engine_type<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>[<span style=color:green;font-weight:700>WITH</span><span style=color:#bbb> </span>(<span style=color:#bbb> </span>table_options<span style=color:#bbb> </span>)];<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>Column definition syntax:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:green;font-weight:700>column_name</span><span style=color:#bbb> </span>column_type<span style=color:#bbb> </span>[[<span style=color:green;font-weight:700>NOT</span>]<span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>]<span style=color:#bbb> </span>[TAG<span style=color:#bbb> </span><span style=color:#666>|</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>TIMESTAMP</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>KEY</span><span style=color:#bbb> </span><span style=color:#666>|</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>PRIMARY</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>KEY</span>]<span style=color:#bbb> </span>[<span style=color:green;font-weight:700>DICTIONARY</span>]<span style=color:#bbb> </span>[<span style=color:green;font-weight:700>COMMENT</span><span style=color:#bbb> </span><span style=color:#ba2121>&#39;&#39;</span>]<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>Partition options syntax:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>PARTITION<span style=color:#bbb> </span><span style=color:green;font-weight:700>BY</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>KEY</span><span style=color:#bbb> </span>(column_list)<span style=color:#bbb> </span>[PARTITIONS<span style=color:#bbb> </span>num]<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>Table options syntax are key-value pairs. Value should be quoted with quotation marks (<code>'</code>). E.g.:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>...<span style=color:#bbb> </span><span style=color:green;font-weight:700>WITH</span><span style=color:#bbb> </span>(<span style=color:#bbb> </span>enable_ttl<span style=color:#666>=</span><span style=color:#ba2121>&#39;false&#39;</span><span style=color:#bbb> </span>)<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=if-not-exists>IF NOT EXISTS</h2><p>Add <code>IF NOT EXISTS</code> to tell HoraeDB to ignore errors if the table name already exists.</p><h2 id=define-column>Define Column</h2><p>A column&rsquo;s definition should at least contains the name and type parts. All supported types are listed <a href=/docs/user-guide/sql/model/data_types/>here</a>.</p><p>Column is default be nullable. i.e. <code>NULL</code> keyword is implied. Adding <code>NOT NULL</code> constrains to make it required.</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#408080;font-style:italic>-- this definition
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>a_nullable<span style=color:#bbb> </span><span style=color:green>int</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>-- equals to
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>a_nullable<span style=color:#bbb> </span><span style=color:green>int</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>-- add NOT NULL to make it required
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>b_not_null<span style=color:#bbb> </span><span style=color:green;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span><span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>A column can be marked as <a href=/docs/user-guide/sql/model/special_columns/>special column</a> with related keyword.</p><p>For string tag column, we recommend to define it as dictionary to reduce memory consumption:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#666>`</span>tag1<span style=color:#666>`</span><span style=color:#bbb> </span>string<span style=color:#bbb> </span>TAG<span style=color:#bbb> </span><span style=color:green;font-weight:700>DICTIONARY</span><span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=engine>Engine</h2><p>Specifies which engine this table belongs to. HoraeDB current support <code>Analytic</code> engine type. This attribute is immutable.</p><h2 id=partition-options>Partition Options</h2><blockquote><p>Note: This feature is only supported in distributed version.</p></blockquote><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:green;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>TABLE</span><span style=color:#bbb> </span>...<span style=color:#bbb> </span>PARTITION<span style=color:#bbb> </span><span style=color:green;font-weight:700>BY</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>KEY</span><span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>Example below creates a table with 8 partitions, and partitioned by <code>name</code>:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:green;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>TABLE</span><span style=color:#bbb> </span><span style=color:#666>`</span>demo<span style=color:#666>`</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>`</span>name<span style=color:#666>`</span><span style=color:#bbb> </span>string<span style=color:#bbb> </span>TAG<span style=color:#bbb> </span><span style=color:green;font-weight:700>COMMENT</span><span style=color:#bbb> </span><span style=color:#ba2121>&#39;client username&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>`</span>value<span style=color:#666>`</span><span style=color:#bbb> </span>double<span style=color:#bbb> </span><span style=color:green;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>`</span>t<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>timestamp</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>timestamp</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>KEY</span><span style=color:#bbb> </span>(t)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>PARTITION<span style=color:#bbb> </span><span style=color:green;font-weight:700>BY</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>KEY</span>(name)<span style=color:#bbb> </span>PARTITIONS<span style=color:#bbb> </span><span style=color:#666>8</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>ENGINE<span style=color:#666>=</span>Analytic<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>with</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>enable_ttl<span style=color:#666>=</span><span style=color:#ba2121>&#39;false&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-5f7ab6b13fb6fbd5ae2e2ca6e05687fd>2.1.3.3 - DROP TABLE</h1><h2 id=basic-syntax>Basic syntax</h2><p>Basic syntax:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:green;font-weight:700>DROP</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>TABLE</span><span style=color:#bbb> </span>[<span style=color:green;font-weight:700>IF</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>EXISTS</span>]<span style=color:#bbb> </span><span style=color:green;font-weight:700>table_name</span><span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p><code>Drop Table</code> removes a specific table. This statement should be used with caution, because it removes both the table definition and table data, and this removal is not recoverable.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-bc38c5a475ad6316c41c4e31be03630d>2.1.4 - Data Manipulation Statements</h1><p>This chapter introduces the data manipulation statements.</p></div><div class=td-content><h1 id=pg-55eb2b9d918713a31388dd5e355f569d>2.1.4.1 - INSERT</h1><h2 id=basic-syntax>Basic syntax</h2><p>Basic syntax:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:green;font-weight:700>INSERT</span><span style=color:#bbb> </span>[<span style=color:green;font-weight:700>INTO</span>]<span style=color:#bbb> </span>tbl_name<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>[(col_name<span style=color:#bbb> </span>[,<span style=color:#bbb> </span>col_name]<span style=color:#bbb> </span>...)]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span>{</span><span style=color:#bbb> </span><span>{</span><span style=color:green;font-weight:700>VALUES</span><span style=color:#bbb> </span><span style=color:#666>|</span><span style=color:#bbb> </span>VALUE<span>}</span><span style=color:#bbb> </span>(value_list)<span style=color:#bbb> </span>[,<span style=color:#bbb> </span>(value_list)]<span style=color:#bbb> </span>...<span style=color:#bbb> </span><span>}</span><span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p><code>INSERT</code> inserts new rows into a HoraeDB table. Here is an example:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:green;font-weight:700>INSERT</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>INTO</span><span style=color:#bbb> </span>demo(<span style=color:#666>`</span>time_stammp<span style=color:#666>`</span>,<span style=color:#bbb> </span>tag1)<span style=color:#bbb> </span><span style=color:green;font-weight:700>VALUES</span>(<span style=color:#666>1667374200022</span>,<span style=color:#bbb> </span><span style=color:#ba2121>&#39;horaedb&#39;</span>)<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-ae9a3b5e9aba5151ee26972acc9f7e2e>2.1.4.2 - SELECT</h1><h2 id=basic-syntax>Basic syntax</h2><p>Basic syntax (parts between <code>[]</code> are optional):</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:green;font-weight:700>SELECT</span><span style=color:#bbb> </span>select_expr<span style=color:#bbb> </span>[,<span style=color:#bbb> </span>select_expr]<span style=color:#bbb> </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>FROM</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>table_name</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>[<span style=color:green;font-weight:700>WHERE</span><span style=color:#bbb> </span>where_condition]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>[<span style=color:green;font-weight:700>GROUP</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>BY</span><span style=color:#bbb> </span><span>{</span>col_name<span style=color:#bbb> </span><span style=color:#666>|</span><span style=color:#bbb> </span>expr<span>}</span><span style=color:#bbb> </span>...<span style=color:#bbb> </span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>[<span style=color:green;font-weight:700>ORDER</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>BY</span><span style=color:#bbb> </span><span>{</span>col_name<span style=color:#bbb> </span><span style=color:#666>|</span><span style=color:#bbb> </span>expr<span>}</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>[<span style=color:green;font-weight:700>ASC</span><span style=color:#bbb> </span><span style=color:#666>|</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>DESC</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>[<span style=color:green;font-weight:700>LIMIT</span><span style=color:#bbb> </span>[<span style=color:green;font-weight:700>offset</span>,]<span style=color:#bbb> </span><span style=color:green;font-weight:700>row_count</span><span style=color:#bbb> </span>]<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p><code>Select</code> syntax in HoraeDB is similar to mysql, here is an example:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:green;font-weight:700>SELECT</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>FROM</span><span style=color:#bbb> </span><span style=color:#666>`</span>demo<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>WHERE</span><span style=color:#bbb> </span>time_stamp<span style=color:#bbb> </span><span style=color:#666>&gt;</span><span style=color:#bbb> </span><span style=color:#ba2121>&#39;2022-10-11 00:00:00&#39;</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>AND</span><span style=color:#bbb> </span>time_stamp<span style=color:#bbb> </span><span style=color:#666>&lt;</span><span style=color:#bbb> </span><span style=color:#ba2121>&#39;2022-10-12 00:00:00&#39;</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>LIMIT</span><span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-b503efb26df2941b96a344484d6a91a2>2.1.5 - Utility Statements</h1><p>There are serval utilities SQL in HoraeDB that can help in table manipulation or query inspection.</p><h2 id=show-create-table>SHOW CREATE TABLE</h2><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:green;font-weight:700>SHOW</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>TABLE</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>table_name</span>;<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p><code>SHOW CREATE TABLE</code> returns a <code>CREATE TABLE</code> DDL that will create a same table with the given one. Including columns, table engine and options. The schema and options shows in <code>CREATE TABLE</code> will based on the current version of the table. An example:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#408080;font-style:italic>-- create one table
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>TABLE</span><span style=color:#bbb> </span><span style=color:#666>`</span>t<span style=color:#666>`</span><span style=color:#bbb> </span>(a<span style=color:#bbb> </span><span style=color:green>bigint</span>,<span style=color:#bbb> </span>b<span style=color:#bbb> </span><span style=color:green>int</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>default</span><span style=color:#bbb> </span><span style=color:#666>3</span>,<span style=color:#bbb> </span><span style=color:green;font-weight:700>c</span><span style=color:#bbb> </span>string<span style=color:#bbb> </span><span style=color:green;font-weight:700>default</span><span style=color:#bbb> </span><span style=color:#ba2121>&#39;x&#39;</span>,<span style=color:#bbb> </span>d<span style=color:#bbb> </span><span style=color:green>smallint</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>null</span>,<span style=color:#bbb> </span>t<span style=color:#bbb> </span><span style=color:green;font-weight:700>timestamp</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb> </span><span style=color:green;font-weight:700>TIMESTAMP</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>KEY</span>(t))<span style=color:#bbb> </span>ENGINE<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Analytic;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>-- Result: affected_rows: 0
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>-- show how one table should be created.
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>SHOW</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>TABLE</span><span style=color:#bbb> </span><span style=color:#666>`</span>t<span style=color:#666>`</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>-- Result DDL:
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>TABLE</span><span style=color:#bbb> </span><span style=color:#666>`</span>t<span style=color:#666>`</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>`</span>t<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>timestamp</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>`</span>tsid<span style=color:#666>`</span><span style=color:#bbb> </span>uint64<span style=color:#bbb> </span><span style=color:green;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>`</span>a<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:green>bigint</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>`</span>b<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:green>int</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>`</span><span style=color:green;font-weight:700>c</span><span style=color:#666>`</span><span style=color:#bbb> </span>string,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>`</span>d<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:green>smallint</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>PRIMARY</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>KEY</span>(t,tsid),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>TIMESTAMP</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>KEY</span>(t)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb> </span>ENGINE<span style=color:#666>=</span>Analytic<span style=color:#bbb> </span><span style=color:green;font-weight:700>WITH</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>arena_block_size<span style=color:#666>=</span><span style=color:#ba2121>&#39;2097152&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>compaction_strategy<span style=color:#666>=</span><span style=color:#ba2121>&#39;default&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>compression<span style=color:#666>=</span><span style=color:#ba2121>&#39;ZSTD&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>enable_ttl<span style=color:#666>=</span><span style=color:#ba2121>&#39;true&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>num_rows_per_row_group<span style=color:#666>=</span><span style=color:#ba2121>&#39;8192&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>segment_duration<span style=color:#666>=</span><span style=color:#ba2121>&#39;&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>ttl<span style=color:#666>=</span><span style=color:#ba2121>&#39;7d&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>update_mode<span style=color:#666>=</span><span style=color:#ba2121>&#39;OVERWRITE&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>write_buffer_size<span style=color:#666>=</span><span style=color:#ba2121>&#39;33554432&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=describe>DESCRIBE</h2><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:green;font-weight:700>DESCRIBE</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>table_name</span>;<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p><code>DESCRIBE</code> will show a detailed schema of one table. The attributes include column name and type, whether it is tag and primary key (todo: ref) and whether it&rsquo;s nullable. The auto created column <code>tsid</code> will also be included (todo: ref).</p><p>Example:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:green;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>TABLE</span><span style=color:#bbb> </span><span style=color:#666>`</span>t<span style=color:#666>`</span>(a<span style=color:#bbb> </span><span style=color:green>int</span>,<span style=color:#bbb> </span>b<span style=color:#bbb> </span>string,<span style=color:#bbb> </span>t<span style=color:#bbb> </span><span style=color:green;font-weight:700>timestamp</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb> </span><span style=color:green;font-weight:700>TIMESTAMP</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>KEY</span>(t))<span style=color:#bbb> </span>ENGINE<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Analytic;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>DESCRIBE</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>TABLE</span><span style=color:#bbb> </span><span style=color:#666>`</span>t<span style=color:#666>`</span>;<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>The result is:</p><pre tabindex=0><code>name    type        is_primary  is_nullable is_tag

t       timestamp   true        false       false
tsid    uint64      true        false       false
a       int         false       true        false
b       string      false       true        false
</code></pre><h2 id=explain>EXPLAIN</h2><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:green;font-weight:700>EXPLAIN</span><span style=color:#bbb> </span>query;<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p><code>EXPLAIN</code> shows how a query will be executed. Add it to the beginning of a query like</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:green;font-weight:700>EXPLAIN</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>SELECT</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>max</span>(value)<span style=color:#bbb> </span><span style=color:green;font-weight:700>AS</span><span style=color:#bbb> </span>c1,<span style=color:#bbb> </span><span style=color:green;font-weight:700>avg</span>(value)<span style=color:#bbb> </span><span style=color:green;font-weight:700>AS</span><span style=color:#bbb> </span>c2<span style=color:#bbb> </span><span style=color:green;font-weight:700>FROM</span><span style=color:#bbb> </span><span style=color:#666>`</span>t<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>GROUP</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>BY</span><span style=color:#bbb> </span>name;<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>will give</p><pre tabindex=0><code>logical_plan
Projection: #MAX(07_optimizer_t.value) AS c1, #AVG(07_optimizer_t.value) AS c2
  Aggregate: groupBy=[[#07_optimizer_t.name]], aggr=[[MAX(#07_optimizer_t.value), AVG(#07_optimizer_t.value)]]
    TableScan: 07_optimizer_t projection=Some([name, value])

physical_plan
ProjectionExec: expr=[MAX(07_optimizer_t.value)@1 as c1, AVG(07_optimizer_t.value)@2 as c2]
  AggregateExec: mode=FinalPartitioned, gby=[name@0 as name], aggr=[MAX(07_optimizer_t.value), AVG(07_optimizer_t.value)]
    CoalesceBatchesExec: target_batch_size=4096
      RepartitionExec: partitioning=Hash([Column { name: \&#34;name\&#34;, index: 0 }], 6)
        AggregateExec: mode=Partial, gby=[name@0 as name], aggr=[MAX(07_optimizer_t.value), AVG(07_optimizer_t.value)]
          ScanTable: table=07_optimizer_t, parallelism=8, order=None
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-6eb5d8309a31ca1c8c3311aae4346b17>2.1.6 - Options</h1><p>Options below can be used when create table for analytic engine</p><ul><li><p><code>enable_ttl</code>, <code>bool</code>. When enable TTL on a table, rows older than <code>ttl</code> will be deleted and can&rsquo;t be querid, default <code>true</code></p></li><li><p><code>ttl</code>, <code>duration</code>, lifetime of a row, only used when <code>enable_ttl</code> is <code>true</code>. default <code>7d</code>.</p></li><li><p><code>storage_format</code>, <code>string</code>. The underlying column&rsquo;s format. Availiable values:</p><ul><li><code>columnar</code>, default</li><li><code>hybrid</code>, Note: This feature is still in development, and it may change in the future.</li></ul><p>The meaning of those two values are in <a href=/docs/user-guide/sql/engine_options/#storage-format>Storage format</a> section.</p></li></ul><h2 id=storage-format>Storage Format</h2><p>There are mainly two formats supported in analytic engine. One is <code>columnar</code>, which is the traditional columnar format, with one table column in one physical column:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>| Timestamp | Device ID | Status Code | Tag 1 | Tag 2 |
</span></span><span style=display:flex><span>| --------- |---------- | ----------- | ----- | ----- |
</span></span><span style=display:flex><span>| 12:01     | A         | 0           | v1    | v1    |
</span></span><span style=display:flex><span>| 12:01     | B         | 0           | v2    | v2    |
</span></span><span style=display:flex><span>| 12:02     | A         | 0           | v1    | v1    |
</span></span><span style=display:flex><span>| 12:02     | B         | 1           | v2    | v2    |
</span></span><span style=display:flex><span>| 12:03     | A         | 0           | v1    | v1    |
</span></span><span style=display:flex><span>| 12:03     | B         | 0           | v2    | v2    |
</span></span><span style=display:flex><span>| .....     |           |             |       |       |
</span></span></code></pre></td></tr></table></div></div><p>The other one is <code>hybrid</code>, an experimental format used to simulate row-oriented storage in columnar storage to accelerate classic time-series query.</p><p>In classic time-series user cases like IoT or DevOps, queries will typically first group their result by series id(or device id), then by timestamp. In order to achieve good performance in those scenarios, the data physical layout should match this style, so the <code>hybrid</code> format is proposed like this:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span> | Device ID | Timestamp           | Status Code | Tag 1 | Tag 2 | minTime | maxTime |
</span></span><span style=display:flex><span> |-----------|---------------------|-------------|-------|-------|---------|---------|
</span></span><span style=display:flex><span> | A         | [12:01,12:02,12:03] | [0,0,0]     | v1    | v1    | 12:01   | 12:03   |
</span></span><span style=display:flex><span> | B         | [12:01,12:02,12:03] | [0,1,0]     | v2    | v2    | 12:01   | 12:03   |
</span></span><span style=display:flex><span> | ...       |                     |             |       |       |         |         |
</span></span></code></pre></td></tr></table></div></div><ul><li>Within one file, rows belonging to the same primary key(eg: series/device id) are collapsed into one row</li><li>The columns besides primary key are divided into two categories:<ul><li><code>collapsible</code>, those columns will be collapsed into a list. Used to encode <code>fields</code> in time-series table<ul><li>Note: only fixed-length type is supported now</li></ul></li><li><code>non-collapsible</code>, those columns should only contain one distinct value. Used to encode <code>tags</code> in time-series table<ul><li>Note: only string type is supported now</li></ul></li></ul></li><li>Two more columns are added, <code>minTime</code> and <code>maxTime</code>. Those are used to cut unnecessary rows out in query.<ul><li>Note: Not implemented yet.</li></ul></li></ul><h3 id=example>Example</h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:green;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>TABLE</span><span style=color:#bbb> </span><span style=color:#666>`</span>device<span style=color:#666>`</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>`</span>ts<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>timestamp</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>`</span>tag1<span style=color:#666>`</span><span style=color:#bbb> </span>string<span style=color:#bbb> </span>tag,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>`</span>tag2<span style=color:#666>`</span><span style=color:#bbb> </span>string<span style=color:#bbb> </span>tag,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>`</span>value1<span style=color:#666>`</span><span style=color:#bbb> </span>double,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>`</span>value2<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:green>int</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>timestamp</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>KEY</span><span style=color:#bbb> </span>(ts))<span style=color:#bbb> </span>ENGINE<span style=color:#666>=</span>Analytic<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>with</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>enable_ttl<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#ba2121>&#39;false&#39;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>storage_format<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#ba2121>&#39;hybrid&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>);<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>This will create a table with hybrid format, users can inspect data format with <a href=https://formulae.brew.sh/formula/parquet-tools>parquet-tools</a>. The table above should have following parquet schema:</p><pre tabindex=0><code>message arrow_schema {
  optional group ts (LIST) {
    repeated group list {
      optional int64 item (TIMESTAMP(MILLIS,false));
    }
  }
  required int64 tsid (INTEGER(64,false));
  optional binary tag1 (STRING);
  optional binary tag2 (STRING);
  optional group value1 (LIST) {
    repeated group list {
      optional double item;
    }
  }
  optional group value2 (LIST) {
    repeated group list {
      optional int32 item;
    }
  }
}
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-0ef89f21a5acc9b299f40523cb5ab1f8>2.1.7 - Scalar Functions</h1><p>HoraeDB SQL is implemented with <a href=https://github.com/CeresDB/arrow-datafusion>DataFusion</a>, Here is the list of scalar functions. See more detail, Refer to <a href=https://github.com/CeresDB/arrow-datafusion/blob/master/docs/source/user-guide/sql/scalar_functions.md>Datafusion</a></p><h2 id=math-functions>Math Functions</h2><table><thead><tr><th>Function</th><th>Description</th></tr></thead><tbody><tr><td>abs(x)</td><td>absolute value</td></tr><tr><td>acos(x)</td><td>inverse cosine</td></tr><tr><td>asin(x)</td><td>inverse sine</td></tr><tr><td>atan(x)</td><td>inverse tangent</td></tr><tr><td>atan2(y, x)</td><td>inverse tangent of y / x</td></tr><tr><td>ceil(x)</td><td>nearest integer greater than or equal to argument</td></tr><tr><td>cos(x)</td><td>cosine</td></tr><tr><td>exp(x)</td><td>exponential</td></tr><tr><td>floor(x)</td><td>nearest integer less than or equal to argument</td></tr><tr><td>ln(x)</td><td>natural logarithm</td></tr><tr><td>log10(x)</td><td>base 10 logarithm</td></tr><tr><td>log2(x)</td><td>base 2 logarithm</td></tr><tr><td>power(base, exponent)</td><td>base raised to the power of exponent</td></tr><tr><td>round(x)</td><td>round to nearest integer</td></tr><tr><td>signum(x)</td><td>sign of the argument (-1, 0, +1)</td></tr><tr><td>sin(x)</td><td>sine</td></tr><tr><td>sqrt(x)</td><td>square root</td></tr><tr><td>tan(x)</td><td>tangent</td></tr><tr><td>trunc(x)</td><td>truncate toward zero</td></tr></tbody></table><h2 id=conditional-functions>Conditional Functions</h2><table><thead><tr><th>Function</th><th>Description</th></tr></thead><tbody><tr><td>coalesce</td><td>Returns the first of its arguments that is not null. Null is returned only if all arguments are null. It is often used to substitute a default value for null values when data is retrieved for display.</td></tr><tr><td>nullif</td><td>Returns a null value if value1 equals value2; otherwise it returns value1. This can be used to perform the inverse operation of the coalesce expression.</td></tr></tbody></table><h2 id=string-functions>String Functions</h2><table><thead><tr><th>Function</th><th>Description</th></tr></thead><tbody><tr><td>ascii</td><td>Returns the numeric code of the first character of the argument. In UTF8 encoding, returns the Unicode code point of the character. In other multibyte encodings, the argument must be an ASCII character.</td></tr><tr><td>bit_length</td><td>Returns the number of bits in a character string expression.</td></tr><tr><td>btrim</td><td>Removes the longest string containing any of the specified characters from the start and end of string.</td></tr><tr><td>char_length</td><td>Equivalent to length.</td></tr><tr><td>character_length</td><td>Equivalent to length.</td></tr><tr><td>concat</td><td>Concatenates two or more strings into one string.</td></tr><tr><td>concat_ws</td><td>Combines two values with a given separator.</td></tr><tr><td>chr</td><td>Returns the character based on the number code.</td></tr><tr><td>initcap</td><td>Capitalizes the first letter of each word in a string.</td></tr><tr><td>left</td><td>Returns the specified leftmost characters of a string.</td></tr><tr><td>length</td><td>Returns the number of characters in a string.</td></tr><tr><td>lower</td><td>Converts all characters in a string to their lower case equivalent.</td></tr><tr><td>lpad</td><td>Left-pads a string to a given length with a specific set of characters.</td></tr><tr><td>ltrim</td><td>Removes the longest string containing any of the characters in characters from the start of string.</td></tr><tr><td>md5</td><td>Calculates the MD5 hash of a given string.</td></tr><tr><td>octet_length</td><td>Equivalent to length.</td></tr><tr><td>repeat</td><td>Returns a string consisting of the input string repeated a specified number of times.</td></tr><tr><td>replace</td><td>Replaces all occurrences in a string of a substring with a new substring.</td></tr><tr><td>reverse</td><td>Reverses a string.</td></tr><tr><td>right</td><td>Returns the specified rightmost characters of a string.</td></tr><tr><td>rpad</td><td>Right-pads a string to a given length with a specific set of characters.</td></tr><tr><td>rtrim</td><td>Removes the longest string containing any of the characters in characters from the end of string.</td></tr><tr><td>digest</td><td>Calculates the hash of a given string.</td></tr><tr><td>split_part</td><td>Splits a string on a specified delimiter and returns the specified field from the resulting array.</td></tr><tr><td>starts_with</td><td>Checks whether a string starts with a particular substring.</td></tr><tr><td>strpos</td><td>Searches a string for a specific substring and returns its position.</td></tr><tr><td>substr</td><td>Extracts a substring of a string.</td></tr><tr><td>translate</td><td>Translates one set of characters into another.</td></tr><tr><td>trim</td><td>Removes the longest string containing any of the characters in characters from either the start or end of string.</td></tr><tr><td>upper</td><td>Converts all characters in a string to their upper case equivalent.</td></tr></tbody></table><h2 id=regular-expression-functions>Regular Expression Functions</h2><table><thead><tr><th>Function</th><th>Description</th></tr></thead><tbody><tr><td>regexp_match</td><td>Determines whether a string matches a regular expression pattern.</td></tr><tr><td>regexp_replace</td><td>Replaces all occurrences in a string of a substring that matches a regular expression pattern with a new substring.</td></tr></tbody></table><h2 id=temporal-functions>Temporal Functions</h2><table><thead><tr><th>Function</th><th>Description</th></tr></thead><tbody><tr><td>to_timestamp</td><td>Converts a string to type Timestamp(Nanoseconds, None).</td></tr><tr><td>to_timestamp_millis</td><td>Converts a string to type Timestamp(Milliseconds, None).</td></tr><tr><td>to_timestamp_micros</td><td>Converts a string to type Timestamp(Microseconds, None).</td></tr><tr><td>to_timestamp_seconds</td><td>Converts a string to type Timestamp(Seconds, None).</td></tr><tr><td>extract</td><td>Retrieves subfields such as year or hour from date/time values.</td></tr><tr><td>date_part</td><td>Retrieves subfield from date/time values.</td></tr><tr><td>date_trunc</td><td>Truncates date/time values to specified precision.</td></tr><tr><td>date_bin</td><td>Bin date/time values to specified precision.</td></tr><tr><td>from_unixtime</td><td>Converts Unix epoch to type Timestamp(Nanoseconds, None).</td></tr><tr><td>now</td><td>Returns current time as Timestamp(Nanoseconds, UTC).</td></tr></tbody></table><h2 id=other-functions>Other Functions</h2><table><thead><tr><th>Function</th><th>Description</th></tr></thead><tbody><tr><td>array</td><td>Create an array.</td></tr><tr><td>arrow_typeof</td><td>Returns underlying type.</td></tr><tr><td>in_list</td><td>Check if value in list.</td></tr><tr><td>random</td><td>Generate random value.</td></tr><tr><td>sha224</td><td>sha224</td></tr><tr><td>sha256</td><td>sha256</td></tr><tr><td>sha384</td><td>sha384</td></tr><tr><td>sha512</td><td>sha512</td></tr><tr><td>to_hex</td><td>Convert to hex.</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-efa48a3298c70ae47edb1fd4b128cd3e>2.1.8 - Aggregate Functions</h1><p>HoraeDB SQL is implemented with <a href=https://github.com/apache/arrow-datafusion>DataFusion</a>, Here is the list of aggregate functions. See more detail, Refer to <a href=https://github.com/apache/arrow-datafusion/blob/master/docs/source/user-guide/sql/aggregate_functions.md>Datafusion</a></p><h2 id=general>General</h2><table><thead><tr><th>Function</th><th>Description</th></tr></thead><tbody><tr><td>min</td><td>Returns the minimum value in a numerical column</td></tr><tr><td>max</td><td>Returns the maximum value in a numerical column</td></tr><tr><td>count</td><td>Returns the number of rows</td></tr><tr><td>avg</td><td>Returns the average of a numerical column</td></tr><tr><td>sum</td><td>Sums a numerical column</td></tr><tr><td>array_agg</td><td>Puts values into an array</td></tr></tbody></table><h2 id=statistical>Statistical</h2><table><thead><tr><th>Function</th><th>Description</th></tr></thead><tbody><tr><td>var / var_samp</td><td>Returns the variance of a given column</td></tr><tr><td>var_pop</td><td>Returns the population variance of a given column</td></tr><tr><td>stddev / stddev_samp</td><td>Returns the standard deviation of a given column</td></tr><tr><td>stddev_pop</td><td>Returns the population standard deviation of a given column</td></tr><tr><td>covar / covar_samp</td><td>Returns the covariance of a given column</td></tr><tr><td>covar_pop</td><td>Returns the population covariance of a given column</td></tr><tr><td>corr</td><td>Returns the correlation coefficient of a given column</td></tr></tbody></table><h2 id=approximate>Approximate</h2><table><thead><tr><th>Function</th><th>Description</th></tr></thead><tbody><tr><td>approx_distinct</td><td>Returns the approximate number (HyperLogLog) of distinct input values</td></tr><tr><td>approx_median</td><td>Returns the approximate median of input values. It is an alias of approx_percentile_cont(x, 0.5).</td></tr><tr><td>approx_percentile_cont</td><td>Returns the approximate percentile (TDigest) of input values, where p is a float64 between 0 and 1 (inclusive). It supports raw data as input and build Tdigest sketches during query time, and is approximately equal to approx_percentile_cont_with_weight(x, 1, p).</td></tr><tr><td>approx_percentile_cont_with_weight</td><td>Returns the approximate percentile (TDigest) of input values with weight, where w is weight column expression and p is a float64 between 0 and 1 (inclusive). It supports raw data as input or pre-aggregated TDigest sketches, then builds or merges Tdigest sketches during query time. TDigest sketches are a list of centroid (x, w), where x stands for mean and w stands for weight.</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-661cb4aa667b1fa4642a1ab0fdc6656c>2.2 - Cluster Deployment</h1><p>In the <a href=https://horaedb.apache.org/docs/getting-started/>Getting Started</a> section, we have introduced the deployment of single HoraeDB instance.</p><p>Besides, as a distributed timeseries database, multiple HoraeDB instances can be deployed as a cluster to serve with high availability and scalability.</p><p>Currently, work about the integration with kubernetes is still in process, so HoraeDB cluster can only be deployed manually. And there are two modes of cluster deployment:</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b594c5402ac7944a3ffa540117ff40ad>2.2.1 - NoMeta</h1><p><strong>Note: This feature is for testing use only, not recommended for production use, related features may change in the future.</strong></p><p>This guide shows how to deploy a HoraeDB cluster without HoraeMeta, but with static, rule-based routing.</p><p>The crucial point here is that HoraeDB server provides configurable routing function on table name so what we need is just a valid config containing routing rules which will be shipped to every HoraeDB instance in the cluster.</p><h2 id=target>Target</h2><p>First, let&rsquo;s assume that our target is to deploy a cluster consisting of two HoraeDB instances on the same machine. And a large cluster of more HoraeDB instances can be deployed according to the two-instance example.</p><h2 id=prepare-config>Prepare Config</h2><h3 id=basic>Basic</h3><p>Suppose the basic config of HoraeDB is:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[server]
</span></span><span style=display:flex><span>bind_addr = <span style=color:#ba2121>&#34;0.0.0.0&#34;</span>
</span></span><span style=display:flex><span>http_port = <span style=color:#666>5440</span>
</span></span><span style=display:flex><span>grpc_port = <span style=color:#666>8831</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[logger]
</span></span><span style=display:flex><span>level = <span style=color:#ba2121>&#34;info&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[tracing]
</span></span><span style=display:flex><span>dir = <span style=color:#ba2121>&#34;/tmp/horaedb&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[analytic.storage.object_store]
</span></span><span style=display:flex><span>type = <span style=color:#ba2121>&#34;Local&#34;</span>
</span></span><span style=display:flex><span>data_dir = <span style=color:#ba2121>&#34;/tmp/horaedb&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[analytic.wal]
</span></span><span style=display:flex><span>type = <span style=color:#ba2121>&#34;RocksDB&#34;</span>
</span></span><span style=display:flex><span>data_dir = <span style=color:#ba2121>&#34;/tmp/horaedb&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>In order to deploy two HoraeDB instances on the same machine, the config should choose different ports to serve and data directories to store data.</p><p>Say the <code>HoraeDB_0</code>&rsquo;s config is:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[server]
</span></span><span style=display:flex><span>bind_addr = <span style=color:#ba2121>&#34;0.0.0.0&#34;</span>
</span></span><span style=display:flex><span>http_port = <span style=color:#666>5440</span>
</span></span><span style=display:flex><span>grpc_port = <span style=color:#666>8831</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[logger]
</span></span><span style=display:flex><span>level = <span style=color:#ba2121>&#34;info&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[tracing]
</span></span><span style=display:flex><span>dir = <span style=color:#ba2121>&#34;/tmp/horaedb_0&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[analytic.storage.object_store]
</span></span><span style=display:flex><span>type = <span style=color:#ba2121>&#34;Local&#34;</span>
</span></span><span style=display:flex><span>data_dir = <span style=color:#ba2121>&#34;/tmp/horaedb_0&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[analytic.wal]
</span></span><span style=display:flex><span>type = <span style=color:#ba2121>&#34;RocksDB&#34;</span>
</span></span><span style=display:flex><span>data_dir = <span style=color:#ba2121>&#34;/tmp/horaedb_0&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>Then the <code>HoraeDB_1</code>&rsquo;s config is:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[server]
</span></span><span style=display:flex><span>bind_addr = <span style=color:#ba2121>&#34;0.0.0.0&#34;</span>
</span></span><span style=display:flex><span>http_port = <span style=color:#666>15440</span>
</span></span><span style=display:flex><span>grpc_port = <span style=color:#666>18831</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[logger]
</span></span><span style=display:flex><span>level = <span style=color:#ba2121>&#34;info&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[tracing]
</span></span><span style=display:flex><span>dir = <span style=color:#ba2121>&#34;/tmp/horaedb_1&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[analytic.storage.object_store]
</span></span><span style=display:flex><span>type = <span style=color:#ba2121>&#34;Local&#34;</span>
</span></span><span style=display:flex><span>data_dir = <span style=color:#ba2121>&#34;/tmp/horaedb_1&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[analytic.wal]
</span></span><span style=display:flex><span>type = <span style=color:#ba2121>&#34;RocksDB&#34;</span>
</span></span><span style=display:flex><span>data_dir = <span style=color:#ba2121>&#34;/tmp/horaedb_1&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=schemashard-declaration>Schema&amp;Shard Declaration</h3><p>Then we should define the common part &ndash; schema&amp;shard declaration and routing rules.</p><p>Here is the config for schema&amp;shard declaration:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[cluster_deployment]
</span></span><span style=display:flex><span>mode = <span style=color:#ba2121>&#34;NoMeta&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[[cluster_deployment.topology.schema_shards]]
</span></span><span style=display:flex><span>schema = <span style=color:#ba2121>&#39;public_0&#39;</span>
</span></span><span style=display:flex><span>[[cluster_deployment.topology.schema_shards.shard_views]]
</span></span><span style=display:flex><span>shard_id = <span style=color:#666>0</span>
</span></span><span style=display:flex><span>[cluster_deployment.topology.schema_shards.shard_views.endpoint]
</span></span><span style=display:flex><span>addr = <span style=color:#ba2121>&#39;127.0.0.1&#39;</span>
</span></span><span style=display:flex><span>port = <span style=color:#666>8831</span>
</span></span><span style=display:flex><span>[[cluster_deployment.topology.schema_shards.shard_views]]
</span></span><span style=display:flex><span>shard_id = <span style=color:#666>1</span>
</span></span><span style=display:flex><span>[cluster_deployment.topology.schema_shards.shard_views.endpoint]
</span></span><span style=display:flex><span>addr = <span style=color:#ba2121>&#39;127.0.0.1&#39;</span>
</span></span><span style=display:flex><span>port = <span style=color:#666>8831</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[[cluster_deployment.topology.schema_shards]]
</span></span><span style=display:flex><span>schema = <span style=color:#ba2121>&#39;public_1&#39;</span>
</span></span><span style=display:flex><span>[[cluster_deployment.topology.schema_shards.shard_views]]
</span></span><span style=display:flex><span>shard_id = <span style=color:#666>0</span>
</span></span><span style=display:flex><span>[cluster_deployment.topology.schema_shards.shard_views.endpoint]
</span></span><span style=display:flex><span>addr = <span style=color:#ba2121>&#39;127.0.0.1&#39;</span>
</span></span><span style=display:flex><span>port = <span style=color:#666>8831</span>
</span></span><span style=display:flex><span>[[cluster_deployment.topology.schema_shards.shard_views]]
</span></span><span style=display:flex><span>shard_id = <span style=color:#666>1</span>
</span></span><span style=display:flex><span>[cluster_deployment.topology.schema_shards.shard_views.endpoint]
</span></span><span style=display:flex><span>addr = <span style=color:#ba2121>&#39;127.0.0.1&#39;</span>
</span></span><span style=display:flex><span>port = <span style=color:#666>18831</span>
</span></span></code></pre></td></tr></table></div></div><p>In the config above, two schemas are declared:</p><ul><li><code>public_0</code> has two shards served by <code>HoraeDB_0</code>.</li><li><code>public_1</code> has two shards served by both <code>HoraeDB_0</code> and <code>HoraeDB_1</code>.</li></ul><h3 id=routing-rules>Routing Rules</h3><p>Provided with schema&amp;shard declaration, routing rules can be defined and here is an example of prefix rule:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[[cluster_deployment.route_rules.prefix_rules]]
</span></span><span style=display:flex><span>schema = <span style=color:#ba2121>&#39;public_0&#39;</span>
</span></span><span style=display:flex><span>prefix = <span style=color:#ba2121>&#39;prod_&#39;</span>
</span></span><span style=display:flex><span>shard = <span style=color:#666>0</span>
</span></span></code></pre></td></tr></table></div></div><p>This rule means that all the table with <code>prod_</code> prefix belonging to <code>public_0</code> should be routed to <code>shard_0</code> of <code>public_0</code>, that is to say, <code>HoraeDB_0</code>. As for the other tables whose names are not prefixed by <code>prod_</code> will be routed by hash to both <code>shard_0</code> and <code>shard_1</code> of <code>public_0</code>.</p><p>Besides prefix rule, we can also define a hash rule:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[[cluster_deployment.route_rules.hash_rules]]
</span></span><span style=display:flex><span>schema = <span style=color:#ba2121>&#39;public_1&#39;</span>
</span></span><span style=display:flex><span>shards = [<span style=color:#666>0</span>, <span style=color:#666>1</span>]
</span></span></code></pre></td></tr></table></div></div><p>This rule tells HoraeDB to route <code>public_1</code>&rsquo;s tables to both <code>shard_0</code> and <code>shard_1</code> of <code>public_1</code>, that is to say, <code>HoraeDB0</code> and <code>HoraeDB_1</code>. And actually this is default routing behavior if no such rule provided for schema <code>public_1</code>.</p><p>For now, we can provide the full example config for <code>HoraeDB_0</code> and <code>HoraeDB_1</code>:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[server]
</span></span><span style=display:flex><span>bind_addr = <span style=color:#ba2121>&#34;0.0.0.0&#34;</span>
</span></span><span style=display:flex><span>http_port = <span style=color:#666>5440</span>
</span></span><span style=display:flex><span>grpc_port = <span style=color:#666>8831</span>
</span></span><span style=display:flex><span>mysql_port = <span style=color:#666>3307</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[logger]
</span></span><span style=display:flex><span>level = <span style=color:#ba2121>&#34;info&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[tracing]
</span></span><span style=display:flex><span>dir = <span style=color:#ba2121>&#34;/tmp/horaedb_0&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[analytic.storage.object_store]
</span></span><span style=display:flex><span>type = <span style=color:#ba2121>&#34;Local&#34;</span>
</span></span><span style=display:flex><span>data_dir = <span style=color:#ba2121>&#34;/tmp/horaedb_0&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[analytic.wal]
</span></span><span style=display:flex><span>type = <span style=color:#ba2121>&#34;RocksDB&#34;</span>
</span></span><span style=display:flex><span>data_dir = <span style=color:#ba2121>&#34;/tmp/horaedb_0&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[cluster_deployment]
</span></span><span style=display:flex><span>mode = <span style=color:#ba2121>&#34;NoMeta&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[[cluster_deployment.topology.schema_shards]]
</span></span><span style=display:flex><span>schema = <span style=color:#ba2121>&#39;public_0&#39;</span>
</span></span><span style=display:flex><span>[[cluster_deployment.topology.schema_shards.shard_views]]
</span></span><span style=display:flex><span>shard_id = <span style=color:#666>0</span>
</span></span><span style=display:flex><span>[cluster_deployment.topology.schema_shards.shard_views.endpoint]
</span></span><span style=display:flex><span>addr = <span style=color:#ba2121>&#39;127.0.0.1&#39;</span>
</span></span><span style=display:flex><span>port = <span style=color:#666>8831</span>
</span></span><span style=display:flex><span>[[cluster_deployment.topology.schema_shards.shard_views]]
</span></span><span style=display:flex><span>shard_id = <span style=color:#666>1</span>
</span></span><span style=display:flex><span>[cluster_deployment.topology.schema_shards.shard_views.endpoint]
</span></span><span style=display:flex><span>addr = <span style=color:#ba2121>&#39;127.0.0.1&#39;</span>
</span></span><span style=display:flex><span>port = <span style=color:#666>8831</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[[cluster_deployment.topology.schema_shards]]
</span></span><span style=display:flex><span>schema = <span style=color:#ba2121>&#39;public_1&#39;</span>
</span></span><span style=display:flex><span>[[cluster_deployment.topology.schema_shards.shard_views]]
</span></span><span style=display:flex><span>shard_id = <span style=color:#666>0</span>
</span></span><span style=display:flex><span>[cluster_deployment.topology.schema_shards.shard_views.endpoint]
</span></span><span style=display:flex><span>addr = <span style=color:#ba2121>&#39;127.0.0.1&#39;</span>
</span></span><span style=display:flex><span>port = <span style=color:#666>8831</span>
</span></span><span style=display:flex><span>[[cluster_deployment.topology.schema_shards.shard_views]]
</span></span><span style=display:flex><span>shard_id = <span style=color:#666>1</span>
</span></span><span style=display:flex><span>[cluster_deployment.topology.schema_shards.shard_views.endpoint]
</span></span><span style=display:flex><span>addr = <span style=color:#ba2121>&#39;127.0.0.1&#39;</span>
</span></span><span style=display:flex><span>port = <span style=color:#666>18831</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[server]
</span></span><span style=display:flex><span>bind_addr = <span style=color:#ba2121>&#34;0.0.0.0&#34;</span>
</span></span><span style=display:flex><span>http_port = <span style=color:#666>15440</span>
</span></span><span style=display:flex><span>grpc_port = <span style=color:#666>18831</span>
</span></span><span style=display:flex><span>mysql_port = <span style=color:#666>13307</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[logger]
</span></span><span style=display:flex><span>level = <span style=color:#ba2121>&#34;info&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[tracing]
</span></span><span style=display:flex><span>dir = <span style=color:#ba2121>&#34;/tmp/horaedb_1&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[analytic.storage.object_store]
</span></span><span style=display:flex><span>type = <span style=color:#ba2121>&#34;Local&#34;</span>
</span></span><span style=display:flex><span>data_dir = <span style=color:#ba2121>&#34;/tmp/horaedb_1&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[analytic.wal]
</span></span><span style=display:flex><span>type = <span style=color:#ba2121>&#34;RocksDB&#34;</span>
</span></span><span style=display:flex><span>data_dir = <span style=color:#ba2121>&#34;/tmp/horaedb_1&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[cluster_deployment]
</span></span><span style=display:flex><span>mode = <span style=color:#ba2121>&#34;NoMeta&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[[cluster_deployment.topology.schema_shards]]
</span></span><span style=display:flex><span>schema = <span style=color:#ba2121>&#39;public_0&#39;</span>
</span></span><span style=display:flex><span>[[cluster_deployment.topology.schema_shards.shard_views]]
</span></span><span style=display:flex><span>shard_id = <span style=color:#666>0</span>
</span></span><span style=display:flex><span>[cluster_deployment.topology.schema_shards.shard_views.endpoint]
</span></span><span style=display:flex><span>addr = <span style=color:#ba2121>&#39;127.0.0.1&#39;</span>
</span></span><span style=display:flex><span>port = <span style=color:#666>8831</span>
</span></span><span style=display:flex><span>[[cluster_deployment.topology.schema_shards.shard_views]]
</span></span><span style=display:flex><span>shard_id = <span style=color:#666>1</span>
</span></span><span style=display:flex><span>[cluster_deployment.topology.schema_shards.shard_views.endpoint]
</span></span><span style=display:flex><span>addr = <span style=color:#ba2121>&#39;127.0.0.1&#39;</span>
</span></span><span style=display:flex><span>port = <span style=color:#666>8831</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[[cluster_deployment.topology.schema_shards]]
</span></span><span style=display:flex><span>schema = <span style=color:#ba2121>&#39;public_1&#39;</span>
</span></span><span style=display:flex><span>[[cluster_deployment.topology.schema_shards.shard_views]]
</span></span><span style=display:flex><span>shard_id = <span style=color:#666>0</span>
</span></span><span style=display:flex><span>[cluster_deployment.topology.schema_shards.shard_views.endpoint]
</span></span><span style=display:flex><span>addr = <span style=color:#ba2121>&#39;127.0.0.1&#39;</span>
</span></span><span style=display:flex><span>port = <span style=color:#666>8831</span>
</span></span><span style=display:flex><span>[[cluster_deployment.topology.schema_shards.shard_views]]
</span></span><span style=display:flex><span>shard_id = <span style=color:#666>1</span>
</span></span><span style=display:flex><span>[cluster_deployment.topology.schema_shards.shard_views.endpoint]
</span></span><span style=display:flex><span>addr = <span style=color:#ba2121>&#39;127.0.0.1&#39;</span>
</span></span><span style=display:flex><span>port = <span style=color:#666>18831</span>
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s name the two different config files as <code>config_0.toml</code> and <code>config_1.toml</code> but you should know in the real environment the different HoraeDB instances can be deployed across different machines, that is to say, there is no need to choose different ports and data directories for different HoraeDB instances so that all the HoraeDB instances can share one exactly <strong>same</strong> config file.</p><h2 id=start-horaedbs>Start HoraeDBs</h2><p>After the configs are prepared, what we should to do is to start HoraeDB container with the specific config.</p><p>Just run the commands below:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo docker run -d -t --name horaedb_0 -p 5440:5440 -p 8831:8831 -v <span style=color:green;font-weight:700>$(</span><span style=color:green>pwd</span><span style=color:green;font-weight:700>)</span>/config_0.toml:/etc/horaedb/horaedb.toml horaedb/horaedb-server
</span></span><span style=display:flex><span>sudo docker run -d -t --name horaedb_1 -p 15440:15440 -p 18831:18831 -v <span style=color:green;font-weight:700>$(</span><span style=color:green>pwd</span><span style=color:green;font-weight:700>)</span>/config_1.toml:/etc/horaedb/horaedb.toml horaedb/horaedb-server
</span></span></code></pre></td></tr></table></div></div><p>After the two containers are created and starting running, read and write requests can be served by the two-instances HoraeDB cluster.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f8177b6910dfd52c70228b40053918c4>2.2.2 - WithMeta</h1><p>This guide shows how to deploy a HoraeDB cluster with HoraeMeta. And with the HoraeMeta, the whole HoraeDB cluster will feature: high availability, load balancing and horizontal scalability if the underlying storage used by HoraeDB is separated service.</p><h2 id=deploy-horaemeta>Deploy HoraeMeta</h2><h3 id=introduce>Introduce</h3><p>HoraeMeta is one of the core services of HoraeDB distributed mode, it is used to manage and schedule the HoraeDB cluster. By the way, the high availability of HoraeMeta is ensured by embedding <a href=https://github.com/etcd-io/etcd>ETCD</a>. Also, the ETCD service is provided for HoraeDB servers to manage the distributed shard locks.</p><h3 id=build>Build</h3><ul><li>Golang version >= 1.19.</li><li>run <code>make build</code> in root path of <a href=https://github.com/apache/horaedb/tree/main/horaemeta>HoraeMeta</a>.</li></ul><h3 id=deploy>Deploy</h3><h4 id=config>Config</h4><p>At present, HoraeMeta supports specifying service startup configuration in two ways: configuration file and environment variable. We provide an example of configuration file startup. For details, please refer to <a href=https://github.com/apache/horaedb/tree/main/horaemeta/config>config</a>. The configuration priority of environment variables is higher than that of configuration files. When they exist at the same time, the environment variables shall prevail.</p><h4 id=dynamic-or-static>Dynamic or Static</h4><p>Even with the HoraeMeta, the HoraeDB cluster can be deployed with a static or a dynamic topology. With a static topology, the table distribution is static after the cluster is initialized while with the dynamic topology, the tables can migrate between different HoraeDB nodes to achieve load balance or failover. However, the dynamic topology can be enabled only if the storage used by the HoraeDB node is remote, otherwise the data may be corrupted when tables are transferred to a different HoraeDB node when the data of HoraeDB is persisted locally.</p><p>Currently, the dynamic scheduling over the cluster topology is disabled by default in HoraeMeta, and in this guide, we won&rsquo;t enable it because local storage is adopted here. If you want to enable the dynamic scheduling, the <code>TOPOLOGY_TYPE</code> can be set as <code>dynamic</code> (<code>static</code> by default), and after that, load balancing and failover will work. However, don&rsquo;t enable it if what the underlying storage is local disk.</p><p>With the static topology, the params <code>DEFAULT_CLUSTER_NODE_COUNT</code>, which denotes the number of the HoraeDB nodes in the deployed cluster and should be set to the real number of machines for HoraeDB server, matters a lot because after cluster initialization the HoraeDB nodes can&rsquo;t be changed any more.</p><h4 id=start-horaemeta-instances>Start HoraeMeta Instances</h4><p>HoraeMeta is based on etcd to achieve high availability. In product environment, we usually deploy multiple nodes, but in local environment and testing, we can directly deploy a single node to simplify the entire deployment process.</p><ul><li>Standalone</li></ul><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -d --name horaemeta-server <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  -p 2379:2379 <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  ghcr.io/apache/horaemeta-server:nightly-20231225-ab067bf0
</span></span></code></pre></td></tr></table></div></div><ul><li>Cluster</li></ul><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget https://horaedb.apache.org/config-horaemeta-cluster0.toml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker run -d --network<span style=color:#666>=</span>host --name horaemeta-server0 <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  -v <span style=color:green;font-weight:700>$(</span><span style=color:green>pwd</span><span style=color:green;font-weight:700>)</span>/config-horaemeta-cluster0.toml:/etc/horaemeta/horaemeta.toml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  ghcr.io/apache/horaemeta-server:nightly-20231225-ab067bf0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>wget https://horaedb.apache.org/config-horaemeta-cluster1.toml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker run -d --network<span style=color:#666>=</span>host --name horaemeta-server1 <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  -v <span style=color:green;font-weight:700>$(</span><span style=color:green>pwd</span><span style=color:green;font-weight:700>)</span>/config-horaemeta-cluster1.toml:/etc/horaemeta/horaemeta.toml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  ghcr.io/apache/horaemeta-server:nightly-20231225-ab067bf0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>wget https://horaedb.apache.org/config-horaemeta-cluster2.toml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker run -d --network<span style=color:#666>=</span>host --name horaemeta-server2 <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  -v <span style=color:green;font-weight:700>$(</span><span style=color:green>pwd</span><span style=color:green;font-weight:700>)</span>/config-horaemeta-cluster2.toml:/etc/horaemeta/horaemeta.toml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  ghcr.io/apache/horaemeta-server:nightly-20231225-ab067bf0
</span></span></code></pre></td></tr></table></div></div><p>And if the storage used by the HoraeDB is remote and you want to enable the dynamic schedule features of the HoraeDB cluster, the <code>-e TOPOLOGY_TYPE=dynamic</code> can be added to the docker run command.</p><h2 id=deploy-horaedb>Deploy HoraeDB</h2><p>In the <code>NoMeta</code> mode, HoraeDB only requires the local disk as the underlying storage because the topology of the HoraeDB cluster is static. However, with HoraeMeta, the cluster topology can be dynamic, that is to say, HoraeDB can be configured to use a non-local storage service for the features of a distributed system: HA, load balancing, scalability and so on. And HoraeDB can be still configured to use a local storage with HoraeMeta, which certainly leads to a static cluster topology.</p><p>The relevant storage configurations include two parts:</p><ul><li>Object Storage</li><li>WAL Storage</li></ul><p>Note: If you are deploying HoraeDB over multiple nodes in a production environment, please set the environment variable for the server address as follows:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:green>export</span> <span style=color:#19177c>HORAEDB_SERVER_ADDR</span><span style=color:#666>=</span><span style=color:#ba2121>&#34;{server_address}:8831&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>This address is used for communication between HoraeMeta and HoraeDB, please ensure it is valid.</p><h3 id=object-storage>Object Storage</h3><h4 id=local-storage>Local Storage</h4><p>Similarly, we can configure HoraeDB to use a local disk as the underlying storage:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[analytic.storage.object_store]
</span></span><span style=display:flex><span>type = <span style=color:#ba2121>&#34;Local&#34;</span>
</span></span><span style=display:flex><span>data_dir = <span style=color:#ba2121>&#34;/home/admin/data/horaedb&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=oss>OSS</h4><p>Aliyun OSS can be also used as the underlying storage for HoraeDB, with which the data is replicated for disaster recovery. Here is a example config, and you have to replace the templates with the real OSS parameters:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[analytic.storage.object_store]
</span></span><span style=display:flex><span>type = <span style=color:#ba2121>&#34;Aliyun&#34;</span>
</span></span><span style=display:flex><span>key_id = <span style=color:#ba2121>&#34;{key_id}&#34;</span>
</span></span><span style=display:flex><span>key_secret = <span style=color:#ba2121>&#34;{key_secret}&#34;</span>
</span></span><span style=display:flex><span>endpoint = <span style=color:#ba2121>&#34;{endpoint}&#34;</span>
</span></span><span style=display:flex><span>bucket = <span style=color:#ba2121>&#34;{bucket}&#34;</span>
</span></span><span style=display:flex><span>prefix = <span style=color:#ba2121>&#34;{data_dir}&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=s3>S3</h4><p>Amazon S3 can be also used as the underlying storage for HoraeDB. Here is a example config, and you have to replace the templates with the real S3 parameters:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[analytic.storage.object_store]
</span></span><span style=display:flex><span>type = <span style=color:#ba2121>&#34;S3&#34;</span>
</span></span><span style=display:flex><span>region = <span style=color:#ba2121>&#34;{region}&#34;</span>
</span></span><span style=display:flex><span>key_id = <span style=color:#ba2121>&#34;{key_id}&#34;</span>
</span></span><span style=display:flex><span>key_secret = <span style=color:#ba2121>&#34;{key_secret}&#34;</span>
</span></span><span style=display:flex><span>endpoint = <span style=color:#ba2121>&#34;{endpoint}&#34;</span>
</span></span><span style=display:flex><span>bucket = <span style=color:#ba2121>&#34;{bucket}&#34;</span>
</span></span><span style=display:flex><span>prefix = <span style=color:#ba2121>&#34;{prefix}&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=wal-storage>WAL Storage</h3><h4 id=rocksdb>RocksDB</h4><p>The WAL based on RocksDB is also a kind of local storage for HoraeDB, which is easy for a quick start:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[analytic.wal]
</span></span><span style=display:flex><span>type = <span style=color:#ba2121>&#34;RocksDB&#34;</span>
</span></span><span style=display:flex><span>data_dir = <span style=color:#ba2121>&#34;/home/admin/data/horaedb&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=oceanbase>OceanBase</h4><p>If you have deployed a OceanBase cluster, HoraeDB can use it as the WAL storage for data disaster recovery. Here is a example config for such WAL, and you have to replace the templates with real OceanBase parameters:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[analytic.wal]
</span></span><span style=display:flex><span>type = <span style=color:#ba2121>&#34;Obkv&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[analytic.wal.data_namespace]
</span></span><span style=display:flex><span>ttl = <span style=color:#ba2121>&#34;365d&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[analytic.wal.obkv]
</span></span><span style=display:flex><span>full_user_name = <span style=color:#ba2121>&#34;{full_user_name}&#34;</span>
</span></span><span style=display:flex><span>param_url = <span style=color:#ba2121>&#34;{param_url}&#34;</span>
</span></span><span style=display:flex><span>password = <span style=color:#ba2121>&#34;{password}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[analytic.wal.obkv.client]
</span></span><span style=display:flex><span>sys_user_name = <span style=color:#ba2121>&#34;{sys_user_name}&#34;</span>
</span></span><span style=display:flex><span>sys_password = <span style=color:#ba2121>&#34;{sys_password}&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=kafka>Kafka</h4><p>If you have deployed a Kafka cluster, HoraeDB can also use it as the WAL storage. Here is example config for it, and you have to replace the templates with real parameters of the Kafka cluster:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[analytic.wal]
</span></span><span style=display:flex><span>type = <span style=color:#ba2121>&#34;Kafka&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[analytic.wal.kafka.client]
</span></span><span style=display:flex><span>boost_brokers = [ <span style=color:#ba2121>&#34;{boost_broker1}&#34;</span>, <span style=color:#ba2121>&#34;{boost_broker2}&#34;</span> ]
</span></span></code></pre></td></tr></table></div></div><h3 id=meta-client-config>Meta Client Config</h3><p>Besides the storage configurations, HoraeDB must be configured to start in <code>WithMeta</code> mode and connect to the deployed HoraeMeta:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[cluster_deployment]
</span></span><span style=display:flex><span>mode = <span style=color:#ba2121>&#34;WithMeta&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[cluster_deployment.meta_client]
</span></span><span style=display:flex><span>cluster_name = <span style=color:#ba2121>&#39;defaultCluster&#39;</span>
</span></span><span style=display:flex><span>meta_addr = <span style=color:#ba2121>&#39;http://{HoraeMetaAddr}:2379&#39;</span>
</span></span><span style=display:flex><span>lease = <span style=color:#ba2121>&#34;10s&#34;</span>
</span></span><span style=display:flex><span>timeout = <span style=color:#ba2121>&#34;5s&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[cluster_deployment.etcd_client]
</span></span><span style=display:flex><span>server_addrs = [<span style=color:#ba2121>&#39;http://{HoraeMetaAddr}:2379&#39;</span>]
</span></span></code></pre></td></tr></table></div></div><h3 id=compaction-offload>Compaction Offload</h3><p>Compaction offload is also supported. To enable compaction offload, the corresponding compaction mode with node picker and endpoint should be configured.</p><ul><li><code>node_picker</code>: There are two types of node picker &ndash; <code>Local</code> and <code>Remote</code>(WIP).<ul><li>When the <code>Local</code> is setted, the local compaction task would be offloaded to the specific remote compaction server, which decided by <code>endpoint</code>.</li></ul></li><li><code>endpoint</code>: The endpoint, in the form <code>addr:port</code>, indicating the <em>grpc port</em> of the remote compaction server.</li></ul><p>Here is an example for it:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[analytic.compaction_mode]
</span></span><span style=display:flex><span>compaction_mode = <span style=color:#ba2121>&#34;Offload&#34;</span>
</span></span><span style=display:flex><span>node_picker = <span style=color:#ba2121>&#34;Local&#34;</span>
</span></span><span style=display:flex><span>endpoint = <span style=color:#ba2121>&#34;{RemoteCompactionServerAddr}:{RemoteCompactionServerGrpcPort}&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>A Compaction Server, responsible for executing the compaction task, is also needed. Currently <code>horaedb-server</code> will act as this role, in the future we can move it to an independent service.</p><h3 id=complete-config-of-horaedb>Complete Config of HoraeDB</h3><p>With all the parts of the configurations mentioned above, a runnable complete config for HoraeDB can be made. In order to make the HoraeDB cluster runnable, we can decide to adopt RocksDB-based WAL and local-disk-based Object Storage without compaction offload:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[server]
</span></span><span style=display:flex><span>bind_addr = <span style=color:#ba2121>&#34;0.0.0.0&#34;</span>
</span></span><span style=display:flex><span>http_port = <span style=color:#666>5440</span>
</span></span><span style=display:flex><span>grpc_port = <span style=color:#666>8831</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[logger]
</span></span><span style=display:flex><span>level = <span style=color:#ba2121>&#34;info&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[runtime]
</span></span><span style=display:flex><span>read_thread_num = <span style=color:#666>20</span>
</span></span><span style=display:flex><span>write_thread_num = <span style=color:#666>16</span>
</span></span><span style=display:flex><span>background_thread_num = <span style=color:#666>12</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[cluster_deployment]
</span></span><span style=display:flex><span>mode = <span style=color:#ba2121>&#34;WithMeta&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[cluster_deployment.meta_client]
</span></span><span style=display:flex><span>cluster_name = <span style=color:#ba2121>&#39;defaultCluster&#39;</span>
</span></span><span style=display:flex><span>meta_addr = <span style=color:#ba2121>&#39;http://127.0.0.1:2379&#39;</span>
</span></span><span style=display:flex><span>lease = <span style=color:#ba2121>&#34;10s&#34;</span>
</span></span><span style=display:flex><span>timeout = <span style=color:#ba2121>&#34;5s&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[cluster_deployment.etcd_client]
</span></span><span style=display:flex><span>server_addrs = [<span style=color:#ba2121>&#39;127.0.0.1:2379&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[analytic]
</span></span><span style=display:flex><span>write_group_worker_num = <span style=color:#666>16</span>
</span></span><span style=display:flex><span>replay_batch_size = <span style=color:#666>100</span>
</span></span><span style=display:flex><span>max_replay_tables_per_batch = <span style=color:#666>128</span>
</span></span><span style=display:flex><span>write_group_command_channel_cap = <span style=color:#666>1024</span>
</span></span><span style=display:flex><span>sst_background_read_parallelism = <span style=color:#666>8</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[analytic.manifest]
</span></span><span style=display:flex><span>scan_batch_size = <span style=color:#666>100</span>
</span></span><span style=display:flex><span>snapshot_every_n_updates = <span style=color:#666>10000</span>
</span></span><span style=display:flex><span>scan_timeout = <span style=color:#ba2121>&#34;5s&#34;</span>
</span></span><span style=display:flex><span>store_timeout = <span style=color:#ba2121>&#34;5s&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[analytic.wal]
</span></span><span style=display:flex><span>type = <span style=color:#ba2121>&#34;RocksDB&#34;</span>
</span></span><span style=display:flex><span>data_dir = <span style=color:#ba2121>&#34;/home/admin/data/horaedb&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[analytic.storage]
</span></span><span style=display:flex><span>mem_cache_capacity = <span style=color:#ba2121>&#34;20GB&#34;</span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic># 1&lt;&lt;8=256</span>
</span></span><span style=display:flex><span>mem_cache_partition_bits = <span style=color:#666>8</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[analytic.storage.object_store]
</span></span><span style=display:flex><span>type = <span style=color:#ba2121>&#34;Local&#34;</span>
</span></span><span style=display:flex><span>data_dir = <span style=color:#ba2121>&#34;/home/admin/data/horaedb/&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[analytic.table_opts]
</span></span><span style=display:flex><span>arena_block_size = <span style=color:#666>2097152</span>
</span></span><span style=display:flex><span>write_buffer_size = <span style=color:#666>33554432</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[analytic.compaction]
</span></span><span style=display:flex><span>schedule_channel_len = <span style=color:#666>16</span>
</span></span><span style=display:flex><span>schedule_interval = <span style=color:#ba2121>&#34;30m&#34;</span>
</span></span><span style=display:flex><span>max_ongoing_tasks = <span style=color:#666>8</span>
</span></span><span style=display:flex><span>memory_limit = <span style=color:#ba2121>&#34;4G&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s name this config file as <code>config.toml</code>. And the example configs, in which the templates must be replaced with real parameters before use, for remote storages are also provided:</p><ul><li><a href=../../resources/config_local_oss.toml>RocksDB WAL + OSS</a></li><li><a href=../../resources/config_obkv_oss.toml>OceanBase WAL + OSS</a></li><li><a href=../../resources/config_kafka_oss.toml>Kafka WAL + OSS</a></li></ul><h2 id=run-horaedb-cluster-with-horaemeta>Run HoraeDB cluster with HoraeMeta</h2><p>Firstly, let&rsquo;s start the HoraeMeta:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -d --name horaemeta-server <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  -p 2379:2379 <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  ghcr.io/apache/horaemeta-server:nightly-20231225-ab067bf0
</span></span></code></pre></td></tr></table></div></div><p>With the started HoraeMeta cluster, let&rsquo;s start the HoraeDB instance:
TODO: complete it later</p></div><div class=td-content style=page-break-before:always><h1 id=pg-09534b543d63f00c41f30de2514d312b>2.3 - SDK</h1></div><div class=td-content><h1 id=pg-c736df40c4147174f6f2d1eaeb49bdca>2.3.1 - Go</h1><h2 id=installation>Installation</h2><pre tabindex=0><code>go get github.com/apache/incubator-horaedb-client-go
</code></pre><p>You can get latest version <a href=https://github.com/apache/incubator-horaedb-client-go/tags>here</a>.</p><h2 id=how-to-use>How To Use</h2><h3 id=init-horaedb-client>Init HoraeDB Client</h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	client, err <span style=color:#666>:=</span> horaedb.<span style=color:#00f>NewClient</span>(endpoint, horaedb.Direct,
</span></span><span style=display:flex><span>		horaedb.<span style=color:#00f>WithDefaultDatabase</span>(<span style=color:#ba2121>&#34;public&#34;</span>),
</span></span><span style=display:flex><span>	)
</span></span></code></pre></td></tr></table></div></div><table><thead><tr><th>option name</th><th>description</th></tr></thead><tbody><tr><td>defaultDatabase</td><td>using database, database can be overwritten by ReqContext in single <code>Write</code> or <code>SQLRequest</code></td></tr><tr><td>RPCMaxRecvMsgSize</td><td>configration for grpc <code>MaxCallRecvMsgSize</code>, default 1024 _ 1024 _ 1024</td></tr><tr><td>RouteMaxCacheSize</td><td>If the maximum number of router cache size, router client whill evict oldest if exceeded, default is 10000</td></tr></tbody></table><p>Notice:</p><ul><li>HoraeDB currently only supports the default database <code>public</code> now, multiple databases will be supported in the future</li></ul><h3 id=manage-table>Manage Table</h3><p>HoraeDB uses SQL to manage tables, such as creating tables, deleting tables, or adding columns, etc., which is not much different from when you use SQL to manage other databases.</p><p>For ease of use, when using gRPC&rsquo;s write interface for writing, if a table does not exist, HoraeDB will automatically create a table based on the first write.</p><p>Of course, you can also use <code>create table</code> statement to manage the table more finely (such as adding indexes).</p><p><strong>Example for creating table</strong></p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	createTableSQL <span style=color:#666>:=</span> <span style=color:#ba2121>`
</span></span></span><span style=display:flex><span><span style=color:#ba2121>		CREATE TABLE IF NOT EXISTS demo (
</span></span></span><span style=display:flex><span><span style=color:#ba2121>			name string TAG,
</span></span></span><span style=display:flex><span><span style=color:#ba2121>			value double,
</span></span></span><span style=display:flex><span><span style=color:#ba2121>			t timestamp NOT NULL,
</span></span></span><span style=display:flex><span><span style=color:#ba2121>			TIMESTAMP KEY(t)
</span></span></span><span style=display:flex><span><span style=color:#ba2121>		) ENGINE=Analytic with (enable_ttl=false)`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	req <span style=color:#666>:=</span> horaedb.SQLQueryRequest{
</span></span><span style=display:flex><span>		Tables: []<span style=color:#b00040>string</span>{<span style=color:#ba2121>&#34;demo&#34;</span>},
</span></span><span style=display:flex><span>		SQL:    createTableSQL,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	resp, err <span style=color:#666>:=</span> client.<span style=color:#00f>SQLQuery</span>(context.<span style=color:#00f>Background</span>(), req)
</span></span></code></pre></td></tr></table></div></div><p><strong>Example for droping table</strong></p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	dropTableSQL <span style=color:#666>:=</span> <span style=color:#ba2121>`DROP TABLE demo`</span>
</span></span><span style=display:flex><span>	req <span style=color:#666>:=</span> horaedb.SQLQueryRequest{
</span></span><span style=display:flex><span>		Tables: []<span style=color:#b00040>string</span>{<span style=color:#ba2121>&#34;demo&#34;</span>},
</span></span><span style=display:flex><span>		SQL:    dropTableSQL,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	resp, err <span style=color:#666>:=</span> client.<span style=color:#00f>SQLQuery</span>(context.<span style=color:#00f>Background</span>(), req)
</span></span></code></pre></td></tr></table></div></div><h3 id=how-to-build-write-data>How To Build Write Data</h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	points <span style=color:#666>:=</span> <span style=color:green>make</span>([]horaedb.Point, <span style=color:#666>0</span>, <span style=color:#666>2</span>)
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>for</span> i <span style=color:#666>:=</span> <span style=color:#666>0</span>; i &lt; <span style=color:#666>2</span>; i<span style=color:#666>++</span> {
</span></span><span style=display:flex><span>		point, err <span style=color:#666>:=</span> horaedb.<span style=color:#00f>NewPointBuilder</span>(<span style=color:#ba2121>&#34;demo&#34;</span>).
</span></span><span style=display:flex><span>			<span style=color:#00f>SetTimestamp</span>(now).
</span></span><span style=display:flex><span>			<span style=color:#00f>AddTag</span>(<span style=color:#ba2121>&#34;name&#34;</span>, horaedb.<span style=color:#00f>NewStringValue</span>(<span style=color:#ba2121>&#34;test_tag1&#34;</span>)).
</span></span><span style=display:flex><span>			<span style=color:#00f>AddField</span>(<span style=color:#ba2121>&#34;value&#34;</span>, horaedb.<span style=color:#00f>NewDoubleValue</span>(<span style=color:#666>0.4242</span>)).
</span></span><span style=display:flex><span>			<span style=color:#00f>Build</span>()
</span></span><span style=display:flex><span>		<span style=color:green;font-weight:700>if</span> err <span style=color:#666>!=</span> <span style=color:green;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:green>panic</span>(err)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		points = <span style=color:green>append</span>(points, point)
</span></span><span style=display:flex><span>	}
</span></span></code></pre></td></tr></table></div></div><h3 id=write-example>Write Example</h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	req <span style=color:#666>:=</span> horaedb.WriteRequest{
</span></span><span style=display:flex><span>		Points: points,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	resp, err <span style=color:#666>:=</span> client.<span style=color:#00f>Write</span>(context.<span style=color:#00f>Background</span>(), req)
</span></span></code></pre></td></tr></table></div></div><h3 id=query-example>Query Example</h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	querySQL <span style=color:#666>:=</span> <span style=color:#ba2121>`SELECT * FROM demo`</span>
</span></span><span style=display:flex><span>	req <span style=color:#666>:=</span> horaedb.SQLQueryRequest{
</span></span><span style=display:flex><span>		Tables: []<span style=color:#b00040>string</span>{<span style=color:#ba2121>&#34;demo&#34;</span>},
</span></span><span style=display:flex><span>		SQL:    querySQL,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	resp, err <span style=color:#666>:=</span> client.<span style=color:#00f>SQLQuery</span>(context.<span style=color:#00f>Background</span>(), req)
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>if</span> err <span style=color:#666>!=</span> <span style=color:green;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:green>panic</span>(err)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	fmt.<span style=color:#00f>Printf</span>(<span style=color:#ba2121>&#34;query table success, rows:%+v\n&#34;</span>, resp.Rows)
</span></span></code></pre></td></tr></table></div></div><h2 id=example>Example</h2><p>You can find the complete example <a href=https://github.com/apache/incubator-horaedb-client-go/blob/main/examples/read_write.go>here</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-66074b15694ea31d990c645c25042bca>2.3.2 - Java</h1><h2 id=introduction>Introduction</h2><p>HoraeDB Client is a high-performance Java client for HoraeDB.</p><h2 id=requirements>Requirements</h2><ul><li>Java 8 or later is required for compilation</li></ul><h2 id=dependency>Dependency</h2><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:green;font-weight:700>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&lt;groupId&gt;</span>io.ceresdb<span style=color:green;font-weight:700>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&lt;artifactId&gt;</span>ceresdb-all<span style=color:green;font-weight:700>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&lt;version&gt;</span>${CERESDB.VERSION}<span style=color:green;font-weight:700>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>You can get latest version <a href=https://github.com/apache/incubator-horaedb-client-java/blob/main/docs/CHANGELOG.md>here</a>.</p><h2 id=init-horaedb-client>Init HoraeDB Client</h2><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>final</span><span style=color:#bbb> </span>CeresDBOptions<span style=color:#bbb> </span>opts<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>CeresDBOptions.<span style=color:#7d9029>newBuilder</span>(<span style=color:#ba2121>&#34;127.0.0.1&#34;</span>,<span style=color:#bbb> </span>8831,<span style=color:#bbb> </span>DIRECT)<span style=color:#bbb> </span><span style=color:#408080;font-style:italic>// CeresDB default grpc port 8831，use DIRECT RouteMode</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>.<span style=color:#7d9029>database</span>(<span style=color:#ba2121>&#34;public&#34;</span>)<span style=color:#bbb> </span><span style=color:#408080;font-style:italic>// use database for client, can be overridden by the RequestContext in request</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#408080;font-style:italic>// maximum retry times when write fails</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#408080;font-style:italic>// (only some error codes will be retried, such as the routing table failure)</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>.<span style=color:#7d9029>writeMaxRetries</span>(1)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#408080;font-style:italic>// maximum retry times when read fails</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#408080;font-style:italic>// (only some error codes will be retried, such as the routing table failure)</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>.<span style=color:#7d9029>readMaxRetries</span>(1).<span style=color:#7d9029>build</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>final</span><span style=color:#bbb> </span>CeresDBClient<span style=color:#bbb> </span>client<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>CeresDBClient();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>if</span><span style=color:#bbb> </span>(<span style=color:#666>!</span>client.<span style=color:#7d9029>init</span>(opts))<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>throw</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>IllegalStateException(<span style=color:#ba2121>&#34;Fail to start CeresDBClient&#34;</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>The initialization requires at least three parameters:</p><ul><li><code>Endpoint</code>: 127.0.0.1</li><li><code>Port</code>: 8831</li><li><code>RouteMode</code>: DIRECT/PROXY</li></ul><p>Here is the explanation of <code>RouteMode</code>. There are two kinds of <code>RouteMode</code>,The <code>Direct</code> mode should be adopted to avoid forwarding overhead if all the servers are accessible to the client.
However, the <code>Proxy</code> mode is the only choice if the access to the servers from the client must go through a gateway.
For more configuration options, see <a href=https://github.com/apache/incubator-horaedb-client-java/tree/main/docs/configuration.md>configuration</a></p><p>Notice: HoraeDB currently only supports the default database <code>public</code> now, multiple databases will be supported in the future;</p><h2 id=create-table-example>Create Table Example</h2><p>For ease of use, when using gRPC&rsquo;s write interface for writing, if a table does not exist, HoraeDB will automatically create a table based on the first write.</p><p>Of course, you can also use <code>create table</code> statement to manage the table more finely (such as adding indexes).</p><p>The following table creation statement（using the SQL API included in SDK ）shows all field types supported by HoraeDB：</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#408080;font-style:italic>// Create table manually, creating table schema ahead of data ingestion is not required</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>String<span style=color:#bbb> </span>createTableSql<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#ba2121>&#34;CREATE TABLE IF NOT EXISTS machine_table(&#34;</span><span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#ba2121>&#34;ts TIMESTAMP NOT NULL,&#34;</span><span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#ba2121>&#34;city STRING TAG NOT NULL,&#34;</span><span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#ba2121>&#34;ip STRING TAG NOT NULL,&#34;</span><span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#ba2121>&#34;cpu DOUBLE NULL,&#34;</span><span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#ba2121>&#34;mem DOUBLE NULL,&#34;</span><span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#ba2121>&#34;TIMESTAMP KEY(ts)&#34;</span><span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:#408080;font-style:italic>// timestamp column must be specified</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#ba2121>&#34;) ENGINE=Analytic&#34;</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Result<span style=color:#666>&lt;</span>SqlQueryOk,<span style=color:#bbb> </span>Err<span style=color:#666>&gt;</span><span style=color:#bbb> </span>createResult<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>client.<span style=color:#7d9029>sqlQuery</span>(<span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>SqlQueryRequest(createTableSql)).<span style=color:#7d9029>get</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>if</span><span style=color:#bbb> </span>(<span style=color:#666>!</span>createResult.<span style=color:#7d9029>isOk</span>())<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>throw</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>IllegalStateException(<span style=color:#ba2121>&#34;Fail to create table&#34;</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=drop-table-example>Drop Table Example</h2><p>Here is an example of dropping table：</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>String<span style=color:#bbb> </span>dropTableSql<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#ba2121>&#34;DROP TABLE machine_table&#34;</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Result<span style=color:#666>&lt;</span>SqlQueryOk,<span style=color:#bbb> </span>Err<span style=color:#666>&gt;</span><span style=color:#bbb> </span>dropResult<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>client.<span style=color:#7d9029>sqlQuery</span>(<span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>SqlQueryRequest(dropTableSql)).<span style=color:#7d9029>get</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>if</span><span style=color:#bbb> </span>(<span style=color:#666>!</span>dropResult.<span style=color:#7d9029>isOk</span>())<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>throw</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>IllegalStateException(<span style=color:#ba2121>&#34;Fail to drop table&#34;</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=write-data-example>Write Data Example</h2><p>Firstly, you can use <code>PointBuilder</code> to build HoraeDB points:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>List<span style=color:#666>&lt;</span>Point<span style=color:#666>&gt;</span><span style=color:#bbb> </span>pointList<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>LinkedList<span style=color:#666>&lt;&gt;</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>for</span><span style=color:#bbb> </span>(<span style=color:#b00040>int</span><span style=color:#bbb> </span>i<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>0;<span style=color:#bbb> </span>i<span style=color:#bbb> </span><span style=color:#666>&lt;</span><span style=color:#bbb> </span>100;<span style=color:#bbb> </span>i<span style=color:#666>++</span>)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#408080;font-style:italic>// build one point</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>final</span><span style=color:#bbb> </span>Point<span style=color:#bbb> </span>point<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Point.<span style=color:#7d9029>newPointBuilder</span>(<span style=color:#ba2121>&#34;machine_table&#34;</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>.<span style=color:#7d9029>setTimestamp</span>(t0)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>.<span style=color:#7d9029>addTag</span>(<span style=color:#ba2121>&#34;city&#34;</span>,<span style=color:#bbb> </span><span style=color:#ba2121>&#34;Singapore&#34;</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>.<span style=color:#7d9029>addTag</span>(<span style=color:#ba2121>&#34;ip&#34;</span>,<span style=color:#bbb> </span><span style=color:#ba2121>&#34;10.0.0.1&#34;</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>.<span style=color:#7d9029>addField</span>(<span style=color:#ba2121>&#34;cpu&#34;</span>,<span style=color:#bbb> </span>Value.<span style=color:#7d9029>withDouble</span>(0.<span style=color:#7d9029>23</span>))<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>.<span style=color:#7d9029>addField</span>(<span style=color:#ba2121>&#34;mem&#34;</span>,<span style=color:#bbb> </span>Value.<span style=color:#7d9029>withDouble</span>(0.<span style=color:#7d9029>55</span>))<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>.<span style=color:#7d9029>build</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>points.<span style=color:#7d9029>add</span>(point);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>Then, you can use <code>write</code> interface to write data:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>final</span><span style=color:#bbb> </span>CompletableFuture<span style=color:#666>&lt;</span>Result<span style=color:#666>&lt;</span>WriteOk,<span style=color:#bbb> </span>Err<span style=color:#666>&gt;&gt;</span><span style=color:#bbb> </span>wf<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>client.<span style=color:#7d9029>write</span>(<span style=color:green;font-weight:700>new</span><span style=color:#bbb> </span>WriteRequest(pointList));<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// here the `future.get` is just for demonstration, a better async programming practice would be using the CompletableFuture API</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>final</span><span style=color:#bbb> </span>Result<span style=color:#666>&lt;</span>WriteOk,<span style=color:#bbb> </span>Err<span style=color:#666>&gt;</span><span style=color:#bbb> </span>writeResult<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>wf.<span style=color:#7d9029>get</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>Assert.<span style=color:#7d9029>assertTrue</span>(writeResult.<span style=color:#7d9029>isOk</span>());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#408080;font-style:italic>// `Result` class referenced the Rust language practice, provides rich functions (such as mapXXX, andThen) transforming the result value to improve programming efficiency. You can refer to the API docs for detail usage.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>Assert.<span style=color:#7d9029>assertEquals</span>(3,<span style=color:#bbb> </span>writeResult.<span style=color:#7d9029>getOk</span>().<span style=color:#7d9029>getSuccess</span>());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>Assert.<span style=color:#7d9029>assertEquals</span>(3,<span style=color:#bbb> </span>writeResult.<span style=color:#7d9029>mapOr</span>(0,<span style=color:#bbb> </span>WriteOk::getSuccess).<span style=color:#7d9029>intValue</span>());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>Assert.<span style=color:#7d9029>assertEquals</span>(0,<span style=color:#bbb> </span>writeResult.<span style=color:#7d9029>mapOr</span>(<span style=color:#666>-</span>1,<span style=color:#bbb> </span>WriteOk::getFailed).<span style=color:#7d9029>intValue</span>());<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>See <a href=https://github.com/apache/incubator-horaedb-client-java/tree/main/docs/write.md>write</a></p><h2 id=query-data-example>Query Data Example</h2><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>final</span><span style=color:#bbb> </span>SqlQueryRequest<span style=color:#bbb> </span>queryRequest<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>SqlQueryRequest.<span style=color:#7d9029>newBuilder</span>()<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>.<span style=color:#7d9029>forTables</span>(<span style=color:#ba2121>&#34;machine_table&#34;</span>)<span style=color:#bbb> </span><span style=color:#408080;font-style:italic>// table name is optional. If not provided, SQL parser will parse the `ssql` to get the table name and do the routing automaticly</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>.<span style=color:#7d9029>sql</span>(<span style=color:#ba2121>&#34;select * from machine_table where ts = %d&#34;</span>,<span style=color:#bbb> </span>t0)<span style=color:#bbb> </span><span style=color:#408080;font-style:italic>//</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>.<span style=color:#7d9029>build</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>final</span><span style=color:#bbb> </span>CompletableFuture<span style=color:#666>&lt;</span>Result<span style=color:#666>&lt;</span>SqlQueryOk,<span style=color:#bbb> </span>Err<span style=color:#666>&gt;&gt;</span><span style=color:#bbb> </span>qf<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>client.<span style=color:#7d9029>sqlQuery</span>(queryRequest);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// here the `future.get` is just for demonstration, a better async programming practice would be using the CompletableFuture API</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>final</span><span style=color:#bbb> </span>Result<span style=color:#666>&lt;</span>SqlQueryOk,<span style=color:#bbb> </span>Err<span style=color:#666>&gt;</span><span style=color:#bbb> </span>queryResult<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>qf.<span style=color:#7d9029>get</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Assert.<span style=color:#7d9029>assertTrue</span>(queryResult.<span style=color:#7d9029>isOk</span>());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>final</span><span style=color:#bbb> </span>SqlQueryOk<span style=color:#bbb> </span>queryOk<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>queryResult.<span style=color:#7d9029>getOk</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Assert.<span style=color:#7d9029>assertEquals</span>(1,<span style=color:#bbb> </span>queryOk.<span style=color:#7d9029>getRowCount</span>());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// get rows as list</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>final</span><span style=color:#bbb> </span>List<span style=color:#666>&lt;</span>Row<span style=color:#666>&gt;</span><span style=color:#bbb> </span>rows<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>queryOk.<span style=color:#7d9029>getRowList</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Assert.<span style=color:#7d9029>assertEquals</span>(t0,<span style=color:#bbb> </span>rows.<span style=color:#7d9029>get</span>(0).<span style=color:#7d9029>getColumn</span>(<span style=color:#ba2121>&#34;ts&#34;</span>).<span style=color:#7d9029>getValue</span>().<span style=color:#7d9029>getTimestamp</span>());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Assert.<span style=color:#7d9029>assertEquals</span>(<span style=color:#ba2121>&#34;Singapore&#34;</span>,<span style=color:#bbb> </span>rows.<span style=color:#7d9029>get</span>(0).<span style=color:#7d9029>getColumn</span>(<span style=color:#ba2121>&#34;city&#34;</span>).<span style=color:#7d9029>getValue</span>().<span style=color:#7d9029>getString</span>());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Assert.<span style=color:#7d9029>assertEquals</span>(<span style=color:#ba2121>&#34;10.0.0.1&#34;</span>,<span style=color:#bbb> </span>rows.<span style=color:#7d9029>get</span>(0).<span style=color:#7d9029>getColumn</span>(<span style=color:#ba2121>&#34;ip&#34;</span>).<span style=color:#7d9029>getValue</span>().<span style=color:#7d9029>getString</span>());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Assert.<span style=color:#7d9029>assertEquals</span>(0.<span style=color:#7d9029>23</span>,<span style=color:#bbb> </span>rows.<span style=color:#7d9029>get</span>(0).<span style=color:#7d9029>getColumn</span>(<span style=color:#ba2121>&#34;cpu&#34;</span>).<span style=color:#7d9029>getValue</span>().<span style=color:#7d9029>getDouble</span>(),<span style=color:#bbb> </span>0.<span style=color:#7d9029>0000001</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Assert.<span style=color:#7d9029>assertEquals</span>(0.<span style=color:#7d9029>55</span>,<span style=color:#bbb> </span>rows.<span style=color:#7d9029>get</span>(0).<span style=color:#7d9029>getColumn</span>(<span style=color:#ba2121>&#34;mem&#34;</span>).<span style=color:#7d9029>getValue</span>().<span style=color:#7d9029>getDouble</span>(),<span style=color:#bbb> </span>0.<span style=color:#7d9029>0000001</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// get rows as stream</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>final</span><span style=color:#bbb> </span>Stream<span style=color:#666>&lt;</span>Row<span style=color:#666>&gt;</span><span style=color:#bbb> </span>rowStream<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>queryOk.<span style=color:#7d9029>stream</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>rowStream.<span style=color:#7d9029>forEach</span>(row<span style=color:#bbb> </span><span style=color:#666>-&gt;</span><span style=color:#bbb> </span>System.<span style=color:#7d9029>out</span>.<span style=color:#7d9029>println</span>(row.<span style=color:#7d9029>toString</span>()));<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>See <a href=https://github.com/apache/incubator-horaedb-client-java/tree/main/docs/read.md>read</a></p><h2 id=stream-writeread-example>Stream Write/Read Example</h2><p>HoraeDB support streaming writing and reading，suitable for large-scale data reading and writing。</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#b00040>long</span><span style=color:#bbb> </span>start<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>System.<span style=color:#7d9029>currentTimeMillis</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#b00040>long</span><span style=color:#bbb> </span>t<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>start;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>final</span><span style=color:#bbb> </span>StreamWriteBuf<span style=color:#666>&lt;</span>Point,<span style=color:#bbb> </span>WriteOk<span style=color:#666>&gt;</span><span style=color:#bbb> </span>writeBuf<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>client.<span style=color:#7d9029>streamWrite</span>(<span style=color:#ba2121>&#34;machine_table&#34;</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>for</span><span style=color:#bbb> </span>(<span style=color:#b00040>int</span><span style=color:#bbb> </span>i<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>0;<span style=color:#bbb> </span>i<span style=color:#bbb> </span><span style=color:#666>&lt;</span><span style=color:#bbb> </span>1000;<span style=color:#bbb> </span>i<span style=color:#666>++</span>)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>final</span><span style=color:#bbb> </span>Point<span style=color:#bbb> </span>streamData<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Point.<span style=color:#7d9029>newPointBuilder</span>(<span style=color:#ba2121>&#34;machine_table&#34;</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>.<span style=color:#7d9029>setTimestamp</span>(t)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>.<span style=color:#7d9029>addTag</span>(<span style=color:#ba2121>&#34;city&#34;</span>,<span style=color:#bbb> </span><span style=color:#ba2121>&#34;Beijing&#34;</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>.<span style=color:#7d9029>addTag</span>(<span style=color:#ba2121>&#34;ip&#34;</span>,<span style=color:#bbb> </span><span style=color:#ba2121>&#34;10.0.0.3&#34;</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>.<span style=color:#7d9029>addField</span>(<span style=color:#ba2121>&#34;cpu&#34;</span>,<span style=color:#bbb> </span>Value.<span style=color:#7d9029>withDouble</span>(0.<span style=color:#7d9029>42</span>))<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>.<span style=color:#7d9029>addField</span>(<span style=color:#ba2121>&#34;mem&#34;</span>,<span style=color:#bbb> </span>Value.<span style=color:#7d9029>withDouble</span>(0.<span style=color:#7d9029>67</span>))<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>.<span style=color:#7d9029>build</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>writeBuf.<span style=color:#7d9029>writeAndFlush</span>(Collections.<span style=color:#7d9029>singletonList</span>(streamData));<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>t<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>t<span style=color:#666>+</span>1;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>final</span><span style=color:#bbb> </span>CompletableFuture<span style=color:#666>&lt;</span>WriteOk<span style=color:#666>&gt;</span><span style=color:#bbb> </span>writeOk<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>writeBuf.<span style=color:#7d9029>completed</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Assert.<span style=color:#7d9029>assertEquals</span>(1000,<span style=color:#bbb> </span>writeOk.<span style=color:#7d9029>join</span>().<span style=color:#7d9029>getSuccess</span>());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>final</span><span style=color:#bbb> </span>SqlQueryRequest<span style=color:#bbb> </span>streamQuerySql<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>SqlQueryRequest.<span style=color:#7d9029>newBuilder</span>()<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>.<span style=color:#7d9029>sql</span>(<span style=color:#ba2121>&#34;select * from %s where city = &#39;%s&#39; and ts &gt;= %d and ts &lt; %d&#34;</span>,<span style=color:#bbb> </span><span style=color:#ba2121>&#34;machine_table&#34;</span>,<span style=color:#bbb> </span><span style=color:#ba2121>&#34;Beijing&#34;</span>,<span style=color:#bbb> </span>start,<span style=color:#bbb> </span>t).<span style=color:#7d9029>build</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>final</span><span style=color:#bbb> </span>Result<span style=color:#666>&lt;</span>SqlQueryOk,<span style=color:#bbb> </span>Err<span style=color:#666>&gt;</span><span style=color:#bbb> </span>streamQueryResult<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>client.<span style=color:#7d9029>sqlQuery</span>(streamQuerySql).<span style=color:#7d9029>get</span>();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Assert.<span style=color:#7d9029>assertTrue</span>(streamQueryResult.<span style=color:#7d9029>isOk</span>());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Assert.<span style=color:#7d9029>assertEquals</span>(1000,<span style=color:#bbb> </span>streamQueryResult.<span style=color:#7d9029>getOk</span>().<span style=color:#7d9029>getRowCount</span>());<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>See <a href=https://github.com/apache/incubator-horaedb-client-java/tree/main/docs/streaming.md>streaming</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-d8c6cac92b3914596fc657a1fa438885>2.3.3 - Python</h1><h2 id=introduction>Introduction</h2><p><a href=https://pypi.org/project/ceresdb-client/>horaedb-client</a> is the python client for <a href=https://github.com/apache/incubator-horaedb>HoraeDB</a>.</p><p>Thanks to <a href=https://github.com/PyO3>PyO3</a>, the python client is actually a wrapper on the <a href=https://github.com/apache/incubator-horaedb-client-rs>rust client</a>.</p><p>The guide will give a basic introduction to the python client by <a href=https://github.com/apache/incubator-horaedb-client-py/blob/main/examples/read_write.py>example</a>.</p><h2 id=requirements>Requirements</h2><ul><li>Python >= 3.7</li></ul><h2 id=installation>Installation</h2><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip install ceresdb-client
</span></span></code></pre></td></tr></table></div></div><p>You can get latest version <a href=https://github.com/apache/incubator-horaedb-client-py/tags>here</a>.</p><h2 id=init-horaedb-client>Init HoraeDB Client</h2><p>The client initialization comes first, here is a code snippet:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>asyncio</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>datetime</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>from</span> <span style=color:#00f;font-weight:700>ceresdb_client</span> <span style=color:green;font-weight:700>import</span> Builder, RpcContext, PointBuilder, ValueBuilder, WriteRequest, SqlQueryRequest, Mode, RpcConfig
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rpc_config <span style=color:#666>=</span> RpcConfig()
</span></span><span style=display:flex><span>rpc_config <span style=color:#666>=</span> RpcConfig()
</span></span><span style=display:flex><span>rpc_config<span style=color:#666>.</span>thread_num <span style=color:#666>=</span> <span style=color:#666>1</span>
</span></span><span style=display:flex><span>rpc_config<span style=color:#666>.</span>default_write_timeout_ms <span style=color:#666>=</span> <span style=color:#666>1000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>builder <span style=color:#666>=</span> Builder(<span style=color:#ba2121>&#39;127.0.0.1:8831&#39;</span>, Mode<span style=color:#666>.</span>Direct)
</span></span><span style=display:flex><span>builder<span style=color:#666>.</span>set_rpc_config(rpc_config)
</span></span><span style=display:flex><span>builder<span style=color:#666>.</span>set_default_database(<span style=color:#ba2121>&#39;public&#39;</span>)
</span></span><span style=display:flex><span>client <span style=color:#666>=</span> builder<span style=color:#666>.</span>build()
</span></span></code></pre></td></tr></table></div></div><p>Firstly, it&rsquo;s worth noting that the imported packages are used across all the code snippets in this guide, and they will not be repeated in the following.</p><p>The initialization requires at least two parameters:</p><ul><li><code>Endpoint</code>: the server endpoint consisting of ip address and serving port, e.g. <code>127.0.0.1:8831</code>;</li><li><code>Mode</code>: The mode of the communication between client and server, and there are two kinds of <code>Mode</code>: <code>Direct</code> and <code>Proxy</code>.</li></ul><p><code>Endpoint</code> is simple, while <code>Mode</code> deserves more explanation. The <code>Direct</code> mode should be adopted to avoid forwarding overhead if all the servers are accessible to the client. However, the <code>Proxy</code> mode is the only choice if the access to the servers from the client must go through a gateway.</p><p>The <code>default_database</code> can be set and will be used if following rpc calling without setting the database in the <code>RpcContext</code>.</p><p>By configuring the <code>RpcConfig</code>, resource and performance of the client can be manipulated, and all of the configurations can be referred at <a href=https://github.com/apache/incubator-horaedb-client-py/blob/main/ceresdb_client.pyi>here</a>.</p><h2 id=create-table>Create Table</h2><p>For ease of use, when using gRPC&rsquo;s write interface for writing, if a table does not exist, HoraeDB will automatically create a table based on the first write.</p><p>Of course, you can also use <code>create table</code> statement to manage the table more finely (such as adding indexes).</p><p>Here is a example for creating table by the initialized client:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:green;font-weight:700>async</span> <span style=color:green;font-weight:700>def</span> <span style=color:#00f>async_query</span>(client, ctx, req):
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>await</span> client<span style=color:#666>.</span>sql_query(ctx, req)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>create_table_sql <span style=color:#666>=</span> <span style=color:#ba2121>&#39;CREATE TABLE IF NOT EXISTS demo ( </span><span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span><span style=color:#ba2121>    name string TAG, </span><span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span><span style=color:#ba2121>    value double, </span><span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span><span style=color:#ba2121>    t timestamp NOT NULL, </span><span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span><span style=color:#ba2121>    TIMESTAMP KEY(t)) ENGINE=Analytic with (enable_ttl=false)&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>req <span style=color:#666>=</span> SqlQueryRequest([<span style=color:#ba2121>&#39;demo&#39;</span>], create_table_sql)
</span></span><span style=display:flex><span>rpc_ctx <span style=color:#666>=</span> RpcContext()
</span></span><span style=display:flex><span>rpc_ctx<span style=color:#666>.</span>database <span style=color:#666>=</span> <span style=color:#ba2121>&#39;public&#39;</span>
</span></span><span style=display:flex><span>rpc_ctx<span style=color:#666>.</span>timeout_ms <span style=color:#666>=</span> <span style=color:#666>100</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>event_loop <span style=color:#666>=</span> asyncio<span style=color:#666>.</span>get_event_loop()
</span></span><span style=display:flex><span>event_loop<span style=color:#666>.</span>run_until_complete(async_query(client, rpc_ctx, req))
</span></span></code></pre></td></tr></table></div></div><p><code>RpcContext</code> can be used to overwrite the default database and timeout defined in the initialization of the client.</p><h2 id=write-data>Write Data</h2><p><code>PointBuilder</code> can be used to construct a point, which is actually a row in data set. The write request consists of multiple points.</p><p>The example is simple:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:green;font-weight:700>async</span> <span style=color:green;font-weight:700>def</span> <span style=color:#00f>async_write</span>(client, ctx, req):
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>return</span> <span style=color:green;font-weight:700>await</span> client<span style=color:#666>.</span>write(ctx, req)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>point_builder <span style=color:#666>=</span> PointBuilder(<span style=color:#ba2121>&#39;demo&#39;</span>)
</span></span><span style=display:flex><span>point_builder<span style=color:#666>.</span>set_timestamp(<span style=color:#666>1000</span> <span style=color:#666>*</span> <span style=color:green>int</span>(<span style=color:green>round</span>(datetime<span style=color:#666>.</span>datetime<span style=color:#666>.</span>now()<span style=color:#666>.</span>timestamp())))
</span></span><span style=display:flex><span>point_builder<span style=color:#666>.</span>set_tag(<span style=color:#ba2121>&#34;name&#34;</span>, ValueBuilder()<span style=color:#666>.</span>string(<span style=color:#ba2121>&#34;test_tag1&#34;</span>))
</span></span><span style=display:flex><span>point_builder<span style=color:#666>.</span>set_field(<span style=color:#ba2121>&#34;value&#34;</span>, ValueBuilder()<span style=color:#666>.</span>double(<span style=color:#666>0.4242</span>))
</span></span><span style=display:flex><span>point <span style=color:#666>=</span> point_builder<span style=color:#666>.</span>build()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>write_request <span style=color:#666>=</span> WriteRequest()
</span></span><span style=display:flex><span>write_request<span style=color:#666>.</span>add_point(point)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>event_loop <span style=color:#666>=</span> asyncio<span style=color:#666>.</span>get_event_loop()
</span></span><span style=display:flex><span>event_loop<span style=color:#666>.</span>run_until_complete(async_write(client, ctx, req))
</span></span></code></pre></td></tr></table></div></div><h2 id=query-data>Query Data</h2><p>By <code>sql_query</code> interface, it is easy to retrieve the data from the server:</p><pre tabindex=0><code>req = SqlQueryRequest([&#39;demo&#39;], &#39;select * from demo&#39;)
event_loop = asyncio.get_event_loop()
resp = event_loop.run_until_complete(async_query(client, ctx, req))
</code></pre><p>As the example shows, two parameters are needed to construct the <code>SqlQueryRequest</code>:</p><ul><li>The tables involved by this sql query;</li><li>The query sql.</li></ul><p>Currently, the first parameter is necessary for performance on routing.</p><p>With retrieved data, we can process it row by row and column by column:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#408080;font-style:italic># Access row by index in the resp.</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>for</span> row_idx <span style=color:#a2f;font-weight:700>in</span> <span style=color:green>range</span>(<span style=color:#666>0</span>, resp<span style=color:#666>.</span>num_rows()):
</span></span><span style=display:flex><span>    row_tokens <span style=color:#666>=</span> []
</span></span><span style=display:flex><span>    row <span style=color:#666>=</span> resp<span style=color:#666>.</span>row_by_idx(row_idx)
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>for</span> col_idx <span style=color:#a2f;font-weight:700>in</span> <span style=color:green>range</span>(<span style=color:#666>0</span>, row<span style=color:#666>.</span>num_cols()):
</span></span><span style=display:flex><span>        col <span style=color:#666>=</span> row<span style=color:#666>.</span>column_by_idx(col_idx)
</span></span><span style=display:flex><span>        row_tokens<span style=color:#666>.</span>append(<span style=color:#ba2121>f</span><span style=color:#ba2121>&#34;</span><span style=color:#b68;font-weight:700>{</span>col<span style=color:#666>.</span>name()<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121>:</span><span style=color:#b68;font-weight:700>{</span>col<span style=color:#666>.</span>value()<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121>#</span><span style=color:#b68;font-weight:700>{</span>col<span style=color:#666>.</span>data_type()<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:green>print</span>(<span style=color:#ba2121>f</span><span style=color:#ba2121>&#34;row#</span><span style=color:#b68;font-weight:700>{</span>row_idx<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121>: </span><span style=color:#b68;font-weight:700>{</span><span style=color:#ba2121>&#39;,&#39;</span><span style=color:#666>.</span>join(row_tokens)<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic># Access row by iter in the resp.</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>for</span> row <span style=color:#a2f;font-weight:700>in</span> resp<span style=color:#666>.</span>iter_rows():
</span></span><span style=display:flex><span>    row_tokens <span style=color:#666>=</span> []
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>for</span> col <span style=color:#a2f;font-weight:700>in</span> row<span style=color:#666>.</span>iter_columns():
</span></span><span style=display:flex><span>        row_tokens<span style=color:#666>.</span>append(<span style=color:#ba2121>f</span><span style=color:#ba2121>&#34;</span><span style=color:#b68;font-weight:700>{</span>col<span style=color:#666>.</span>name()<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121>:</span><span style=color:#b68;font-weight:700>{</span>col<span style=color:#666>.</span>value()<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121>#</span><span style=color:#b68;font-weight:700>{</span>col<span style=color:#666>.</span>data_type()<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:green>print</span>(<span style=color:#ba2121>f</span><span style=color:#ba2121>&#34;row: </span><span style=color:#b68;font-weight:700>{</span><span style=color:#ba2121>&#39;,&#39;</span><span style=color:#666>.</span>join(row_tokens)<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121>&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><h2 id=drop-table>Drop Table</h2><p>Finally, we can drop the table by the sql api, which is similar to the table creation:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>drop_table_sql <span style=color:#666>=</span> <span style=color:#ba2121>&#39;DROP TABLE demo&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>req <span style=color:#666>=</span> SqlQueryRequest([<span style=color:#ba2121>&#39;demo&#39;</span>], drop_table_sql)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>event_loop <span style=color:#666>=</span> asyncio<span style=color:#666>.</span>get_event_loop()
</span></span><span style=display:flex><span>event_loop<span style=color:#666>.</span>run_until_complete(async_query(client, rpc_ctx, req))
</span></span></code></pre></td></tr></table></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-8b17bc3ecdfd6226bf296cc8d8c38345>2.3.4 - Rust</h1><h2 id=install>Install</h2><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cargo add horaedb-client
</span></span></code></pre></td></tr></table></div></div><p>You can get latest version <a href=https://github.com/apache/horaedb-client-rs/tags>here</a>.</p><h2 id=init-client>Init Client</h2><p>At first, we need to init the client.</p><ul><li>New builder for the client, and you must set <code>endpoint</code> and <code>mode</code>:<ul><li><code>endpoint</code> is a string which is usually like &ldquo;ip/domain_name:port&rdquo;.</li><li><code>mode</code> is used to define the way to access horaedb server, <a href=https://github.com/apache/horaedb-client-rs/blob/main/src/db_client/builder.rs#L20>detail about mode</a>.</li></ul></li></ul><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:green;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>mut</span><span style=color:#bbb> </span>builder<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Builder::new(<span style=color:#ba2121>&#34;ip/domain_name:port&#34;</span>,<span style=color:#bbb> </span>Mode::Direct<span style=color:#666>/</span>Mode::Proxy);<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>New and set <code>rpc_config</code>, it can be defined on demand or just use the default value, <a href=https://github.com/apache/horaedb-client-rs/blob/main/src/options.rs>detail about rpc config</a>:</li></ul><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:green;font-weight:700>let</span><span style=color:#bbb> </span>rpc_config<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>RpcConfig<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>thread_num: <span style=color:green>Some</span>(<span style=color:#666>1</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>default_write_timeout: <span style=color:#00f;font-weight:700>Duration</span>::from_millis(<span style=color:#666>1000</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>..</span><span style=color:green>Default</span>::default()<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>};<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>let</span><span style=color:#bbb> </span>builder<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>builder.rpc_config(rpc_config);<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>Set <code>default_database</code>, it will be used if following rpc calling without setting the database in the <code>RpcContext</code>(will be introduced in later):</li></ul><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>let</span><span style=color:#bbb> </span>builder<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>builder.default_database(<span style=color:#ba2121>&#34;public&#34;</span>);<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>Finally, we build client from builder:</li></ul><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>let</span><span style=color:#bbb> </span>client<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>builder.build();<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=manage-table>Manage Table</h2><p>For ease of use, when using gRPC&rsquo;s write interface for writing, if a table does not exist, HoraeDB will automatically create a table based on the first write.</p><p>Of course, you can also use <code>create table</code> statement to manage the table more finely (such as adding indexes).</p><p>You can use the sql query interface to create or drop table, related setting will be introduced in <code>sql query</code> section.</p><ul><li>Create table:</li></ul><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:green;font-weight:700>let</span><span style=color:#bbb> </span>create_table_sql<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#ba2121>r</span><span style=color:#ba2121>#&#34;CREATE TABLE IF NOT EXISTS horaedb (
</span></span></span><span style=display:flex><span><span style=color:#ba2121>            str_tag string TAG,
</span></span></span><span style=display:flex><span><span style=color:#ba2121>            int_tag int32 TAG,
</span></span></span><span style=display:flex><span><span style=color:#ba2121>            var_tag varbinary TAG,
</span></span></span><span style=display:flex><span><span style=color:#ba2121>            str_field string,
</span></span></span><span style=display:flex><span><span style=color:#ba2121>            int_field int32,
</span></span></span><span style=display:flex><span><span style=color:#ba2121>            bin_field varbinary,
</span></span></span><span style=display:flex><span><span style=color:#ba2121>            t timestamp NOT NULL,
</span></span></span><span style=display:flex><span><span style=color:#ba2121>            TIMESTAMP KEY(t)) ENGINE=Analytic with
</span></span></span><span style=display:flex><span><span style=color:#ba2121>            (enable_ttl=&#39;false&#39;)&#34;#</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>let</span><span style=color:#bbb> </span>req<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>SqlQueryRequest<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>tables: <span style=color:#00f;font-weight:700>vec</span><span style=color:#666>!</span>[<span style=color:#ba2121>&#34;horaedb&#34;</span>.to_string()],<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>sql: <span style=color:#00f;font-weight:700>create_table_sql</span>.to_string(),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>};<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>let</span><span style=color:#bbb> </span>resp<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>client<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.sql_query(rpc_ctx,<span style=color:#bbb> </span><span style=color:#666>&amp;</span>req)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.<span style=color:green;font-weight:700>await</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.expect(<span style=color:#ba2121>&#34;Should succeed to create table&#34;</span>);<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>Drop table:</li></ul><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:green;font-weight:700>let</span><span style=color:#bbb> </span>drop_table_sql<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#ba2121>&#34;DROP TABLE horaedb&#34;</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>let</span><span style=color:#bbb> </span>req<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>SqlQueryRequest<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>tables: <span style=color:#00f;font-weight:700>vec</span><span style=color:#666>!</span>[<span style=color:#ba2121>&#34;horaedb&#34;</span>.to_string()],<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>sql: <span style=color:#00f;font-weight:700>drop_table_sql</span>.to_string(),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>};<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>let</span><span style=color:#bbb> </span>resp<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>client<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.sql_query(rpc_ctx,<span style=color:#bbb> </span><span style=color:#666>&amp;</span>req)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.<span style=color:green;font-weight:700>await</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.expect(<span style=color:#ba2121>&#34;Should succeed to create table&#34;</span>);<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=write>Write</h2><p>We support to write with the time series data model like <a href=https://awesome.influxdata.com/docs/part-2/influxdb-data-model/>InfluxDB</a>.</p><ul><li>Build the <code>point</code> first by <code>PointBuilder</code>, the related data structure of <code>tag value</code> and <code>field value</code> in it is defined as <code>Value</code>, <a href=https://github.com/apache/horaedb-client-rs/blob/main/src/model/value.rs>detail about Value</a>:</li></ul><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:green;font-weight:700>let</span><span style=color:#bbb> </span>test_table<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#ba2121>&#34;horaedb&#34;</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>let</span><span style=color:#bbb> </span>ts<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Local::now().timestamp_millis();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>let</span><span style=color:#bbb> </span>point<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>PointBuilder::new(test_table.to_string())<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>.timestamp(ts)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>.tag(<span style=color:#ba2121>&#34;str_tag&#34;</span>.to_string(),<span style=color:#bbb> </span>Value::<span style=color:green>String</span>(<span style=color:#ba2121>&#34;tag_val&#34;</span>.to_string()))<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>.tag(<span style=color:#ba2121>&#34;int_tag&#34;</span>.to_string(),<span style=color:#bbb> </span>Value::Int32(<span style=color:#666>42</span>))<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>.tag(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#ba2121>&#34;var_tag&#34;</span>.to_string(),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>Value::Varbinary(<span style=color:#ba2121>b</span><span style=color:#ba2121>&#34;tag_bin_val&#34;</span>.to_vec()),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>.field(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#ba2121>&#34;str_field&#34;</span>.to_string(),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>Value::<span style=color:green>String</span>(<span style=color:#ba2121>&#34;field_val&#34;</span>.to_string()),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>.field(<span style=color:#ba2121>&#34;int_field&#34;</span>.to_string(),<span style=color:#bbb> </span>Value::Int32(<span style=color:#666>42</span>))<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>.field(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#ba2121>&#34;bin_field&#34;</span>.to_string(),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>Value::Varbinary(<span style=color:#ba2121>b</span><span style=color:#ba2121>&#34;field_bin_val&#34;</span>.to_vec()),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>.build()<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>.unwrap();<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>Add the <code>point</code> to <code>write request</code>:</li></ul><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:green;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>mut</span><span style=color:#bbb> </span>write_req<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>WriteRequest::default();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>write_req.add_point(point);<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><ul><li><p>New <code>rpc_ctx</code>, and it can also be defined on demand or just use the default value, <a href=https://github.com/apache/horaedb-client-rs/blob/a72e673103463c7962e01a097592fc7edbcc0b79/src/rpc_client/mod.rs#L29>detail about rpc ctx</a>:</p></li><li><p>Finally, write to server by client.</p></li></ul><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:green;font-weight:700>let</span><span style=color:#bbb> </span>rpc_ctx<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>RpcContext<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>database: <span style=color:green>Some</span>(<span style=color:#ba2121>&#34;public&#34;</span>.to_string()),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>..</span><span style=color:green>Default</span>::default()<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>};<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>let</span><span style=color:#bbb> </span>resp<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>client.write(rpc_ctx,<span style=color:#bbb> </span><span style=color:#666>&amp;</span>write_req).<span style=color:green;font-weight:700>await</span>.expect(<span style=color:#ba2121>&#34;Should success to write&#34;</span>);<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=sql-query>Sql Query</h2><p>We support to query data with sql.</p><ul><li>Define related tables and sql in <code>sql query request</code>:</li></ul><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:green;font-weight:700>let</span><span style=color:#bbb> </span>req<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>SqlQueryRequest<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>tables: <span style=color:#00f;font-weight:700>vec</span><span style=color:#666>!</span>[table<span style=color:#bbb> </span>name<span style=color:#bbb> </span><span style=color:#666>1</span>,<span style=color:#666>..</span>.,table<span style=color:#bbb> </span>name<span style=color:#bbb> </span>n],<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>sql: <span style=color:#00f;font-weight:700>sql</span><span style=color:#bbb> </span>string<span style=color:#bbb> </span>(e.g.<span style=color:#bbb> </span>select<span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span>from<span style=color:#bbb> </span>xxx),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>};<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>Query by client:</li></ul><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:green;font-weight:700>let</span><span style=color:#bbb> </span>resp<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>client.sql_query(rpc_ctx,<span style=color:#bbb> </span><span style=color:#666>&amp;</span>req).<span style=color:green;font-weight:700>await</span>.expect(<span style=color:#ba2121>&#34;Should success to write&#34;</span>);<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=example>Example</h2><p>You can find the <a href=https://github.com/apache/horaedb-client-rs/blob/main/examples/read_write.rs>complete example</a> in the project.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-3c025d4e044df01b41b46653bf151f0b>2.4 - Operation and Maintenance</h1><p>This guide introduces the operation and maintenance of HoraeDB, including cluster installation, database&amp;table operations, fault tolerance, disaster recovery, data import and export, etc.</p></div><div class=td-content><h1 id=pg-738a2f3b8314089a64b49e9b83ab85e7>2.4.1 - Block List</h1><h2 id=add-block-list>Add block list</h2><p>If you want to reject query for a table, you can add table name to &lsquo;read_block_list&rsquo;.</p><h3 id=example>Example</h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --location --request POST <span style=color:#ba2121>&#39;http://localhost:5000/admin/block&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>--header <span style=color:#ba2121>&#39;Content-Type: application/json&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>-d <span style=color:#ba2121>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    &#34;operation&#34;:&#34;Add&#34;,
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    &#34;write_block_list&#34;:[],
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    &#34;read_block_list&#34;:[&#34;my_table&#34;]
</span></span></span><span style=display:flex><span><span style=color:#ba2121>}&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=response>Response</h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;write_block_list&#34;</span>: [],
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;read_block_list&#34;</span>: [<span style=color:#ba2121>&#34;my_table&#34;</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=set-block-list>Set block list</h2><p>You can use set operation to clear exist tables and set new tables to &lsquo;read_block_list&rsquo; like following example.</p><h3 id=example-1>Example</h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --location --request POST <span style=color:#ba2121>&#39;http://localhost:5000/admin/block&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>--header <span style=color:#ba2121>&#39;Content-Type: application/json&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>-d <span style=color:#ba2121>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    &#34;operation&#34;:&#34;Set&#34;,
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    &#34;write_block_list&#34;:[],
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    &#34;read_block_list&#34;:[&#34;my_table1&#34;,&#34;my_table2&#34;]
</span></span></span><span style=display:flex><span><span style=color:#ba2121>}&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=response-1>Response</h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;write_block_list&#34;</span>: [],
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;read_block_list&#34;</span>: [<span style=color:#ba2121>&#34;my_table1&#34;</span>, <span style=color:#ba2121>&#34;my_table2&#34;</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=remove-block-list>Remove block list</h2><p>You can remove tables from &lsquo;read_block_list&rsquo; like following example.</p><h3 id=example-2>Example</h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --location --request POST <span style=color:#ba2121>&#39;http://localhost:5000/admin/block&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>--header <span style=color:#ba2121>&#39;Content-Type: application/json&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>-d <span style=color:#ba2121>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    &#34;operation&#34;:&#34;Remove&#34;,
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    &#34;write_block_list&#34;:[],
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    &#34;read_block_list&#34;:[&#34;my_table1&#34;]
</span></span></span><span style=display:flex><span><span style=color:#ba2121>}&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=response-2>Response</h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;write_block_list&#34;</span>: [],
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;read_block_list&#34;</span>: [<span style=color:#ba2121>&#34;my_table2&#34;</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-5ee6dffed65012da62e99d132c3d88a0>2.4.2 - Cluster Operation</h1><p>The Operations for HoraeDB cluster mode, it can only be used when HoraeMeta is deployed.</p><h2 id=operation-interface>Operation Interface</h2><p>You need to replace 127.0.0.1 with the actual project path.</p><ul><li>Query table
When tableNames is not empty, use tableNames for query.
When tableNames is empty, ids are used for query. When querying with ids, schemaName is useless.</li></ul><pre tabindex=0><code>curl --location &#39;http://127.0.0.1:8080/api/v1/table/query&#39; \
--header &#39;Content-Type: application/json&#39; \
-d &#39;{
    &#34;clusterName&#34;:&#34;defaultCluster&#34;,
    &#34;schemaName&#34;:&#34;public&#34;,
    &#34;names&#34;:[&#34;demo1&#34;, &#34;__demo1_0&#34;],
}&#39;

curl --location &#39;http://127.0.0.1:8080/api/v1/table/query&#39; \
--header &#39;Content-Type: application/json&#39; \
-d &#39;{
    &#34;clusterName&#34;:&#34;defaultCluster&#34;,
    &#34;ids&#34;:[0, 1]
}&#39;
</code></pre><ul><li>Query the route of table</li></ul><pre tabindex=0><code>curl --location --request POST &#39;http://127.0.0.1:8080/api/v1/route&#39; \
--header &#39;Content-Type: application/json&#39; \
-d &#39;{
    &#34;clusterName&#34;:&#34;defaultCluster&#34;,
    &#34;schemaName&#34;:&#34;public&#34;,
    &#34;table&#34;:[&#34;demo&#34;]
}&#39;
</code></pre><ul><li>Query the mapping of shard and node</li></ul><pre tabindex=0><code>curl --location --request POST &#39;http://127.0.0.1:8080/api/v1/getNodeShards&#39; \
--header &#39;Content-Type: application/json&#39; \
-d &#39;{
    &#34;ClusterName&#34;:&#34;defaultCluster&#34;
}&#39;
</code></pre><ul><li>Query the mapping of table and shard
If ShardIDs in the request is empty, query with all shardIDs in the cluster.</li></ul><pre tabindex=0><code>curl --location --request POST &#39;http://127.0.0.1:8080/api/v1/getShardTables&#39; \
--header &#39;Content-Type: application/json&#39; \
-d &#39;{
    &#34;clusterName&#34;:&#34;defaultCluster&#34;,
    &#34;shardIDs&#34;: [1,2]
}&#39;
</code></pre><ul><li>Drop table</li></ul><pre tabindex=0><code>curl --location --request POST &#39;http://127.0.0.1:8080/api/v1/dropTable&#39; \
--header &#39;Content-Type: application/json&#39; \
-d &#39;{
    &#34;clusterName&#34;: &#34;defaultCluster&#34;,
    &#34;schemaName&#34;: &#34;public&#34;,
    &#34;table&#34;: &#34;demo&#34;
}&#39;
</code></pre><ul><li>Transfer leader shard</li></ul><pre tabindex=0><code>curl --location --request POST &#39;http://127.0.0.1:8080/api/v1/transferLeader&#39; \
--header &#39;Content-Type: application/json&#39; \
-d &#39;{
    &#34;clusterName&#34;:&#34;defaultCluster&#34;,
    &#34;shardID&#34;: 1,
    &#34;oldLeaderNodeName&#34;: &#34;127.0.0.1:8831&#34;,
    &#34;newLeaderNodeName&#34;: &#34;127.0.0.1:18831&#34;
}&#39;
</code></pre><ul><li>Split shard</li></ul><pre tabindex=0><code>curl --location --request POST &#39;http://127.0.0.1:8080/api/v1/split&#39; \
--header &#39;Content-Type: application/json&#39; \
-d &#39;{
    &#34;clusterName&#34; : &#34;defaultCluster&#34;,
    &#34;schemaName&#34; :&#34;public&#34;,
    &#34;nodeName&#34; :&#34;127.0.0.1:8831&#34;,
    &#34;shardID&#34; : 0,
    &#34;splitTables&#34;:[&#34;demo&#34;]
}&#39;
</code></pre><ul><li>Create cluster</li></ul><pre tabindex=0><code>curl --location &#39;http://127.0.0.1:8080/api/v1/clusters&#39; \
--header &#39;Content-Type: application/json&#39; \
--data &#39;{
    &#34;name&#34;:&#34;testCluster&#34;,
    &#34;nodeCount&#34;:3,
    &#34;shardTotal&#34;:9,
    &#34;topologyType&#34;:&#34;static&#34;
}&#39;
</code></pre><ul><li>Update cluster</li></ul><pre tabindex=0><code>curl --location --request PUT &#39;http://127.0.0.1:8080/api/v1/clusters/{NewClusterName}&#39; \
--header &#39;Content-Type: application/json&#39; \
--data &#39;{
    &#34;nodeCount&#34;:28,
    &#34;shardTotal&#34;:128,
    &#34;topologyType&#34;:&#34;dynamic&#34;
}&#39;
</code></pre><ul><li>List clusters</li></ul><pre tabindex=0><code>curl --location &#39;http://127.0.0.1:8080/api/v1/clusters&#39;
</code></pre><ul><li>Update <code>enableSchedule</code></li></ul><pre tabindex=0><code>curl --location --request PUT &#39;http://127.0.0.1:8080/api/v1/clusters/{ClusterName}/enableSchedule&#39; \
--header &#39;Content-Type: application/json&#39; \
--data &#39;{
    &#34;enable&#34;:true
}&#39;
</code></pre><ul><li>Query <code>enableSchedule</code></li></ul><pre tabindex=0><code>curl --location &#39;http://127.0.0.1:8080/api/v1/clusters/{ClusterName}/enableSchedule&#39;
</code></pre><ul><li>Update flow limiter</li></ul><pre tabindex=0><code>curl --location --request PUT &#39;http://127.0.0.1:8080/api/v1/flowLimiter&#39; \
--header &#39;Content-Type: application/json&#39; \
--data &#39;{
    &#34;limit&#34;:1000,
    &#34;burst&#34;:10000,
    &#34;enable&#34;:true
}&#39;
</code></pre><ul><li>Query information of flow limiter</li></ul><pre tabindex=0><code>curl --location &#39;http://127.0.0.1:8080/api/v1/flowLimiter&#39;
</code></pre><ul><li>List nodes of HoraeMeta cluster</li></ul><pre tabindex=0><code>curl --location &#39;http://127.0.0.1:8080/api/v1/etcd/member&#39;
</code></pre><ul><li>Move leader of HoraeMeta cluster</li></ul><pre tabindex=0><code>curl --location &#39;http://127.0.0.1:8080/api/v1/etcd/moveLeader&#39; \
--header &#39;Content-Type: application/json&#39; \
--data &#39;{
    &#34;memberName&#34;:&#34;meta1&#34;
}&#39;
</code></pre><ul><li>Add node of HoraeMeta cluster</li></ul><pre tabindex=0><code>curl --location --request PUT &#39;http://127.0.0.1:8080/api/v1/etcd/member&#39; \
--header &#39;Content-Type: application/json&#39; \
--data &#39;{
    &#34;memberAddrs&#34;:[&#34;http://127.0.0.1:42380&#34;]
}&#39;
</code></pre><ul><li>Replace node of HoraeMeta cluster</li></ul><pre tabindex=0><code>curl --location &#39;http://127.0.0.1:8080/api/v1/etcd/member&#39; \
--header &#39;Content-Type: application/json&#39; \
--data &#39;{
    &#34;oldMemberName&#34;:&#34;meta0&#34;,
    &#34;newMemberAddr&#34;:[&#34;http://127.0.0.1:42380&#34;]
}&#39;
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-8075e68e25cc23e412d57385899cca86>2.4.3 - Observability</h1><p>HoraeDB is observable with Prometheus and Grafana.</p><h2 id=prometheus>Prometheus</h2><p><a href=https://github.com/prometheus/prometheus>Prometheus</a> is a systems and service monitoring system.</p><h3 id=configuration>Configuration</h3><p>Save the following configuration into the <code>prometheus.yml</code> file. For example, in the <code>tmp</code> directory, <code>/tmp/prometheus.yml</code>.</p><p>Two HoraeDB http service are started on localhost:5440 and localhost:5441.</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>global</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scrape_interval</span>:<span style=color:#bbb> </span>30s<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>scrape_configs</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>job_name</span>:<span style=color:#bbb> </span>horaedb-server<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>static_configs</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>targets</span>:<span style=color:#bbb> </span>[your_ip:5440, your_ip:5441]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>env</span>:<span style=color:#bbb> </span>horaedbcluster<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>See details about configuration <a href=https://prometheus.io/docs/prometheus/latest/configuration/configuration/>here</a>.</p><h3 id=run>Run</h3><p>You can use docker to start Prometheus. The docker image information is <a href=https://hub.docker.com/r/prom/prometheus>here</a>.</p><pre tabindex=0><code>docker run \
    -d --name=prometheus \
    -p 9090:9090 \
    -v /tmp/prometheus.yml:/etc/prometheus/prometheus.yml \
    prom/prometheus:v2.41.0
</code></pre><p>For more detailed installation methods, refer to <a href=https://prometheus.io/docs/prometheus/latest/installation/>here</a>.</p><h2 id=grafana>Grafana</h2><p><a href=https://github.com/grafana/grafana>Grafana</a> is an open and composable observability and data visualization platform.</p><h3 id=run-1>Run</h3><p>You can use docker to start grafana. The docker image information is <a href=https://hub.docker.com/r/grafana/grafana>here</a>.</p><pre tabindex=0><code>docker run -d --name=grafana -p 3000:3000 grafana/grafana:9.3.6
</code></pre><p>Default admin user credentials are admin/admin.</p><p>Grafana is available on http://127.0.0.1:3000.</p><p>For more detailed installation methods, refer to <a href=https://grafana.com/docs/grafana/latest/setup-grafana/installation/>here</a>.</p><h3 id=configure-data-source>Configure data source</h3><ol><li>Hover the cursor over the Configuration (gear) icon.</li><li>Select Data Sources.</li><li>Select the Prometheus data source.</li></ol><p>Note: The url of Prometheus is <code>http://your_ip:9090</code>.</p><img src=/images/grafana-datasource.png height=400 width=200><p>See more details <a href=https://grafana.com/docs/grafana/latest/datasources/prometheus/>here</a>.</p><h3 id=import-grafana-dashboard>Import grafana dashboard</h3><p><a href=/grafana-dashboard.json>dashboard json</a></p><img src=/images/grafana-dashboard.png height=400 width=200><h2 id=horaedb-metrics>HoraeDB Metrics</h2><p>After importing the dashboard, you will see the following page:</p><img src=/images/grafana-horaedb-dashboard.png height=400 width=600><h3 id=panels>Panels</h3><ul><li>tps: Number of cluster write requests.</li><li>qps: Number of cluster query requests.</li><li>99th query/write duration: 99th quantile of write and query duration.</li><li>table query: Query group by table.</li><li>99th write duration details by instance: 99th quantile of write duration group by instance.</li><li>99th query duration details by instance: 99th quantile of query duration group by instance.</li><li>99th write partition table duration: 99th quantile of write duration of partition table.</li><li>table rows: The rows of data written.</li><li>table rows by instance: The written rows by instance.</li><li>total tables to write: Number of tables with data written.</li><li>flush count: Number of HoraeDB flush.</li><li>99th flush duration details by instance: 99th quantile of flush duration group by instance.</li><li>99th write stall duration details by instance: 99th quantile of write stall duration group by instance.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-a415e58936001e7befe959b3318dac0e>2.4.4 - Table Operation</h1><h2 id=query-table-information>Query Table Information</h2><p>Like Mysql&rsquo;s <code>information_schema.tables</code>, HoraeDB provides <code>system.public.tables</code> to save tables information.
Columns:</p><ul><li>timestamp([TimeStamp])</li><li>catalog([String])</li><li>schema([String])</li><li>table_name([String])</li><li>table_id([Uint64])</li><li>engine([String])</li></ul><h3 id=example>Example</h3><p>Query table information via table_name like this:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --location --request POST <span style=color:#ba2121>&#39;http://localhost:5000/sql&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>--header <span style=color:#ba2121>&#39;Content-Type: application/json&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>-d <span style=color:#ba2121>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    &#34;query&#34;: &#34;select * from system.public.tables where `table_name`=\&#34;my_table\&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>}&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=response>Response</h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;rows&#34;</span>:[
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>&#34;timestamp&#34;</span>:<span style=color:#666>0</span>,
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>&#34;catalog&#34;</span>:<span style=color:#ba2121>&#34;horaedb&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>&#34;schema&#34;</span>:<span style=color:#ba2121>&#34;public&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>&#34;table_name&#34;</span>:<span style=color:#ba2121>&#34;my_table&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>&#34;table_id&#34;</span>:<span style=color:#666>3298534886446</span>,
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>&#34;engine&#34;</span>:<span style=color:#ba2121>&#34;Analytic&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span><span>}</span>
</span></span></code></pre></td></tr></table></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-5a18a99c1e89b2e34e598ab36e5b8980>2.4.5 - Table Operation</h1><p>HoraeDB supports standard SQL protocols and allows you to create tables and read/write data via http requests. More <a href=../sql/README.md>SQL</a></p><h2 id=create-table>Create Table</h2><h3 id=example>Example</h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --location --request POST <span style=color:#ba2121>&#39;http://127.0.0.1:5000/sql&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>--header <span style=color:#ba2121>&#39;Content-Type: application/json&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>-d <span style=color:#ba2121>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    &#34;query&#34;: &#34;CREATE TABLE `demo` (`name` string TAG, `value` double NOT NULL, `t` timestamp NOT NULL, TIMESTAMP KEY(t)) ENGINE=Analytic with (enable_ttl=&#39;</span><span style=color:#b62;font-weight:700>\&#39;</span><span style=color:#ba2121>&#39;false&#39;</span><span style=color:#b62;font-weight:700>\&#39;</span><span style=color:#ba2121>&#39;)&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>}&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=write-data>Write Data</h2><h3 id=example-1>Example</h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --location --request POST <span style=color:#ba2121>&#39;http://127.0.0.1:5000/sql&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>--header <span style=color:#ba2121>&#39;Content-Type: application/json&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>-d <span style=color:#ba2121>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    &#34;query&#34;: &#34;INSERT INTO demo(t, name, value) VALUES(1651737067000, &#39;</span><span style=color:#b62;font-weight:700>\&#39;</span><span style=color:#ba2121>&#39;horaedb&#39;</span><span style=color:#b62;font-weight:700>\&#39;</span><span style=color:#ba2121>&#39;, 100)&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>}&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=read-data>Read Data</h2><h3 id=example-2>Example</h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --location --request POST <span style=color:#ba2121>&#39;http://127.0.0.1:5000/sql&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>--header <span style=color:#ba2121>&#39;Content-Type: application/json&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>-d <span style=color:#ba2121>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    &#34;query&#34;: &#34;select * from demo&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>}&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=query-table-info>Query Table Info</h2><h3 id=example-3>Example</h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --location --request POST <span style=color:#ba2121>&#39;http://127.0.0.1:5000/sql&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>--header <span style=color:#ba2121>&#39;Content-Type: application/json&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>-d <span style=color:#ba2121>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    &#34;query&#34;: &#34;show create table demo&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>}&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=drop-table>Drop Table</h3><h3 id=example-4>Example</h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --location --request POST <span style=color:#ba2121>&#39;http://127.0.0.1:5000/sql&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>--header <span style=color:#ba2121>&#39;Content-Type: application/json&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>-d <span style=color:#ba2121>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    &#34;query&#34;: &#34;DROP TABLE demo&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>}&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=route-table>Route Table</h2><h3 id=example-5>Example</h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --location --request GET <span style=color:#ba2121>&#39;http://127.0.0.1:5000/route/{table_name}&#39;</span>
</span></span></code></pre></td></tr></table></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-c93dd709b75734feb3f3eb452bb3638a>2.5 - Ecosystem</h1><p>HoraeDB has an open ecosystem that encourages collaboration and innovation, allowing developers to use what suits them best.</p></div><div class=td-content><h1 id=pg-12941b77e52512197bc3e2eabb976682>2.5.1 - InfluxDB</h1><p><a href=https://www.influxdata.com/products/influxdb-overview/>InfluxDB</a> is a time series database designed to handle high write and query loads. It is an integral component of the TICK stack. InfluxDB is meant to be used as a backing store for any use case involving large amounts of timestamped data, including DevOps monitoring, application metrics, IoT sensor data, and real-time analytics.</p><p>HoraeDB support <a href=https://docs.influxdata.com/influxdb/v1.8/tools/api/#influxdb-1x-http-endpoints>InfluxDB v1.8</a> write and query API.</p><blockquote><p>Warn: users need to add following config to server&rsquo;s config in order to try InfluxDB write/query.</p></blockquote><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[server.default_schema_config]
</span></span><span style=display:flex><span>default_timestamp_column_name = <span style=color:#ba2121>&#34;time&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=write>Write</h1><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -i -XPOST <span style=color:#ba2121>&#34;http://localhost:5440/influxdb/v1/write&#34;</span> --data-binary <span style=color:#ba2121>&#39;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>demo,tag1=t1,tag2=t2 field1=90,field2=100 1679994647000
</span></span></span><span style=display:flex><span><span style=color:#ba2121>demo,tag1=t1,tag2=t2 field1=91,field2=101 1679994648000
</span></span></span><span style=display:flex><span><span style=color:#ba2121>demo,tag1=t11,tag2=t22 field1=90,field2=100 1679994647000
</span></span></span><span style=display:flex><span><span style=color:#ba2121>demo,tag1=t11,tag2=t22 field1=91,field2=101 1679994648000
</span></span></span><span style=display:flex><span><span style=color:#ba2121>&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>Post payload is in <a href=https://docs.influxdata.com/influxdb/v1.8/write_protocols/line_protocol_reference/>InfluxDB line protocol</a> format.</p><p>Measurement will be mapped to table in HoraeDB, and it will be created automatically in first write(Note: The default TTL is 7d, and points written exceed TTL will be discarded directly).</p><p>For example, when inserting data above, table below will be automatically created in HoraeDB:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:green;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>TABLE</span><span style=color:#bbb> </span><span style=color:#666>`</span>demo<span style=color:#666>`</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>`</span>tsid<span style=color:#666>`</span><span style=color:#bbb> </span>uint64<span style=color:#bbb> </span><span style=color:green;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>`</span>time<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>timestamp</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>`</span>field1<span style=color:#666>`</span><span style=color:#bbb> </span>double,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>`</span>field2<span style=color:#666>`</span><span style=color:#bbb> </span>double,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>`</span>tag1<span style=color:#666>`</span><span style=color:#bbb> </span>string<span style=color:#bbb> </span>TAG,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>`</span>tag2<span style=color:#666>`</span><span style=color:#bbb> </span>string<span style=color:#bbb> </span>TAG,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>PRIMARY</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>KEY</span><span style=color:#bbb> </span>(tsid,<span style=color:#bbb> </span>time),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>timestamp</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>KEY</span><span style=color:#bbb> </span>(time))<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=note>Note</h2><ul><li>When InfluxDB writes data, the timestamp precision is nanosecond by default, HoraeDB only supports millisecond timestamp, user can specify the data precision by <code>precision</code> parameter, HoraeDB will automatically convert to millisecond precision internally.</li><li>Query string parameters such as <code>db</code> aren&rsquo;t supported.</li></ul><h1 id=query>Query</h1><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span> curl -G <span style=color:#ba2121>&#39;http://localhost:5440/influxdb/v1/query&#39;</span> --data-urlencode <span style=color:#ba2121>&#39;q=SELECT * FROM &#34;demo&#34;&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>Query result is same with InfluxDB:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;results&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;statement_id&#34;</span>: <span style=color:#666>0</span>,
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;series&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:green;font-weight:700>&#34;name&#34;</span>: <span style=color:#ba2121>&#34;demo&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:green;font-weight:700>&#34;columns&#34;</span>: [<span style=color:#ba2121>&#34;time&#34;</span>, <span style=color:#ba2121>&#34;field1&#34;</span>, <span style=color:#ba2121>&#34;field2&#34;</span>, <span style=color:#ba2121>&#34;tag1&#34;</span>, <span style=color:#ba2121>&#34;tag2&#34;</span>],
</span></span><span style=display:flex><span>          <span style=color:green;font-weight:700>&#34;values&#34;</span>: [
</span></span><span style=display:flex><span>            [<span style=color:#666>1679994647000</span>, <span style=color:#666>90.0</span>, <span style=color:#666>100.0</span>, <span style=color:#ba2121>&#34;t1&#34;</span>, <span style=color:#ba2121>&#34;t2&#34;</span>],
</span></span><span style=display:flex><span>            [<span style=color:#666>1679994647000</span>, <span style=color:#666>90.0</span>, <span style=color:#666>100.0</span>, <span style=color:#ba2121>&#34;t11&#34;</span>, <span style=color:#ba2121>&#34;t22&#34;</span>],
</span></span><span style=display:flex><span>            [<span style=color:#666>1679994648000</span>, <span style=color:#666>91.0</span>, <span style=color:#666>101.0</span>, <span style=color:#ba2121>&#34;t1&#34;</span>, <span style=color:#ba2121>&#34;t2&#34;</span>],
</span></span><span style=display:flex><span>            [<span style=color:#666>1679994648000</span>, <span style=color:#666>91.0</span>, <span style=color:#666>101.0</span>, <span style=color:#ba2121>&#34;t11&#34;</span>, <span style=color:#ba2121>&#34;t22&#34;</span>]
</span></span><span style=display:flex><span>          ]
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=usage-in-grafana>Usage in Grafana</h2><p>HoraeDB can be used as InfluxDB data source in Grafana.</p><ul><li>Select InfluxDB type when add data source</li><li>Then input <code>http://{ip}:{5440}/influxdb/v1/</code> in HTTP URL. For local deployment, URL is http://localhost:5440/influxdb/v1/</li><li><code>Save & test</code></li></ul><h2 id=note-1>Note</h2><p>Query string parameters such as <code>epoch</code>, <code>db</code>, <code>pretty</code> aren&rsquo;t supported.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-1fb5a05253c98bdbe5c288caa145feda>2.5.2 - OpenTSDB</h1><p><a href=http://opentsdb.net/>OpenTSDB</a> is a distributed and scalable time series database based on HBase.</p><h1 id=write>Write</h1><p>HoraeDB follows the <a href=http://opentsdb.net/docs/build/html/api_http/put.html>OpenTSDB put</a> write protocol.</p><p><code>summary</code> and <code>detailed</code> are not yet supported.</p><pre tabindex=0><code>curl --location &#39;http://localhost:5440/opentsdb/api/put&#39; \
--header &#39;Content-Type: application/json&#39; \
-d &#39;[{
    &#34;metric&#34;: &#34;sys.cpu.nice&#34;,
    &#34;timestamp&#34;: 1692588459000,
    &#34;value&#34;: 18,
    &#34;tags&#34;: {
       &#34;host&#34;: &#34;web01&#34;,
       &#34;dc&#34;: &#34;lga&#34;
    }
},
{
    &#34;metric&#34;: &#34;sys.cpu.nice&#34;,
    &#34;timestamp&#34;: 1692588459000,
    &#34;value&#34;: 18,
    &#34;tags&#34;: {
       &#34;host&#34;: &#34;web01&#34;
    }
}]&#39;
&#39;
</code></pre><p>Metric will be mapped to table in HoraeDB, and it will be created automatically in first write(Note: The default TTL is 7d, and points written exceed TTL will be discarded directly).</p><p>For example, when inserting data above, table below will be automatically created in HoraeDB:</p><pre tabindex=0><code>CREATE TABLE `sys.cpu.nice`(
    `tsid` uint64 NOT NULL,
    `timestamp` timestamp NOT NULL,
    `dc` string TAG,
    `host` string TAG,
    `value` bigint,
    PRIMARY KEY(tsid, timestamp),
    TIMESTAMP KEY(timestamp))
    ENGINE = Analytic
    WITH(arena_block_size = &#39;2097152&#39;, compaction_strategy = &#39;default&#39;,
    compression = &#39;ZSTD&#39;, enable_ttl = &#39;true&#39;, num_rows_per_row_group = &#39;8192&#39;,
    segment_duration = &#39;2h&#39;, storage_format = &#39;AUTO&#39;, ttl = &#39;7d&#39;,
    update_mode = &#39;OVERWRITE&#39;, write_buffer_size = &#39;33554432&#39;)
</code></pre><h1 id=query>Query</h1><p>OpenTSDB query protocol is not currently supported, <a href=https://github.com/apache/incubator-horaedb/issues/904>tracking issue</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-136053bf48d308f01c84dea97b7eed0c>2.5.3 - Prometheus</h1><p><a href=https://prometheus.io/>Prometheus</a> is a popular cloud-native monitoring tool that is widely adopted by organizations due to its scalability, reliability, and scalability. It is used to scrape metrics from cloud-native services, such as Kubernetes and OpenShift, and stores it in a time-series database. Prometheus is also easily extensible, allowing users to extend its features and capabilities with other databases.</p><p>HoraeDB can be used as a long-term storage solution for Prometheus. Both remote read and remote write API are supported.</p><h2 id=config>Config</h2><p>You can configure Prometheus to use HoraeDB as a remote storage by adding following lines to <code>prometheus.yml</code>:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:green;font-weight:700>remote_write</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>url</span>:<span style=color:#bbb> </span><span style=color:#ba2121>&#34;http://&lt;address&gt;:&lt;http_port&gt;/prom/v1/write&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>remote_read</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>url</span>:<span style=color:#bbb> </span><span style=color:#ba2121>&#34;http://&lt;address&gt;:&lt;http_port&gt;/prom/v1/read&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>Each metric will be converted to one table in HoraeDB:</p><ul><li>labels are mapped to corresponding <code>string</code> tag column</li><li>timestamp of sample is mapped to a timestamp <code>timestmap</code> column</li><li>value of sample is mapped to a double <code>value</code> column</li></ul><p>For example, <code>up</code> metric below will be mapped to <code>up</code> table:</p><pre tabindex=0><code>up{env=&#34;dev&#34;, instance=&#34;127.0.0.1:9090&#34;, job=&#34;prometheus-server&#34;}
</code></pre><p>Its corresponding table in HoraeDB(Note: The TTL for creating a table is 7d, and points written exceed TTL will be discarded directly):</p><pre tabindex=0><code>CREATE TABLE `up` (
    `timestamp` timestamp NOT NULL,
    `tsid` uint64 NOT NULL,
    `env` string TAG,
    `instance` string TAG,
    `job` string TAG,
    `value` double,
    PRIMARY KEY (tsid, timestamp),
    timestamp KEY (timestamp)
);

SELECT * FROM up;
</code></pre><table><thead><tr><th style=text-align:center>tsid</th><th style=text-align:center>timestamp</th><th style=text-align:center>env</th><th style=text-align:center>instance</th><th style=text-align:center>job</th><th style=text-align:center>value</th></tr></thead><tbody><tr><td style=text-align:center>12683162471309663278</td><td style=text-align:center>1675824740880</td><td style=text-align:center>dev</td><td style=text-align:center>127.0.0.1:9090</td><td style=text-align:center>prometheus-server</td><td style=text-align:center>1</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-cde904b13b4c787d29f40d57853861f5>3 - Development</h1></div><div class=td-content><h1 id=pg-efe75bc5164c17b0dd3f809d1b6dce17>3.1 - Supported Platform</h1><p>作为一个开源的数据库，HoraeDB 可以部署在基于英特尔 /ARM 架构的服务器，以及常见的虚拟环境。</p><table><thead><tr><th style=text-align:center>OS</th><th style=text-align:center>status</th></tr></thead><tbody><tr><td style=text-align:center>Ubuntu LTS 16.06 or later</td><td style=text-align:center>✅</td></tr><tr><td style=text-align:center>CentOS 7.3 or later</td><td style=text-align:center>✅</td></tr><tr><td style=text-align:center>Red Hat Enterprise Linux 7.3 or later 7.x releases</td><td style=text-align:center>✅</td></tr><tr><td style=text-align:center>macOS 11 or later</td><td style=text-align:center>✅</td></tr><tr><td style=text-align:center>Windows</td><td style=text-align:center>❌</td></tr></tbody></table><ul><li>生产环境下 , Linux 是首选平台。</li><li>macOS 主要用在开发环境。</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d093397cbed5d3c7c71c2c5a3d990c59>3.2 - Conventional Commit Guide</h1><p>This document describes how we use <a href=https://www.conventionalcommits.org/en/v1.0.0/>conventional commit</a> in our development.</p><h1 id=structure>Structure</h1><p>We would like to structure our commit message like this:</p><pre tabindex=0><code>&lt;type&gt;[optional scope]: &lt;description&gt;
</code></pre><p>There are three parts. <code>type</code> is used to classify which kind of work this commit does. <code>scope</code> is an optional field that provides additional contextual information. And the last field is your <code>description</code> of this commit.</p><h1 id=type>Type</h1><p>Here we list some common <code>type</code>s and their meanings.</p><ul><li><code>feat</code>: Implement a new feature.</li><li><code>fix</code>: Patch a bug.</li><li><code>docs</code>: Add document or comment.</li><li><code>build</code>: Change the build script or configuration.</li><li><code>style</code>: Style change (only). No logic involved.</li><li><code>refactor</code>: Refactor an existing module for performance, structure, or other reasons.</li><li><code>test</code>: Enhance test coverage or sqlness.</li><li><code>chore</code>: None of the above.</li></ul><h1 id=scope>Scope</h1><p>The <code>scope</code> is more flexible than <code>type</code>. And it may have different values under different <code>type</code>s.</p><p>For example, In a <code>feat</code> or <code>build</code> commit we may use the code module to define scope, like</p><pre tabindex=0><code>feat(cluster):
feat(server):

build(ci):
build(image):
</code></pre><p>And in <code>docs</code> or <code>refactor</code> commits the motivation is prefer to label the <code>scope</code>, like</p><pre tabindex=0><code>docs(comment):
docs(post):

refactor(perf):
refactor(usability):
</code></pre><p>But you don&rsquo;t need to add a scope every time. This isn&rsquo;t mandatory. It&rsquo;s just a way to help describe the commit.</p><h1 id=after-all>After all</h1><p>There are many other rules or scenarios in <a href=https://www.conventionalcommits.org/en/v1.0.0/>conventional commit</a>&rsquo;s website. We are still exploring a better and more friendly workflow. Please do let us know by <a href=https://github.com/apache/incubator-horaedb/issues/new/choose>open an issue</a> if you have any suggestions ❤️</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b43b85bf4c5d805b655422565c67aaee>3.3 - Compile</h1><p>In order to compile HoraeDB, some relevant dependencies(including the <code>Rust</code> toolchain) should be installed.</p><h1 id=dependencies>Dependencies</h1><h2 id=ubuntu>Ubuntu</h2><p>Assuming the development environment is Ubuntu20.04, execute the following command to install the required dependencies:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt install git curl gcc g++ libssl-dev pkg-config protobuf-compiler
</span></span></code></pre></td></tr></table></div></div><h2 id=macos>macOS</h2><p>If the development environment is MacOS, execute the following command to install the required dependencies.</p><ol><li>Install command line tools:</li></ol><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>xcode-select --install
</span></span></code></pre></td></tr></table></div></div><ol start=2><li>Install protobuf:</li></ol><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>brew install protobuf
</span></span></code></pre></td></tr></table></div></div><h1 id=rust>Rust</h1><p><code>Rust</code> can be installed by <a href=https://rustup.rs/>rustup</a>. After installing rustup, when entering the HoraeDB project, the specified <code>Rust</code> version will be automatically downloaded according to the rust-toolchain file.</p><p>After execution, you need to add environment variables to use the <code>Rust</code> toolchain. Basically, just put the following commands into your <code>~/.bashrc</code> or <code>~/.bash_profile</code>:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:green>source</span> <span style=color:#19177c>$HOME</span>/.cargo/env
</span></span></code></pre></td></tr></table></div></div><h1 id=compile-and-run>Compile and Run</h1><h2 id=horaedb-server>horaedb-server</h2><p>Compile horaedb-server by the following command in project root directory:</p><pre tabindex=0><code>cargo build
</code></pre><p>Then you can run it using the default configuration file provided in the codebase.</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./target/debug/horaedb-server --config ./docs/minimal.toml
</span></span></code></pre></td></tr></table></div></div><h1 id=tips>Tips</h1><p>When compiling on macOS, you may encounter following errors:</p><pre tabindex=0><code>IO error: while open a file for lock: /var/folders/jx/grdtrdms0zl3hy6zp251vjh80000gn/T/.tmpmFOAF9/manifest/LOCK: Too many open files

or

error: could not compile `regex-syntax` (lib)
warning: build failed, waiting for other jobs to finish...
LLVM ERROR: IO failure on output stream: File too large
error: could not compile `syn` (lib)
</code></pre><p>To fix those, you should adjust ulimit as follows:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:green>ulimit</span> -n unlimited
</span></span><span style=display:flex><span><span style=color:green>ulimit</span> -f unlimited
</span></span></code></pre></td></tr></table></div></div><h2 id=horaemeta-server>horaemeta-server</h2><p>Building horaemeta-server require Golang version >= 1.21, please <a href=https://go.dev/doc/install>install it</a> before compile.</p><p>Then in <code>horaemeta</code> directory, execute:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go build -o bin/horaemeta-server ./cmd/horaemeta-server/main.go
</span></span></code></pre></td></tr></table></div></div><p>Then you can run horaemeta-server like this:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/horaemeta-server
</span></span></code></pre></td></tr></table></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-aa0192c7ef282112fff2d5b9ef838169>3.4 - Profiling</h1><h3 id=cpu-profiling>CPU profiling</h3><p>HoraeDB provides cpu profiling http api <code>debug/profile/cpu</code>.</p><p>Example:</p><pre tabindex=0><code>// 60s cpu sampling data
curl 0:5000/debug/profile/cpu/60

// Output file path.
/tmp/flamegraph_cpu.svg
</code></pre><h3 id=heap-profiling>Heap profiling</h3><p>HoraeDB provides heap profiling http api <code>debug/profile/heap</code>.</p><h3 id=install-dependencies>Install dependencies</h3><pre tabindex=0><code>sudo yum install -y jemalloc-devel ghostscript graphviz
</code></pre><p>Example:</p><pre tabindex=0><code>// enable malloc prof
export MALLOC_CONF=prof:true

// run horaedb-server
./horaedb-server ....

// 60s cpu sampling data
curl -L &#39;0:5000/debug/profile/heap/60&#39; &gt; /tmp/heap_profile
jeprof --show_bytes --pdf /usr/bin/horaedb-server /tmp/heap_profile &gt; profile_heap.pdf

jeprof --show_bytes --svg /usr/bin/horaedb-server /tmp/heap_profile &gt; profile_heap.svg
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-1248c0925cc367a4f87de9dac846b46d>3.5 - Rationale and Goals</h1><p>As every Rust programmer knows, the language has many powerful features, and there are often
several patterns which can express the same idea. Also, as every professional programmer comes to
discover, code is almost always read far more than it is written.</p><p>Thus, we choose to use a consistent set of idioms throughout our code so that it is easier to read
and understand for both existing and new contributors.</p><h2 id=unsafe-and-platform-dependent-conditional-compilation>Unsafe and Platform-Dependent conditional compilation</h2><h3 id=avoid-unsafe-rust>Avoid <code>unsafe</code> Rust</h3><p>One of the main reasons to use Rust as an implementation language is its strong memory safety
guarantees; Almost all of these guarantees are voided by the use of <code>unsafe</code>. Thus, unless there is
an excellent reason and the use is discussed beforehand, it is unlikely HoraeDB will accept patches
with <code>unsafe</code> code.</p><p>We may consider taking unsafe code given:</p><ul><li>performance benchmarks showing a <em>very</em> compelling improvement</li><li>a compelling explanation of why the same performance can not be achieved using <code>safe</code> code</li><li>tests showing how it works safely across threads</li></ul><h3 id=avoid-platform-specific-conditional-compilation-cfg>Avoid platform-specific conditional compilation <code>cfg</code></h3><p>We hope that HoraeDB is usable across many different platforms and Operating systems, which means we
put a high value on standard Rust.</p><p>While some performance critical code may require architecture specific instructions, (e.g.
<code>AVX512</code>) most of the code should not.</p><h2 id=errors>Errors</h2><h3 id=all-errors-should-follow-the-snafu-crate-philosophyhttpsdocsrssnafu0610snafuguidephilosophyindexhtml-and-use-snafu-functionality>All errors should follow the <a href=https://docs.rs/snafu/0.6.10/snafu/guide/philosophy/index.html>SNAFU crate philosophy</a> and use SNAFU functionality</h3><p><em>Good</em>:</p><ul><li>Derives <code>Snafu</code> and <code>Debug</code> functionality</li><li>Has a useful, end-user-friendly display message</li></ul><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#bc7a00>#[derive(Snafu, Debug)]</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>enum</span> <span style=color:#00f;font-weight:700>Error</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#bc7a00>#[snafu(display(r#</span><span style=color:#ba2121>&#34;Conversion needs at least one line of data&#34;</span><span style=color:#bc7a00>#))]</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>NeedsAtLeastOneLine,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#408080;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>}<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p><em>Bad</em>:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:green;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>enum</span> <span style=color:#00f;font-weight:700>Error</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>NeedsAtLeastOneLine,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#408080;font-style:italic>// ...
</span></span></span></code></pre></td></tr></table></div></div><h3 id=use-the-ensure-macro-to-check-a-condition-and-return-an-error>Use the <code>ensure!</code> macro to check a condition and return an error</h3><p><em>Good</em>:</p><ul><li>Reads more like an <code>assert!</code></li><li>Is more concise</li></ul><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>ensure!(<span style=color:#666>!</span>self.schema_sample.is_empty(),<span style=color:#bbb> </span>NeedsAtLeastOneLine);<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p><em>Bad</em>:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:green;font-weight:700>if</span><span style=color:#bbb> </span>self.schema_sample.is_empty()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>return</span><span style=color:#bbb> </span><span style=color:green>Err</span>(Error::NeedsAtLeastOneLine<span style=color:#bbb> </span>{});<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=errors-should-be-defined-in-the-module-they-are-instantiated>Errors should be defined in the module they are instantiated</h3><p><em>Good</em>:</p><ul><li>Groups related error conditions together most closely with the code that produces them</li><li>Reduces the need to <code>match</code> on unrelated errors that would never happen</li></ul><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#bc7a00>#[derive(Debug, Snafu)]</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>enum</span> <span style=color:#00f;font-weight:700>Error</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#bc7a00>#[snafu(display(</span><span style=color:#ba2121>&#34;Not implemented: {}&#34;</span><span style=color:#bc7a00>, operation_name))]</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>NotImplemented<span style=color:#bbb> </span>{<span style=color:#bbb> </span>operation_name: <span style=color:green>String</span> }<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>ensure!(foo.is_implemented(),<span style=color:#bbb> </span>NotImplemented<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>operation_name: <span style=color:#ba2121>&#34;foo&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p><em>Bad</em>:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:green;font-weight:700>use</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>crate</span>::errors::NotImplemented;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>ensure!(foo.is_implemented(),<span style=color:#bbb> </span>NotImplemented<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>operation_name: <span style=color:#ba2121>&#34;foo&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=the-result-type-alias-should-be-defined-in-each-module>The <code>Result</code> type alias should be defined in each module</h3><p><em>Good</em>:</p><ul><li>Reduces repetition</li></ul><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:green;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>type</span> <span style=color:green>Result</span><span style=color:#666>&lt;</span>T,<span style=color:#bbb> </span>E<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Error<span style=color:#666>&gt;</span><span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>std::result::<span style=color:green>Result</span><span style=color:#666>&lt;</span>T,<span style=color:#bbb> </span>E<span style=color:#666>&gt;</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#666>..</span>.<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>fn</span> <span style=color:#00f>foo</span>()<span style=color:#bbb> </span>-&gt; <span style=color:green>Result</span><span style=color:#666>&lt;</span><span style=color:#b00040>bool</span><span style=color:#666>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb> </span><span style=color:green;font-weight:700>true</span><span style=color:#bbb> </span>}<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p><em>Bad</em>:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#666>..</span>.<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>fn</span> <span style=color:#00f>foo</span>()<span style=color:#bbb> </span>-&gt; <span style=color:green>Result</span><span style=color:#666>&lt;</span><span style=color:#b00040>bool</span>,<span style=color:#bbb> </span>Error<span style=color:#666>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb> </span><span style=color:green;font-weight:700>true</span><span style=color:#bbb> </span>}<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=err-variants-should-be-returned-with-fail><code>Err</code> variants should be returned with <code>fail()</code></h3><p><em>Good</em>:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:green;font-weight:700>return</span><span style=color:#bbb> </span>NotImplemented<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>operation_name: <span style=color:#ba2121>&#34;Parquet format conversion&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}.fail();<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p><em>Bad</em>:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:green;font-weight:700>return</span><span style=color:#bbb> </span><span style=color:green>Err</span>(Error::NotImplemented<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>operation_name: <span style=color:green>String</span>::from(<span style=color:#ba2121>&#34;Parquet format conversion&#34;</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>});<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=use-context-to-wrap-underlying-errors-into-module-specific-errors>Use <code>context</code> to wrap underlying errors into module specific errors</h3><p><em>Good</em>:</p><ul><li>Reduces boilerplate</li></ul><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>input_reader<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.read_to_string(<span style=color:#666>&amp;</span><span style=color:green;font-weight:700>mut</span><span style=color:#bbb> </span>buf)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.context(UnableToReadInput<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>input_filename,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>})<span style=color:#666>?</span>;<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p><em>Bad</em>:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>input_reader<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.read_to_string(<span style=color:#666>&amp;</span><span style=color:green;font-weight:700>mut</span><span style=color:#bbb> </span>buf)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>.map_err(<span style=color:#666>|</span>e<span style=color:#666>|</span><span style=color:#bbb> </span>Error::UnableToReadInput<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>name: <span style=color:green>String</span>::from(input_filename),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>source: <span style=color:#00f;font-weight:700>e</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>})<span style=color:#666>?</span>;<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p><em>Hint for <code>Box&lt;dyn::std::error::Error></code> in Snafu</em>:</p><p>If your error contains a trait object (e.g. <code>Box&lt;dyn std::error::Error + Send + Sync></code>), in order
to use <code>context()</code> you need to wrap the error in a <code>Box</code>, we provide a <code>box_err</code> function to help do this conversion:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#bc7a00>#[derive(Debug, Snafu)]</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>enum</span> <span style=color:#00f;font-weight:700>Error</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#bc7a00>#[snafu(display(</span><span style=color:#ba2121>&#34;gRPC planner got error listing partition keys: {}&#34;</span><span style=color:#bc7a00>, source))]</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>ListingPartitions<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>source: <span style=color:green>Box</span><span style=color:#666>&lt;</span><span style=color:green;font-weight:700>dyn</span><span style=color:#bbb> </span>std::error::Error<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:green>Send</span><span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:green>Sync</span><span style=color:#666>&gt;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#666>..</span>.<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>use</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>use</span><span style=color:#bbb> </span>common_util::error::BoxError;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#408080;font-style:italic>// Wrap error in a box prior to calling context()
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>database<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>.partition_keys()<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>.<span style=color:green;font-weight:700>await</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>.box_err()<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>.context(ListingPartitions)<span style=color:#666>?</span>;<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=each-error-cause-in-a-module-should-have-a-distinct-error-enum-variant>Each error cause in a module should have a distinct <code>Error</code> enum variant</h3><p>Specific error types are preferred over a generic error with a <code>message</code> or <code>kind</code> field.</p><p><em>Good</em>:</p><ul><li>Makes it easier to track down the offending code based on a specific failure</li><li>Reduces the size of the error enum (<code>String</code> is 3x 64-bit vs no space)</li><li>Makes it easier to remove vestigial errors</li><li>Is more concise</li></ul><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#bc7a00>#[derive(Debug, Snafu)]</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>enum</span> <span style=color:#00f;font-weight:700>Error</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#bc7a00>#[snafu(display(</span><span style=color:#ba2121>&#34;Error writing remaining lines {}&#34;</span><span style=color:#bc7a00>, source))]</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>UnableToWriteGoodLines<span style=color:#bbb> </span>{<span style=color:#bbb> </span>source: <span style=color:#00f;font-weight:700>IngestError</span><span style=color:#bbb> </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#bc7a00>#[snafu(display(</span><span style=color:#ba2121>&#34;Error while closing the table writer {}&#34;</span><span style=color:#bc7a00>, source))]</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>UnableToCloseTableWriter<span style=color:#bbb> </span>{<span style=color:#bbb> </span>source: <span style=color:#00f;font-weight:700>IngestError</span><span style=color:#bbb> </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>write_lines.context(UnableToWriteGoodLines)<span style=color:#666>?</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>close_writer.context(UnableToCloseTableWriter))<span style=color:#666>?</span>;<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p><em>Bad</em>:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:green;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>enum</span> <span style=color:#00f;font-weight:700>Error</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#bc7a00>#[snafu(display(</span><span style=color:#ba2121>&#34;Error {}: {}&#34;</span><span style=color:#bc7a00>, message, source))]</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>WritingError<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>source: <span style=color:#00f;font-weight:700>IngestError</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>message: <span style=color:green>String</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>write_lines.context(WritingError<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>message: <span style=color:green>String</span>::from(<span style=color:#ba2121>&#34;Error while writing remaining lines&#34;</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>})<span style=color:#666>?</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>close_writer.context(WritingError<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>message: <span style=color:green>String</span>::from(<span style=color:#ba2121>&#34;Error while closing the table writer&#34;</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>})<span style=color:#666>?</span>;<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=leaf-error-should-contains-backtrace>Leaf error should contains backtrace</h3><p>In order to make debugging easier, leaf errors in error chain should contains a backtrace.</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#408080;font-style:italic>// Error in module A
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>enum</span> <span style=color:#00f;font-weight:700>Error</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#bc7a00>#[snafu(display(</span><span style=color:#ba2121>&#34;This is a leaf error, source:{}.</span><span style=color:#b62;font-weight:700>\n</span><span style=color:#ba2121>Backtrace:</span><span style=color:#b62;font-weight:700>\n</span><span style=color:#ba2121>{}&#34;</span><span style=color:#bc7a00>, source, backtrace))]</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>LeafError<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>source: <span style=color:#00f;font-weight:700>ErrorFromDependency</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>backtrace: <span style=color:#00f;font-weight:700>Backtrace</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#408080;font-style:italic>// Error in module B
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>enum</span> <span style=color:#00f;font-weight:700>Error</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#bc7a00>#[snafu(display(</span><span style=color:#ba2121>&#34;Another error, source:{}.</span><span style=color:#b62;font-weight:700>\n</span><span style=color:#ba2121>Backtrace:</span><span style=color:#b62;font-weight:700>\n</span><span style=color:#ba2121>{}&#34;</span><span style=color:#bc7a00>, source, backtrace))]</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>AnotherError<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#ba2121;font-style:italic>/// This error wraps another error that already has a
</span></span></span><span style=display:flex><span><span style=color:#ba2121;font-style:italic></span><span style=color:#bbb>        </span><span style=color:#ba2121;font-style:italic>/// backtrace. Instead of capturing our own, we forward the
</span></span></span><span style=display:flex><span><span style=color:#ba2121;font-style:italic></span><span style=color:#bbb>        </span><span style=color:#ba2121;font-style:italic>/// request for the backtrace to the inner error. This gives a
</span></span></span><span style=display:flex><span><span style=color:#ba2121;font-style:italic></span><span style=color:#bbb>        </span><span style=color:#ba2121;font-style:italic>/// more accurate backtrace.
</span></span></span><span style=display:flex><span><span style=color:#ba2121;font-style:italic></span><span style=color:#bbb>        </span><span style=color:#bc7a00>#[snafu(backtrace)]</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>source: <span style=color:#00f;font-weight:700>crate</span>::A::Error,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=tests>Tests</h2><h3 id=dont-return-result-from-test-functions>Don&rsquo;t return <code>Result</code> from test functions</h3><p>At the time of this writing, if you return <code>Result</code> from test functions to use <code>?</code> in the test
function body and an <code>Err</code> value is returned, the test failure message is not particularly helpful.
Therefore, prefer not having a return type for test functions and instead using <code>expect</code> or
<code>unwrap</code> in test function bodies.</p><p><em>Good</em>:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#bc7a00>#[test]</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>fn</span> <span style=color:#00f>google_cloud</span>()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>let</span><span style=color:#bbb> </span>config<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Config::new();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>let</span><span style=color:#bbb> </span>integration<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>ObjectStore::new_google_cloud_storage(GoogleCloudStorage::new(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>config.service_account,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>config.bucket,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>));<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>put_get_delete_list(<span style=color:#666>&amp;</span>integration).unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>list_with_delimiter(<span style=color:#666>&amp;</span>integration).unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p><em>Bad</em>:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:green;font-weight:700>type</span> <span style=color:#00f;font-weight:700>TestError</span><span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:green>Box</span><span style=color:#666>&lt;</span><span style=color:green;font-weight:700>dyn</span><span style=color:#bbb> </span>std::error::Error<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:green>Send</span><span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:green>Sync</span><span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:green>&#39;static</span><span style=color:#666>&gt;</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>type</span> <span style=color:green>Result</span><span style=color:#666>&lt;</span>T,<span style=color:#bbb> </span>E<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>TestError<span style=color:#666>&gt;</span><span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>std::result::<span style=color:green>Result</span><span style=color:#666>&lt;</span>T,<span style=color:#bbb> </span>E<span style=color:#666>&gt;</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#bc7a00>#[test]</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>fn</span> <span style=color:#00f>google_cloud</span>()<span style=color:#bbb> </span>-&gt; <span style=color:green>Result</span><span style=color:#666>&lt;</span>()<span style=color:#666>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>let</span><span style=color:#bbb> </span>config<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Config::new();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>let</span><span style=color:#bbb> </span>integration<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>ObjectStore::new_google_cloud_storage(GoogleCloudStorage::new(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>config.service_account,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>config.bucket,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>));<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>put_get_delete_list(<span style=color:#666>&amp;</span>integration)<span style=color:#666>?</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>list_with_delimiter(<span style=color:#666>&amp;</span>integration)<span style=color:#666>?</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green>Ok</span>(())<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=thanks>Thanks</h2><p>Initial version of this doc is forked from <a href=https://github.com/influxdata/influxdb_iox/blob/main/docs/style_guide.md>influxdb_iox</a>, thanks for their hard work.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-998d0585ca29638d7ea6bebdd5056382>3.6 - RoadMap</h1><h3 id=v010>v0.1.0</h3><ul><li><input checked disabled type=checkbox> Standalone version, local storage</li><li><input checked disabled type=checkbox> Analytical storage format</li><li><input checked disabled type=checkbox> Support SQL</li></ul><h3 id=v020>v0.2.0</h3><ul><li><input checked disabled type=checkbox> Distributed version supports static topology defined in config file.</li><li><input checked disabled type=checkbox> The underlying storage supports Aliyun OSS.</li><li><input checked disabled type=checkbox> WAL implementation based on <a href=https://github.com/oceanbase/oceanbase>OBKV</a>.</li></ul><h3 id=v030>v0.3.0</h3><ul><li><input checked disabled type=checkbox> Release multi-language clients, including Java, Rust and Python.</li><li><input checked disabled type=checkbox> Static cluster mode with <code>HoraeMeta</code>.</li><li><input checked disabled type=checkbox> Basic implementation of hybrid storage format.</li></ul><h3 id=v040>v0.4.0</h3><ul><li><input checked disabled type=checkbox> Implement more sophisticated cluster solution that enhances reliability and scalability of HoraeDB.</li><li><input checked disabled type=checkbox> Set up nightly benchmark with TSBS.</li></ul><h3 id=v100-alpha-released>v1.0.0-alpha (Released)</h3><ul><li><input checked disabled type=checkbox> Implement Distributed WAL based on <code>Apache Kafka</code>.</li><li><input checked disabled type=checkbox> Release Golang client.</li><li><input checked disabled type=checkbox> Improve the query performance for classic time series workloads.</li><li><input checked disabled type=checkbox> Support dynamic migration of tables in cluster mode.</li></ul><h3 id=v100>v1.0.0</h3><ul><li><input checked disabled type=checkbox> Formally release HoraeDB and its SDKs with all breaking changes finished.</li><li><input checked disabled type=checkbox> Finish the majority of work related to <code>Table Partitioning</code>.</li><li><input checked disabled type=checkbox> Various efforts to improve query performance, especially for cloud-native cluster mode. These works include:<ul><li>Multi-tier cache.</li><li>Introduce various methods to reduce the data fetched from remote storage (improve the accuracy of SST data filtering).</li><li>Increase the parallelism while fetching data from remote object-store.</li></ul></li><li><input checked disabled type=checkbox> Improve data ingestion performance by introducing resource control over compaction.</li></ul><h3 id=afterwards>Afterwards</h3><p>With an in-depth understanding of the time-series database and its various use cases, the majority of our work will focus on performance, reliability, scalability, ease of use, and collaborations with open-source communities.</p><ul><li><input disabled type=checkbox> Add utilities that support <code>PromQL</code>, <code>InfluxQL</code>, <code>OpenTSDB</code> protocol, and so on.</li><li><input disabled type=checkbox> Provide basic utilities for operation and maintenance. Specifically, the following are included:<ul><li>Deployment tools that fit well for cloud infrastructures like <code>Kubernetes</code>.</li><li>Enhance self-observability, especially critical logs and metrics should be supplemented.</li></ul></li><li><input disabled type=checkbox> Develop various tools that ease the use of HoraeDB. For example, data import and export tools.</li><li><input disabled type=checkbox> Explore new storage formats that will improve performance on hybrid workloads (analytical and time-series workloads).</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-040fc3aac83bad085ea6f9dab4c775ce>3.7 - SDK Development</h1><h2 id=rust>Rust</h2><p><a href=https://github.com/apache/horaedb-client-rs>https://github.com/apache/horaedb-client-rs</a></p><p>First install cargo with</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl https://sh.rustup.rs -sSf | sh
</span></span></code></pre></td></tr></table></div></div><p>Then build with</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cargo build
</span></span></code></pre></td></tr></table></div></div><h2 id=python>Python</h2><p><a href=https://github.com/apache/horaedb-client-py>https://github.com/apache/horaedb-client-py</a></p><h3 id=requirements>Requirements</h3><ul><li>python 3.7+</li></ul><p>The Python SDK rely on Rust SDK, so <a href=https://doc.rust-lang.org/stable/cargo/getting-started/installation.html>cargo</a> is also required, then install build tool <a href=https://github.com/PyO3/maturin>maturin</a>:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip install maturin
</span></span></code></pre></td></tr></table></div></div><p>Then build Python SDK with this:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>maturin build
</span></span></code></pre></td></tr></table></div></div><h2 id=go>Go</h2><p><a href=https://github.com/apache/horaedb-client-go>https://github.com/apache/horaedb-client-go</a></p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go build ./...
</span></span></code></pre></td></tr></table></div></div><h2 id=java>Java</h2><p><a href=https://github.com/apache/horaedb-client-java>https://github.com/apache/horaedb-client-java</a></p><h3 id=requirements-1>Requirements</h3><ul><li>java 1.8</li><li>maven 3.6.3+</li></ul><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mvn clean install -DskipTests<span style=color:#666>=</span><span style=color:green>true</span> -Dmaven.javadoc.skip<span style=color:#666>=</span><span style=color:green>true</span> -B -V
</span></span></code></pre></td></tr></table></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-ddd7fbe6fc5666af530b7ac47a4a5fca>4 - Technical and Design</h1></div><div class=td-content><h1 id=pg-c844952d05d3541d0915cbebea8f4c2a>4.1 - Compaction Offload</h1><p><strong>Note: This feature is still in development.</strong></p><p>This chapter discusses compaction offload, which is designed to separate the compaction workload from the local horaedb nodes and delegate it to external compaction nodes.</p><h2 id=overview>Overview</h2><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>┌─────────────────────────────────────────────────────────────────────────┐
</span></span><span style=display:flex><span>│                                                                         │
</span></span><span style=display:flex><span>│                           HoraeMeta Cluster                             │
</span></span><span style=display:flex><span>│                                                                         │
</span></span><span style=display:flex><span>└─────────────────────────────────────────────────────────────────────────┘
</span></span><span style=display:flex><span>    ▲                ▲                           |                   |
</span></span><span style=display:flex><span>    │                │1.Fetch compaction         │(Monitor compaction│
</span></span><span style=display:flex><span>    │                │  node  info               │node)              │
</span></span><span style=display:flex><span>    |                │                           ▼                   ▼
</span></span><span style=display:flex><span>┌────────────┐  ┌────────────┐              ┌────────────┐   ┌────────────┐
</span></span><span style=display:flex><span>│            │  │            │2.Offload Task│            │   │            │
</span></span><span style=display:flex><span>│  HoraeDB   │  │  HoraeDB   │  ─────────▶  │ Compaction │   │ Compaction │
</span></span><span style=display:flex><span>│            │  │            │  ◀─────────  │ Node       │   │ Node       │
</span></span><span style=display:flex><span>└────────────┘  └────────────┘ 4.Ret Result └────────────┘   └────────────┘
</span></span><span style=display:flex><span>    |                |                            |                 |
</span></span><span style=display:flex><span>    │  5.Update the  │                            │    3.Compact    │
</span></span><span style=display:flex><span>    │    SSTable     │                            │                 │
</span></span><span style=display:flex><span>    ▼                ▼                            ▼                 ▼
</span></span><span style=display:flex><span>┌─────────────────────────────────────────────────────────────────────────┐
</span></span><span style=display:flex><span>│                                                ┌─────────────────────┐  │
</span></span><span style=display:flex><span>│                            Object Storage      │ Temporary Workspace │  │
</span></span><span style=display:flex><span>│                                                └─────────────────────┘  │
</span></span><span style=display:flex><span>└─────────────────────────────────────────────────────────────────────────┘
</span></span></code></pre></td></tr></table></div></div><p>The diagram above describes the architecture of cluster for compaction offload, where some key concepts need to be explained:</p><ul><li><code>Compaction Node</code>: Takes responsibility to handle offloaded compaction tasks. The compaction node receives the compaction task and performs the actual merging of SSTables, then sends back the task result to HoraeDB.</li><li><code>HoraeMeta Cluster</code>: HoraeMeta acts as a compaction nodes manager in the compaction offload scenario. It monitors the compaction nodes cluster and schedule the compaction nodes.</li></ul><p>The procedure of remote compaction based above architecture diagram is:</p><ol><li>HoraeDB servers fetch the information of suitable compaction nodes from the HoraeMeta.</li><li>HoraeDB submit the compaction task to the remote compaction node, according to the information fetched from HoraeMeta.</li><li>Compaction node executes the task and write results to the temporary workspace.</li><li>Compaction node sends compaction results back to HoraeDB.</li><li>HoraeDB receives the result, installs the data in temporary workspace and purges compaction input files.</li></ol><p>The architecture above makes it easy to implement some wonderful features like load balancing and high availability. Let&rsquo;s dive into the key components in the architecture and talking about how these features are implemented.</p><h3 id=compaction-node>Compaction Node</h3><p><code>Compaction Node</code> runs the main logic of compaction. It is implemented based on HoraeDB and distinguished by:</p><ul><li><code>NodeType</code>: A config parameter used to distinguished the <code>HoraeDB</code> and <code>CompactionNode</code>. This info would be sent to HoraeMeta through heartbeat.</li></ul><p>The compaction service is implemented as grpc service.</p><h3 id=horaemeta>HoraeMeta</h3><p><code>HoraeMeta</code> manages the compaction nodes cluster with <code>CompactionNodeManager</code>, which takes responsibilities for compaction nodes metadata management and scheduling.</p><p>The compaction nodes metadata includes:</p><ul><li>Compaction node information, such as node name, node state;</li><li>A compaction node name list, used as the key to access compaction node info, for better scheduling with round-robin strategy;</li><li>&mldr;</li></ul><p>As for the compaction nodes scheduling work, it mainly includes:</p><ul><li>Receiving the heartbeats from the compaction node and determining the online status of these registered nodes.</li><li>Performing load balancing according to the compaction nodes cluster info.</li><li>Providing the info of suitable compaction node for HoraeDB when remote compaction execution is needed.</li></ul><h2 id=load-balancing>Load Balancing</h2><p>Load Balancing is critical for compaction nodes cluster to make their overall processing more efficient. The effect of load balancing mainly based on the schedule algorithm for compaction nodes impl in <code>CompactionNodeManager</code>.</p><p><em>(ps: The current implementation of schedule algorithm is round-robin strategy for easiness.)</em></p><p>The main process for the schedule algorithm based on real load is:</p><ul><li>HoraeMeta collects the compaction nodes load information through the heartbeats to create a load overview of the compaction nodes cluster.</li><li>Pick a compaction node with low load according to the load overview.</li></ul><h2 id=high-availability>High Availability</h2><p>The fault tolerance of above architecture can be achieved by such a procedure:</p><ul><li>When detecting that the heartbeat is broken, <code>HoraeMeta</code> determines that the compaction node is offline.</li><li>When <code>HoraeMeta</code> can not provide suitable compaction node for HoraeDB or compaction node doesn&rsquo;t return the task result successfully, HoraeDB would switches to run compaction task locally.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-9cb1119c134a0f5bde0ea4b1c00fea17>4.2 - Introduction to Architecture of HoraeDB Cluster</h1><p>Note: Some of the features mentioned in the article have not yet been implemented.</p><h2 id=overview>Overview</h2><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>┌───────────────────────────────────────────────────────────────────────┐
</span></span><span style=display:flex><span>│                                                                       │
</span></span><span style=display:flex><span>│                           HoraeMeta Cluster                           │
</span></span><span style=display:flex><span>│                                                                       │
</span></span><span style=display:flex><span>└───────────────────────────────────────────────────────────────────────┘
</span></span><span style=display:flex><span>                              ▲               ▲                 ▲
</span></span><span style=display:flex><span>                              │               │                 │
</span></span><span style=display:flex><span>                              │               │                 │
</span></span><span style=display:flex><span>                              ▼               ▼                 ▼
</span></span><span style=display:flex><span>┌───────┐Route Info ┌HoraeDB─────┬┬─┐ ┌HoraeDB─────┬┬─┐ ┌HoraeDB─────┬┬─┐
</span></span><span style=display:flex><span>│client │◀────────▶ │  │  │TableN││ │ │  │  │TableN││ │ │  │  │TableN││ │
</span></span><span style=display:flex><span>└───────┘Write/Query└──Shard(L)──┴┴─┘ └──Shard(F)──┴┴─┘ └──Shard(F)──┴┴─┘
</span></span><span style=display:flex><span>                            ▲ │                 ▲               ▲
</span></span><span style=display:flex><span>                              │                 │               │
</span></span><span style=display:flex><span>                            │ Write─────────┐   ├────Sync───────┘
</span></span><span style=display:flex><span>                                            │   │
</span></span><span style=display:flex><span>                            │     ┌────────┬▼───┴────┬──────────────────┐
</span></span><span style=display:flex><span>              Upload/Download     │        │         │                  │
</span></span><span style=display:flex><span>                    SST     │     │WAL     │Region N │                  │
</span></span><span style=display:flex><span>                                  │Service │         │                  │
</span></span><span style=display:flex><span>                            │     └────────┴─────────┴──────────────────┘
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                            ▼
</span></span><span style=display:flex><span>┌───────────────────────────────────────────────────────────────────────┐
</span></span><span style=display:flex><span>│                                                                       │
</span></span><span style=display:flex><span>│                            Object Storage                             │
</span></span><span style=display:flex><span>│                                                                       │
</span></span><span style=display:flex><span>└───────────────────────────────────────────────────────────────────────┘
</span></span></code></pre></td></tr></table></div></div><p>The diagram above describes the architecture of a HoraeDB cluster, where some key concepts need to be explained:</p><ul><li><code>HoraeMeta Cluster</code>: Takes responsibilities for managing the metadata and resource scheduling of the cluster;</li><li><code>Shard(L)/Shard(F)</code>: Leader shard and follower shard consisting of multiple tables;</li><li><code>HoraeDB</code>: One HoraeDB instance consisting of multiple shards;</li><li><code>WAL Service</code>: Write-ahead log service for storing new-written real-time data;</li><li><code>Object Storage</code>: Object storage service for storing SST converted from memtable;</li></ul><p>From the architecture diagram above, it can be concluded that the compute and storage are separated in the HoraeDB cluster, which makes it easy to implement useful distributed features, such as elastic autoscaling of compute/storage resources, high availability, load balancing, and so on.</p><p>Let&rsquo;s dive into some of the key components mentioned above before explaining how these features are implemented.</p><h3 id=shard>Shard</h3><p><code>Shard</code> is the basic scheduling unit in the cluster, which consists of a group of tables. And the tables in a shard share the same region for better storage locality in the <code>WAL Service</code>, and because of this, it is efficient to recover the data of all tables in the shard by scanning the entire WAL region. For most of implementations of <code>WAL Service</code>, without the shard concept, it costs a lot to recover the table data one by one due to massive random IO, and this case will deteriorate sharply when the number of tables grows to a certain level.</p><p>A specific role, <code>Leader</code> or <code>Follower</code>, should be assigned to a shard. A pair of leader-follower shards share the same set of tables, and the leader shard can serve the write and query requests from the client while the follower shard can only serve the read-only requests, and must synchronize the newly written data from the WAL service in order to provide the latest snapshot for data retrieval. Actually, the follower is not needed if the high availability is not required, while with at least one follower, it takes only a short time to resume service by simply switching the <code>Follower</code> to <code>Leader</code> when the HoraeDB instance on which the leader shard exists crashes.</p><p>The diagram below concludes the relationship between HoraeDB instance, <code>Shard</code>, <code>Table</code>. As shown in the diagram, the leader and follower shards are interleaved on the HoraeDB instance.</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>┌─HoraeDB Instance0──────┐     ┌─HoraeDB Instance1──────┐
</span></span><span style=display:flex><span>│  ┌─Shard0(L)────────┐  │     │  ┌─Shard0(F)────────┐  │
</span></span><span style=display:flex><span>│  │ ┌────┬────┬────┐ │  │     │  │ ┌────┬────┬────┐ │  │
</span></span><span style=display:flex><span>│  │ │ T0 │ T1 │ T2 │ │  │     │  │ │ T0 │ T1 │ T2 │ │  │
</span></span><span style=display:flex><span>│  │ └────┴────┴────┘ │  │     │  │ └────┴────┴────┘ │  │
</span></span><span style=display:flex><span>│  └──────────────────┘  │     │  └──────────────────┘  │
</span></span><span style=display:flex><span>│                        │     │                        │
</span></span><span style=display:flex><span>│  ┌─Shard1(F)────────┐  │     │  ┌─Shard1(L)────────┐  │
</span></span><span style=display:flex><span>│  │ ┌────┬────┬────┐ │  │     │  │ ┌────┬────┬────┐ │  │
</span></span><span style=display:flex><span>│  │ │ T0 │ T1 │ T2 │ │  │     │  │ │ T0 │ T1 │ T2 │ │  │
</span></span><span style=display:flex><span>│  │ └────┴────┴────┘ │  │     │  │ └────┴────┴────┘ │  │
</span></span><span style=display:flex><span>│  └──────────────────┘  │     │  └──────────────────┘  │
</span></span><span style=display:flex><span>└────────────────────────┘     └────────────────────────┘
</span></span></code></pre></td></tr></table></div></div><p>Since <code>Shard</code> is the basic scheduling unit, it is natural to introduce some basic shard operations:</p><ul><li>Create/Drop table to/from a shard;</li><li>Open/Close a shard;</li><li>Split one shard into two shards;</li><li>Merge two shards into one shard;</li><li>Switch the role of a shard;</li></ul><p>With these basic shard operations, some complex scheduling logic can be implemented, e.g. perform an expansion by splitting one shard into two shards and migrating one of them to the new HoraeDB instance.</p><h3 id=horaemeta>HoraeMeta</h3><p><code>HoraeMeta</code> is implemented by embedding an ETCD inside to ensure consistency and takes responsibilities for cluster metadata management and scheduling.</p><p>The cluster metadata includes:</p><ul><li>Table information, such as table name, table ID, and which cluster the table belongs to;</li><li>The mapping between table and shard and between shard and HoraeDB instance;</li><li>&mldr;</li></ul><p>As for the cluster scheduling work, it mainly includes:</p><ul><li>Receiving the heartbeats from the HoraeDB instances and determining the online status of these registered instances;</li><li>Assigning specific role shards to the registered HoraeDB instances;</li><li>Participating in table creation by assigning a unique table ID and the most appropriate shard to the table;</li><li>Performing load balancing through shard operations according to the load information sent with the heartbeats;</li><li>Performing expansion through shard operations when new instances are registered;</li><li>Initiating failover through shard operations when old instances go offline;</li></ul><h3 id=route>Route</h3><p>In order to avoid the overhead of forwarding requests, the communication between clients and the HoraeDB instances is peer-to-peer, that is to say, the client should retrieve routing information from the server before sending any specific write/query requests.</p><p>Actually, the routing information is decided by the <code>HoraeMeta</code>, but clients are only allowed the access to it through the HoraeDB instances rather than <code>HoraeMeta</code>, to avoid potential performance issues on the <code>HoraeMeta</code>.</p><h3 id=wal-service--object-storage>WAL Service & Object Storage</h3><p>In the HoraeDB cluster, <code>WAL Service</code> and <code>Object Storage</code> exist as separate distributed systems featured with HA, data replication and scalability. Current distributed implementations for <code>WAL Service</code> includes <code>Kafka</code> and <code>OBKV</code> (access <code>OceanBase</code> by its table api), and the implementations for <code>Object Storage</code> include popular object storage services, such as AWS S3, Azure object storage and Aliyun OSS.</p><p>The two components are similar in that they are introduced to serve as the underlying storage layer for separating compute and storage, while the difference between two components is obvious that <code>WAL Service</code> is used to store the newly written data from the real-time write requests whose individual size is small but quantity is large, and <code>Object Storage</code> is used to store the read-friendly data files (SST) organized in the background, whose individual size is large and aggregate size is much larger.</p><p>The two components make it much easier to implement the horaedb cluster, which features horizontal scalability, high availability and load balancing.</p><h2 id=scalability>Scalability</h2><p>Scalability is an important feature for a distributed system. Let&rsquo;s take a look at to how the horizontal scalability of the HoraeDB cluster is achieved.</p><p>First, the two storage components (<code>WAL Service</code> and <code>Object Storage</code>) should be horizontally scalable when deciding on the actual implementations for them, so the two storage services can be expanded separately if the storage capacity is not sufficient.</p><p>It will be a little bit complex when discussing the scalability of the compute service. Basically, these cases will bring the capacity problem:</p><ul><li>Massive queries on massive tables;</li><li>Massive queries on a single large table;</li><li>Massive queries on a normal table;</li></ul><p>For the first case, it is easy to achieve horizontal scalability just by assigning shards that are created or split from old shards to expanded HoraeDB instances.</p><p>For the second case, the table partitioning is proposed and after partitioning, massive queries are distributed across multiple HoraeDB instances.</p><p>And the last case is the most important and the most difficult. Actually, the follower shard can handle part of the queries, but the number of follower shards is limited by the throughput threshold of the synchronization from the WAL regions. As shown in the diagram below, a pure compute shard can be introduced if the followers are not enough to handle the massive queries. Such a shard is not required to synchronize data with the leader shard, and retrieves the newly written data from the leader/follower shard only when the query comes. As for the SSTs required by the query, they will be downloaded from <code>Object Storage</code> and cached afterwards. With the two parts of the data, the compute resources are fully utilized to execute the CPU-intensive query plan. As we can see, such a shard can be added with only a little overhead (retrieving some data from the leader/follower shard when it needs), so to some extent, the horizontal scalability is achieved.</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>                                             ┌HoraeDB─────┬┬─┐
</span></span><span style=display:flex><span>                            ┌──newly written─│  │  │TableN││ │
</span></span><span style=display:flex><span>                            ▼                └──Shard(L/F)┴┴─┘
</span></span><span style=display:flex><span>┌───────┐  Query  ┌HoraeDB─────┬┬─┐
</span></span><span style=display:flex><span>│client │────────▶│  │  │TableN││ │
</span></span><span style=display:flex><span>└───────┘         └──Shard─────┴┴─┘          ┌───────────────┐
</span></span><span style=display:flex><span>                            ▲                │    Object     │
</span></span><span style=display:flex><span>                            └───old SST──────│    Storage    │
</span></span><span style=display:flex><span>                                             └───────────────┘
</span></span></code></pre></td></tr></table></div></div><h2 id=high-availability>High Availability</h2><p>Assuming that <code>WAL service</code> and <code>Object Storage</code> are highly available, the high availability of the HoraeDB cluster can be achieved by such a procedure:</p><ul><li>When detecting that the heartbeat is broken, <code>HoraeMeta</code> determines that the HoraeDB instance is offline;</li><li>The follower shards whose paired leader shards exist on the offline instance are switched to leader shards for fast failover;</li><li>A slow failover can be achieved by opening the crashed shards on another instance if such follower shards don&rsquo;t exist.</li></ul><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>┌─────────────────────────────────────────────────────────┐
</span></span><span style=display:flex><span>│                                                         │
</span></span><span style=display:flex><span>│                    HoraeMeta Cluster                    │
</span></span><span style=display:flex><span>│                                                         │
</span></span><span style=display:flex><span>└─────────────────────────────────────────────────────────┘
</span></span><span style=display:flex><span>                             ▲
</span></span><span style=display:flex><span>             ┌ ─ Heartbeat ─ ┤
</span></span><span style=display:flex><span>                   Broken    │
</span></span><span style=display:flex><span>             │               │
</span></span><span style=display:flex><span>┌ HoraeDB Instance0 ─ ─ ─    │   ┌─HoraeDB Instance1──────┐                   ┌─HoraeDB Instance1──────┐
</span></span><span style=display:flex><span>   ┌─Shard0(L)────────┐  │   │   │  ┌─Shard0(F)────────┐  │                   │  ┌─Shard0(L)────────┐  │
</span></span><span style=display:flex><span>│  │ ┌────┬────┬────┐ │      │   │  │ ┌────┬────┬────┐ │  │                   │  │ ┌────┬────┬────┐ │  │
</span></span><span style=display:flex><span>   │ │ T0 │ T1 │ T2 │ │  │   ├───│  │ │ T0 │ T1 │ T2 │ │  │                   │  │ │ T0 │ T1 │ T2 │ │  │
</span></span><span style=display:flex><span>│  │ └────┴────┴────┘ │      │   │  │ └────┴────┴────┘ │  │                   │  │ └────┴────┴────┘ │  │
</span></span><span style=display:flex><span>   └──────────────────┘  │   │   │  └──────────────────┘  │     Failover      │  └──────────────────┘  │
</span></span><span style=display:flex><span>│                            │   ├─HoraeDB Instance2──────┤   ───────────▶    ├─HoraeDB Instance2──────┤
</span></span><span style=display:flex><span>   ┌─Shard1(L)────────┐  │   │   │  ┌─Shard1(F)────────┐  │                   │  ┌─Shard1(L)────────┐  │
</span></span><span style=display:flex><span>│  │ ┌────┬────┬────┐ │      │   │  │ ┌────┬────┬────┐ │  │                   │  │ ┌────┬────┬────┐ │  │
</span></span><span style=display:flex><span>   │ │ T0 │ T1 │ T2 │ │  │   └───│  │ │ T0 │ T1 │ T2 │ │  │                   │  │ │ T0 │ T1 │ T2 │ │  │
</span></span><span style=display:flex><span>│  │ └────┴────┴────┘ │          │  │ └────┴────┴────┘ │  │                   │  │ └────┴────┴────┘ │  │
</span></span><span style=display:flex><span>   └──────────────────┘  │       │  └──────────────────┘  │                   │  └──────────────────┘  │
</span></span><span style=display:flex><span>└ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─        └────────────────────────┘                   └────────────────────────┘
</span></span></code></pre></td></tr></table></div></div><h2 id=load-balancing>Load Balancing</h2><p>HoraeMeta collects the instance load information contained in the received heartbeats to create a load overview of the whole cluster, according to which the load balancing can be implemented as an automatic mechanism:</p><ul><li>Pick a shard on a low-load instance for the newly created table;</li><li>Migrate a shard from a high-load instance load to another low-load instance;</li><li>Split the large shard on the high-load instance and migrate the split shards to other low-load instances;</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-65252b1200ceedab2612d2d8e8e37aec>4.3 - Introduction to HoraeDB's Architecture</h1><h2 id=target>Target</h2><ul><li>Provide the overview of HoraeDB to the developers who want to know more about HoraeDB but have no idea where to start.</li><li>Make a brief introduction to the important modules of HoraeDB and the connections between these modules but details about their implementations are not be involved.</li></ul><h2 id=motivation>Motivation</h2><p>HoraeDB is a timeseries database (<strong>TSDB</strong>). However, HoraeDB&rsquo;s goal is to handle both timeseries and analytic workloads compared with the classic TSDB, which usually have a poor performance in handling analytic workloads.</p><p>In the classic timeseries database, the <code>Tag</code> columns (InfluxDB calls them <code>Tag</code> and Prometheus calls them <code>Label</code>) are normally indexed by generating an inverted index. However, it is found that the cardinality of <code>Tag</code> varies in different scenarios. And in some scenarios the cardinality of <code>Tag</code> is very high (we name this case after analytic workload), and it takes a very high cost to store and retrieve the inverted index. On the other hand, it is observed that scanning+pruning often used by the analytical databases can do a good job to handle such analytic workload.</p><p>The basic design idea of HoraeDB is to adopt a hybrid storage format and the corresponding query method for a better performance in processing both timeseries and analytic workloads.</p><h2 id=architecture>Architecture</h2><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>┌──────────────────────────────────────────┐
</span></span><span style=display:flex><span>│       RPC Layer (HTTP/gRPC/MySQL)        │
</span></span><span style=display:flex><span>└──────────────────────────────────────────┘
</span></span><span style=display:flex><span>┌──────────────────────────────────────────┐
</span></span><span style=display:flex><span>│                 SQL Layer                │
</span></span><span style=display:flex><span>│ ┌─────────────────┐  ┌─────────────────┐ │
</span></span><span style=display:flex><span>│ │     Parser      │  │     Planner     │ │
</span></span><span style=display:flex><span>│ └─────────────────┘  └─────────────────┘ │
</span></span><span style=display:flex><span>└──────────────────────────────────────────┘
</span></span><span style=display:flex><span>┌───────────────────┐  ┌───────────────────┐
</span></span><span style=display:flex><span>│    Interpreter    │  │      Catalog      │
</span></span><span style=display:flex><span>└───────────────────┘  └───────────────────┘
</span></span><span style=display:flex><span>┌──────────────────────────────────────────┐
</span></span><span style=display:flex><span>│               Query Engine               │
</span></span><span style=display:flex><span>│ ┌─────────────────┐  ┌─────────────────┐ │
</span></span><span style=display:flex><span>│ │    Optimizer    │  │    Executor     │ │
</span></span><span style=display:flex><span>│ └─────────────────┘  └─────────────────┘ │
</span></span><span style=display:flex><span>└──────────────────────────────────────────┘
</span></span><span style=display:flex><span>┌──────────────────────────────────────────┐
</span></span><span style=display:flex><span>│         Pluggable Table Engine           │
</span></span><span style=display:flex><span>│  ┌────────────────────────────────────┐  │
</span></span><span style=display:flex><span>│  │              Analytic              │  │
</span></span><span style=display:flex><span>│  │┌────────────────┐┌────────────────┐│  │
</span></span><span style=display:flex><span>│  ││      Wal       ││    Memtable    ││  │
</span></span><span style=display:flex><span>│  │└────────────────┘└────────────────┘│  │
</span></span><span style=display:flex><span>│  │┌────────────────┐┌────────────────┐│  │
</span></span><span style=display:flex><span>│  ││     Flush      ││   Compaction   ││  │
</span></span><span style=display:flex><span>│  │└────────────────┘└────────────────┘│  │
</span></span><span style=display:flex><span>│  │┌────────────────┐┌────────────────┐│  │
</span></span><span style=display:flex><span>│  ││    Manifest    ││  Object Store  ││  │
</span></span><span style=display:flex><span>│  │└────────────────┘└────────────────┘│  │
</span></span><span style=display:flex><span>│  └────────────────────────────────────┘  │
</span></span><span style=display:flex><span>│  ┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─   │
</span></span><span style=display:flex><span>│           Another Table Engine        │  │
</span></span><span style=display:flex><span>│  └ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─   │
</span></span><span style=display:flex><span>└──────────────────────────────────────────┘
</span></span></code></pre></td></tr></table></div></div><p>The figure above shows the architecture of HoraeDB stand-alone service and the details of some important modules will be described in the following part.</p><h3 id=rpc-layer>RPC Layer</h3><p>module path: <a href=https://github.com/apache/incubator-horaedb/tree/main/server>https://github.com/apache/incubator-horaedb/tree/main/server</a></p><p>The current RPC supports multiple protocols including HTTP, gRPC, MySQL.</p><p>Basically, HTTP and MySQL are used to debug HoraeDB, query manually and perform DDL operations (such as creating, deleting tables, etc.). And gRPC protocol can be regarded as a customized protocol for high-performance, which is suitable for massive reading and writing operations.</p><h3 id=sql-layer>SQL Layer</h3><p>module path: <a href=https://github.com/apache/incubator-horaedb/tree/main/query_frontend>https://github.com/apache/incubator-horaedb/tree/main/query_frontend</a></p><p>SQL layer takes responsibilities for parsing sql and generating the query plan.</p><p>Based on <a href=https://github.com/sqlparser-rs/sqlparser-rs>sqlparser</a> a sql dialect, which introduces some key concepts including <code>Tag</code> and <code>Timestamp</code>, is provided for processing timeseries data. And by utilizing <a href=https://github.com/apache/arrow-datafusion>DataFusion</a> the planner is able to generate both regular logical plans and tailored ones which is used to implement the special operators defined by timeseries queries, e.g <code>PromQL</code>.</p><h3 id=interpreter>Interpreter</h3><p>module path: <a href=https://github.com/apache/incubator-horaedb/tree/main/interpreters>https://github.com/apache/incubator-horaedb/tree/main/interpreters</a></p><p>The <code>Interpreter</code> module encapsulates the SQL <code>CRUD</code> operations. In the query procedure, a sql received by HoraeDB is parsed, converted into the query plan and then executed in some specific interpreter, such as <code>SelectInterpreter</code>, <code>InsertInterpreter</code> and etc.</p><h3 id=catalog>Catalog</h3><p>module path: <a href=https://github.com/apache/incubator-horaedb/tree/main/catalog_impls>https://github.com/apache/incubator-horaedb/tree/main/catalog_impls</a></p><p><code>Catalog</code> is actually the module managing metadata and the levels of metadata adopted by HoraeDB is similar to PostgreSQL: <code>Catalog > Schema > Table</code>, but they are only used as namespace.</p><p>At present, <code>Catalog</code> and <code>Schema</code> have two different kinds of implementation for standalone and distributed mode because some strategies to generate ids and ways to persist metadata differ in different mode.</p><h3 id=query-engine>Query Engine</h3><p>module path: <a href=https://github.com/apache/incubator-horaedb/tree/main/query_engine>https://github.com/apache/incubator-horaedb/tree/main/query_engine</a></p><p><code>Query Engine</code> is responsible for optimizing and executing query plan given a basic SQL plan provided by SQL layer and now such work is mainly delegated to <a href=https://github.com/apache/arrow-datafusion>DataFusion</a>.</p><p>In addition to the basic functions of SQL, HoraeDB also defines some customized query protocols and optimization rules for some specific query plans by utilizing the extensibility provided by <a href=https://github.com/apache/arrow-datafusion>DataFusion</a>. For example, the implementation of <code>PromQL</code> is implemented in this way and read it if you are interested.</p><h3 id=pluggable-table-engine>Pluggable Table Engine</h3><p>module path: <a href=https://github.com/apache/incubator-horaedb/tree/main/table_engine>https://github.com/apache/incubator-horaedb/tree/main/table_engine</a></p><p><code>Table Engine</code> is actually a storage engine for managing tables in HoraeDB and the pluggability of <code>Table Engine</code> is a core design of HoraeDB which matters in achieving our long-term target, e.g supporting handle log or tracing workload by implementing new storage engines. HoraeDB will have multiple kinds of <code>Table Engine</code> for different workloads and the most appropriate one should be chosen as the storage engine according to the workload pattern.</p><p>Now the requirements for a <code>Table Engine</code> are:</p><ul><li>Manage all the shared resources under the engine:<ul><li>Memory</li><li>Storage</li><li>CPU</li></ul></li><li>Manage metadata of tables such as table schema and table options;</li><li>Provide <code>Table</code> instances which provides <code>read</code> and <code>write</code> methods;</li><li>Take responsibilities for creating, opening, dropping and closing <code>Table</code> instance;</li><li>&mldr;.</li></ul><p>Actually the things that a <code>Table Engine</code> needs to process are a little complicated. And now in HoraeDB only one <code>Table Engine</code> called <code>Analytic</code> is provided and does a good job in processing analytical workload, but it is not ready yet to handle the timeseries workload (we plan to enhance it for a better performance by adding some indexes which help handle timeseries workload).</p><p>The following part gives a description about details of <code>Analytic Table Engine</code>.</p><h4 id=wal>WAL</h4><p>module path: <a href=https://github.com/apache/incubator-horaedb/tree/main/wal>https://github.com/apache/incubator-horaedb/tree/main/wal</a></p><p>The model of HoraeDB processing data is <code>WAL</code> + <code>MemTable</code> that the recent written data is written to <code>WAL</code> first and then to <code>MemTable</code> and after a certain amount of data in <code>MemTable</code> is accumulated, the data will be organized in a query-friendly form to persistent devices.</p><p>Now three implementations of <code>WAL</code> are provided for standalone and distributed mode:</p><ul><li>For standalone mode, <code>WAL</code> is based on <code>RocksDB</code> and data is persisted on the local disk.</li><li>For distributed mode, <code>WAL</code> is required as a distributed component and to be responsible for durability of the newly written data, so now we provide an implementation based on <a href=https://github.com/oceanbase/oceanbase>OceanBase</a>.</li><li>For distributed mode, in addition to <a href=https://github.com/oceanbase/oceanbase>OceanBase</a>, we also provide a more lightweight implementation based on <a href=https://github.com/apache/kafka><code>Apache Kafka</code></a>.</li></ul><h4 id=memtable>MemTable</h4><p>module path: <a href=https://github.com/apache/incubator-horaedb/tree/main/analytic_engine/src/memtable>https://github.com/apache/incubator-horaedb/tree/main/analytic_engine/src/memtable</a></p><p>For <code>WAL</code> can&rsquo;t provide efficient data retrieval, the newly written data is also stored in <code>Memtable</code> for efficient data retrieval, after a certain amount of data is reached, HoraeDB organizes the data in <code>MemTable</code> into a query-friendly storage format (<code>SST</code>) and stores it to the persistent device.</p><p>The current implementation of <code>MemTable</code> is based on <a href=https://github.com/tikv/agatedb/blob/8510bff2bfde5b766c3f83cf81c00141967d48a4/skiplist>agatedb&rsquo;s skiplist</a>. It allows concurrent reads and writes and can control memory usage based on <a href=https://github.com/apache/incubator-horaedb/tree/main/components/skiplist>Arena</a>.</p><h4 id=flush>Flush</h4><p>module path: <a href=https://github.com/apache/incubator-horaedb/blob/main/analytic_engine/src/instance/flush_compaction.rs>https://github.com/apache/incubator-horaedb/blob/main/analytic_engine/src/instance/flush_compaction.rs</a></p><p>What <code>Flush</code> does is that when the memory usage of <code>MemTable</code> reaches the threshold, some <code>MemTables</code> are selected for flushing into query-friendly <code>SST</code>s saved on persistent device.</p><p>During the flushing procedure, the data will be divided by a certain time range (which is configured by table option <code>Segment Duration</code>), and any <code>SST</code> is ensured that the timestamps of the data in it are in the same <code>Segment</code>. Actually this is also a common operation in most timeseries databases which organizes data in the time dimension to speed up subsequent time-related operations, such as querying data over a time range and assisting purge data outside the <code>TTL</code>.</p><h4 id=compaction>Compaction</h4><p>module path: <a href=https://github.com/apache/incubator-horaedb/tree/main/analytic_engine/src/compaction>https://github.com/apache/incubator-horaedb/tree/main/analytic_engine/src/compaction</a></p><p>The data of <code>MemTable</code> is flushed as <code>SST</code>s, but the file size of recently flushed <code>SST</code> may be very small. And too small or too many <code>SST</code>s lead to the poor query performance. Therefore, <code>Compaction</code> is then introduced to rearrange the <code>SST</code>s so that the multiple smaller <code>SST</code> files can be compacted into a larger <code>SST</code> file.</p><h4 id=manifest>Manifest</h4><p>module path: <a href=https://github.com/apache/incubator-horaedb/tree/main/analytic_engine/src/meta>https://github.com/apache/incubator-horaedb/tree/main/analytic_engine/src/meta</a></p><p><code>Manifest</code> takes responsibilities for managing tables&rsquo; metadata of <code>Analytic Engine</code> including:</p><ul><li>Table schema and table options;</li><li>The sequence number where the newest flush finishes;</li><li>The information of all the <code>SST</code>s belonging to the table.</li></ul><p>Now the <code>Manifest</code> is based on <code>WAL</code> and <code>Object Storage</code>. The newly written updates on the <code>Manifest</code> are persisted as logs in <code>WAL</code>, and in order to avoid infinite expansion of <code>Manifest</code> (actually every <code>Flush</code> leads to an update), <code>Snapshot</code> is also introduced to clean up the history of metadata updates, and the generated <code>Snapshot</code> will be saved to <code>Object Storage</code>.</p><h4 id=object-storage>Object Storage</h4><p>module path: <a href=https://github.com/apache/incubator-horaedb/tree/main/components/object_store>https://github.com/apache/incubator-horaedb/tree/main/components/object_store</a></p><p>The <code>SST</code> generated by <code>Flush</code> needs to be persisted and the abstraction of the persistent storage device is <code>ObjectStore</code> including multiple implementations:</p><ul><li>Based on local file system;</li><li>Based on <a href=https://www.alibabacloud.com/product/object-storage-service>Alibaba Cloud OSS</a>.</li></ul><p>The distributed architecture of HoraeDB separates storage and computing, which requires <code>Object Store</code> needs to be a highly available and reliable service independent of HoraeDB. Therefore, storage systems like <a href=https://aws.amazon.com/s3/>Amazon S3</a>, <a href=https://www.alibabacloud.com/product/object-storage-service>Alibaba Cloud OSS</a> is a good choice and in the future implementations on storage systems of some other cloud service providers is planned to provide.</p><h4 id=sst>SST</h4><p>module path: <a href=https://github.com/apache/incubator-horaedb/tree/main/analytic_engine/src/sst>https://github.com/apache/incubator-horaedb/tree/main/analytic_engine/src/sst</a></p><p><code>SST</code> is actually an abstraction that can have multiple specific implementations. The current implementation is based on <a href=https://parquet.apache.org/>Parquet</a>, which is a column-oriented data file format designed for efficient data storage and retrieval.</p><p>The format of <code>SST</code> is very critical for retrieving data and is also the most important part to perform well in handling both timeseries and analytic workloads. At present, our <a href=https://parquet.apache.org/>Parquet</a>-based implementation is good at processing analytic workload but is poor at processing timeseries workload. In our roadmap, we will explore more storage formats in order to achieve a good performance in both workloads.</p><h4 id=space>Space</h4><p>module path: <a href=https://github.com/apache/incubator-horaedb/blob/main/analytic_engine/src/space.rs>https://github.com/apache/incubator-horaedb/blob/main/analytic_engine/src/space.rs</a></p><p>In <code>Analytic Engine</code>, there is a concept called <code>space</code> and here is an explanation for it to resolve some ambiguities when read source code. Actually <code>Analytic Engine</code> does not have the concept of <code>catalog</code> and <code>schema</code> and only provides two levels of relationship: <code>space</code> and <code>table</code>. And in the implementation, the <code>schema id</code> (which should be unique across all <code>catalog</code>s) on the upper layer is actually mapped to <code>space id</code>.</p><p>The <code>space</code> in <code>Analytic Engine</code> serves mainly for isolation of resources for different tenants, such as the usage of memory.</p><h2 id=critical-path>Critical Path</h2><p>After a brief introduction to some important modules of HoraeDB, we will give a description for some critical paths in code, hoping to provide interested developers with a guide for reading the code.</p><h3 id=query>Query</h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>┌───────┐      ┌───────┐      ┌───────┐
</span></span><span style=display:flex><span>│       │──1──▶│       │──2──▶│       │
</span></span><span style=display:flex><span>│Server │      │  SQL  │      │Catalog│
</span></span><span style=display:flex><span>│       │◀─10──│       │◀─3───│       │
</span></span><span style=display:flex><span>└───────┘      └───────┘      └───────┘
</span></span><span style=display:flex><span>                │    ▲
</span></span><span style=display:flex><span>               4│   9│
</span></span><span style=display:flex><span>                │    │
</span></span><span style=display:flex><span>                ▼    │
</span></span><span style=display:flex><span>┌─────────────────────────────────────┐
</span></span><span style=display:flex><span>│                                     │
</span></span><span style=display:flex><span>│             Interpreter             │
</span></span><span style=display:flex><span>│                                     │
</span></span><span style=display:flex><span>└─────────────────────────────────────┘
</span></span><span style=display:flex><span>                           │    ▲
</span></span><span style=display:flex><span>                          5│   8│
</span></span><span style=display:flex><span>                           │    │
</span></span><span style=display:flex><span>                           ▼    │
</span></span><span style=display:flex><span>                   ┌──────────────────┐
</span></span><span style=display:flex><span>                   │                  │
</span></span><span style=display:flex><span>                   │   Query Engine   │
</span></span><span style=display:flex><span>                   │                  │
</span></span><span style=display:flex><span>                   └──────────────────┘
</span></span><span style=display:flex><span>                           │    ▲
</span></span><span style=display:flex><span>                          6│   7│
</span></span><span style=display:flex><span>                           │    │
</span></span><span style=display:flex><span>                           ▼    │
</span></span><span style=display:flex><span> ┌─────────────────────────────────────┐
</span></span><span style=display:flex><span> │                                     │
</span></span><span style=display:flex><span> │            Table Engine             │
</span></span><span style=display:flex><span> │                                     │
</span></span><span style=display:flex><span> └─────────────────────────────────────┘
</span></span></code></pre></td></tr></table></div></div><p>Take <code>SELECT</code> SQL as an example. The figure above shows the query procedure and the numbers in it indicates the order of calling between the modules.</p><p>Here are the details:</p><ul><li>Server module chooses a proper rpc module (it may be HTTP, gRPC or mysql) to process the requests according the protocol used by the requests;</li><li>Parse SQL in the request by the parser;</li><li>With the parsed sql and the information provided by catalog/schema module, <a href=https://github.com/apache/arrow-datafusion>DataFusion</a> can generate the logical plan;</li><li>With the logical plan, the corresponding <code>Interpreter</code> is created and logical plan will be executed by it;</li><li>For the logical plan of normal <code>Select</code> SQL, it will be executed through <code>SelectInterpreter</code>;</li><li>In the <code>SelectInterpreter</code> the specific query logic is executed by the <code>Query Engine</code>:<ul><li>Optimize the logical plan;</li><li>Generate the physical plan;</li><li>Optimize the physical plan;</li><li>Execute the physical plan;</li></ul></li><li>The execution of physical plan involves <code>Analytic Engine</code>:<ul><li>Data is obtained by <code>read</code> method of <code>Table</code> instance provided by <code>Analytic Engine</code>;</li><li>The source of the table data is <code>SST</code> and <code>Memtable</code>, and the data can be filtered by the pushed down predicates;</li><li>After retrieving the table data, <code>Query Engine</code> will complete the specific computation and generate the final results;</li></ul></li><li><code>SelectInterpreter</code> gets the results and feeds them to the protocol module;</li><li>After the protocol layer converts the results, the server module responds to the client with them.</li></ul><p>The following is the flow of function calls in version <a href=https://github.com/apache/incubator-horaedb/releases/tag/v1.2.2>v1.2.2</a>:</p><pre tabindex=0><code>                                                       ┌───────────────────────◀─────────────┐    ┌───────────────────────┐
                                                       │      handle_sql       │────────┐    │    │       parse_sql       │
                                                       └───────────────────────┘        │    │    └────────────────┬──────┘
                                                           │             ▲              │    │           ▲         │
                                                           │             │              │    │           │         │
                                                           │             │              │    └36───┐     │        11
                                                          1│             │              │          │     │         │
                                                           │            8│              │          │     │         │
                                                           │             │              │          │    10         │
                                                           │             │              │          │     │         │
                                                           ▼             │              │          │     │         ▼
                                                       ┌─────────────────┴─────┐       9│         ┌┴─────┴────────────────┐───────12─────────▶┌───────────────────────┐
                                                       │maybe_forward_sql_query│        └────────▶│fetch_sql_query_output │                   │   statement_to_plan   │
                                                       └───┬───────────────────┘                  └────┬──────────────────┘◀───────19─────────└───────────────────────┘
                                                           │             ▲                             │              ▲                           │               ▲
                                                           │             │                             │              │                           │               │
                                                           │             │                             │              │                           │               │
                                                           │             │                             │             35                          13              18
                                                          2│            7│                            20              │                           │               │
                                                           │             │                             │              │                           │               │
                                                           │             │                             │              │                           │               │
                                                           │             │                             │              │                           ▼               │
                                                           ▼             │                             ▼              │                       ┌───────────────────────┐
          ┌───────────────────────┐───────────6───────▶┌─────────────────┴─────┐                    ┌─────────────────┴─────┐                 │Planner::statement_to_p│
          │ forward_with_endpoint │                    │        forward        │                    │execute_plan_involving_│                 │          lan          │
          └───────────────────────┘◀────────5──────────└───┬───────────────────┘                 ┌──│    partition_table    │◀────────┐       └───┬───────────────────┘
                                                           │             ▲                       │  └───────────────────────┘         │           │              ▲
                                                           │             │                       │     │              ▲               │           │              │
                                                           │             │                       │     │              │               │          14             17
           ┌───────────────────────┐                       │            4│                       │     │              │               │           │              │
     ┌─────│ PhysicalPlan::execute │                      3│             │                       │    21              │               │           │              │
     │     └───────────────────────┘◀──┐                   │             │                       │     │             22               │           │              │
     │                                 │                   │             │                       │     │              │               │           ▼              │
     │                                 │                   │             │                       │     │              │               │       ┌────────────────────────┐
     │                                 │                   ▼             │                       │     ▼              │              34       │sql_statement_to_datafus│
     │     ┌───────────────────────┐  30               ┌─────────────────┴─────┐                 │  ┌─────────────────┴─────┐         │       │        ion_plan        │
    31     │ build_df_session_ctx  │   │               │         route         │                 │  │   build_interpreter   │         │       └────────────────────────┘
     │     └────┬──────────────────┘   │               └───────────────────────┘                 │  └───────────────────────┘         │           │              ▲
     │          │           ▲          │                                                         │                                    │           │              │
     │         27          26          │                                                        23                                    │          15             16
     │          ▼           │          │                                                         │                                    │           │              │
     └────▶┌────────────────┴──────┐   │               ┌───────────────────────┐                 │                                    │           │              │
           │ execute_logical_plan  ├───┴────32────────▶│       execute         │──────────┐      │   ┌───────────────────────┐        │           ▼              │
           └────┬──────────────────┘◀────────────25────┴───────────────────────┘         33      │   │interpreter_execute_pla│        │       ┌────────────────────────┐
                │           ▲                                           ▲                 └──────┴──▶│           n           │────────┘       │SqlToRel::sql_statement_│
               28           │                                           └──────────24────────────────┴───────────────────────┘                │   to_datafusion_plan   │
                │          29                                                                                                                 └────────────────────────┘
                ▼           │
           ┌────────────────┴──────┐
           │     optimize_plan     │
           └───────────────────────┘
</code></pre><ol><li>The received request will be forwarded to <code>handle_sql</code> after various protocol conversions, and since the request may not be processed by this node, it may need to be forwarded to <code>maybe_forward_sql_query</code> to handle the forwarding logic.</li><li>After constructing the <code>ForwardRequest</code> in <code>maybe_forward_sql_query</code>, call <code>forward</code></li><li>After constructing the <code>RouteRequest</code> in <code>forward</code>, call <code>route</code></li><li>Use <code>route</code> to get the destination node <code>endpoint</code> and return to <code>forward</code>.</li><li>Call <code>forward_with_endpoint</code> to forward the request</li><li>return <code>forward</code></li><li>return <code>maybe_forward_sql_query</code></li><li>return <code>handle_sql</code></li><li>If this is a <code>Local</code> request, call <code>fetch_sql_query_output</code> to process it</li><li>Call <code>parse_sql</code> to parse <code>sql</code> into <code>Statment</code></li><li>return <code>fetch_sql_query_output</code></li><li>Call <code>statement_to_plan</code> with <code>Statment</code></li><li>Construct <code>Planner</code> with <code>ctx</code> and <code>Statment</code>, and call the <code>statement_to_plan</code> method of <code>Planner</code></li><li>The <code>planner</code> will call the corresponding <code>planner</code> method for the requested category, at this point our <code>sql</code> is a query and will call <code>sql_statement_to_plan</code></li><li>Call <code>sql_statement_to_datafusion_plan</code> , which will generate the <code>datafusion</code> object, and then call <code>SqlToRel::sql_statement_to_plan</code></li><li>The generated logical plan is returned from <code>SqlToRel::sql_statement_to_plan</code></li><li>return</li><li>return</li><li>return</li><li>Call <code>execute_plan_involving_partition_table</code> (in the default configuration) for subsequent optimization and execution of this logical plan</li><li>Call <code>build_interpreter</code> to generate <code>Interpreter</code></li><li>return</li><li>Call <code>Interpreter's</code> <code>interpreter_execute_plan</code> method for logical plan execution.</li><li>The corresponding <code>execute</code> function is called, at this time the <code>sql</code> is a query, so the execute of the <code>SelectInterpreter</code> will be called</li><li>call <code>execute_logical_plan</code> , which will call <code>build_df_session_ctx</code> to generate the optimizer</li><li><code>build_df_session_ctx</code> will use the <code>config</code> information to generate the corresponding context, first using datafusion and some custom optimization rules (in logical_optimize_rules()) to generate the logical plan optimizer, using <code>apply_adapters_for_physical_optimize_rules</code> to generate the physical plan optimizer</li><li>return optimizer</li><li>Call <code>optimize_plan</code>, using the optimizer just generated to first optimize the logical plan and then the physical plan</li><li>Return to optimized physical plan</li><li>execute physical plan</li><li>returned after execution</li><li>After collecting the results of all slices, return</li><li>return</li><li>return</li><li>return</li><li>Return to the upper layer for network protocol conversion and finally return to the request sender</li></ol><h3 id=write>Write</h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>┌───────┐      ┌───────┐      ┌───────┐
</span></span><span style=display:flex><span>│       │──1──▶│       │──2──▶│       │
</span></span><span style=display:flex><span>│Server │      │  SQL  │      │Catalog│
</span></span><span style=display:flex><span>│       │◀─8───│       │◀─3───│       │
</span></span><span style=display:flex><span>└───────┘      └───────┘      └───────┘
</span></span><span style=display:flex><span>                │    ▲
</span></span><span style=display:flex><span>               4│   7│
</span></span><span style=display:flex><span>                │    │
</span></span><span style=display:flex><span>                ▼    │
</span></span><span style=display:flex><span>┌─────────────────────────────────────┐
</span></span><span style=display:flex><span>│                                     │
</span></span><span style=display:flex><span>│             Interpreter             │
</span></span><span style=display:flex><span>│                                     │
</span></span><span style=display:flex><span>└─────────────────────────────────────┘
</span></span><span style=display:flex><span>      │    ▲
</span></span><span style=display:flex><span>      │    │
</span></span><span style=display:flex><span>      │    │
</span></span><span style=display:flex><span>      │    │
</span></span><span style=display:flex><span>      │    │       ┌──────────────────┐
</span></span><span style=display:flex><span>      │    │       │                  │
</span></span><span style=display:flex><span>     5│   6│       │   Query Engine   │
</span></span><span style=display:flex><span>      │    │       │                  │
</span></span><span style=display:flex><span>      │    │       └──────────────────┘
</span></span><span style=display:flex><span>      │    │
</span></span><span style=display:flex><span>      │    │
</span></span><span style=display:flex><span>      │    │
</span></span><span style=display:flex><span>      ▼    │
</span></span><span style=display:flex><span> ┌─────────────────────────────────────┐
</span></span><span style=display:flex><span> │                                     │
</span></span><span style=display:flex><span> │            Table Engine             │
</span></span><span style=display:flex><span> │                                     │
</span></span><span style=display:flex><span> └─────────────────────────────────────┘
</span></span></code></pre></td></tr></table></div></div><p>Take <code>INSERT</code> SQL as an example. The figure above shows the query procedure and the numbers in it indicates the order of calling between the modules.</p><p>Here are the details:</p><ul><li>Server module chooses a proper rpc module (it may be HTTP, gRPC or mysql) to process the requests according the protocol used by the requests;</li><li>Parse SQL in the request by the parser;</li><li>With the parsed sql and the catalog/schema module, <a href=https://github.com/apache/arrow-datafusion>DataFusion</a> can generate the logical plan;</li><li>With the logical plan, the corresponding <code>Interpreter</code> is created and logical plan will be executed by it;</li><li>For the logical plan of normal <code>INSERT</code> SQL, it will be executed through <code>InsertInterpreter</code>;</li><li>In the <code>InsertInterpreter</code>, <code>write</code> method of <code>Table</code> provided <code>Analytic Engine</code> is called:<ul><li>Write the data into <code>WAL</code> first;</li><li>Write the data into <code>MemTable</code> then;</li></ul></li><li>Before writing to <code>MemTable</code>, the memory usage will be checked. If the memory usage is too high, the flush process will be triggered:<ul><li>Persist some old MemTables as <code>SST</code>s;</li><li>Store updates about the new <code>SST</code>s and the flushed sequence number of <code>WAL</code> to <code>Manifest</code>;</li><li>Delete the corresponding <code>WAL</code> entries;</li></ul></li><li>Server module responds to the client with the execution result.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-6355ad384a13652a272ba53f173f2c7c>4.4 - Storage</h1><p>The storage engine mainly provides the following two functions：</p><ol><li>Persistence of data</li><li>Under the premise of ensuring the correctness of the data, organize the data in the most reasonable way to meet the query needs of different scenarios.</li></ol><p>This document will introduce the internal implementation of the storage engine in HoraeDB. Readers can refer to the content here to explore how to use HoraeDB efficiently.</p><h1 id=overall-structure>Overall Structure</h1><p>HoraeDB is a distributed storage system based on the share-nothing architecture.</p><p>Data between different servers is isolated from each other and does not affect each other. The storage engine in each stand-alone machine is a variant of <a href=https://en.wikipedia.org/wiki/Log-structured_merge-tree>log-structured merge-tree</a>, which is optimized for time-series scenarios. The following figure shows its core components:</p><p><figure><img src=/images/storage-overview.svg alt loading=lazy></figure></p><h2 id=write-ahead-log-wal>Write Ahead Log (WAL)</h2><p>A write request will be written to</p><ol><li>memtable in memory</li><li>WAL in durable storage</li></ol><p>Since memtable is not persisted to the underlying storage system in real time, so WAL is required to ensure the reliability of the data in memtable.</p><p>On the other hand, due to the design of the <a href=cluster.md>distributed architecture</a>, WAL itself is required to be highly available. Now there are following implementations in HoraeDB:</p><ul><li><a href=/docs/design/wal_on_rocksdb/>Local disk</a> (based on <a href=http://rocksdb.org/>RocksDB</a>, no distributed high availability)</li><li><a href=https://www.oceanbase.com>OceanBase</a></li><li><a href=/docs/design/wal_on_kafka/>Kafka</a></li></ul><h2 id=memtable>Memtable</h2><p>Memtable is a memory data structure used to hold recently written table data. Different tables have its corresponding memtable.</p><p>Memtable is read-write by default (aka active), and when the write reaches some threshold, it will become read-only and be replaced by a new memtable.</p><p>The read-only memtable will be flushed to the underlying storage system in SST format by background thread. After flush is completed, the read-only memtable can be destroyed, and the corresponding data in WAL can also be deleted.</p><h2 id=sorted-string-tablesst>Sorted String Table（SST）</h2><p>SST is a persistent format for data, which is stored in the order of primary keys of table. Currently, HoraeDB uses parquet format for this.</p><p>For HoraeDB, SST has an important option: segment_duration, only SST within the same segment can be merged, which is benefical for time-series data. And it is also convenient to eliminate expired data.</p><p>In addition to storing the original data, the statistical information of the data will also be stored in the SST to speed up the query, such as the maximum value, the minimum value, etc.</p><h2 id=compactor>Compactor</h2><p>Compactor can merge multiple small SST files into one, which is used to solve the problem of too many small files. In addition, Compactor will also delete expired data and duplicate data during the compaction. In future, compaction maybe add more task, such as downsample.</p><p>The current compaction strategy in HoraeDB reference Cassandra:</p><ul><li><a href=https://cassandra.apache.org/doc/latest/cassandra/operating/compaction/stcs.html>SizeTieredCompactionStrategy</a></li><li><a href=https://cassandra.apache.org/doc/latest/cassandra/operating/compaction/twcs.html>TimeWindowCompactionStrategy</a></li></ul><h2 id=manifest>Manifest</h2><p>Manifest records metadata of table, SST file, such as: the minimum and maximum timestamps of the data in an SST.</p><p>Due to the design of the distributed architecture, the manifest itself is required to be highly available. Now in HoraeDB, there are mainly the following implementations：</p><ul><li>WAL</li><li>ObjectStore</li></ul><h2 id=objectstore>ObjectStore</h2><p>ObjectStore is place where data (i.e. SST) is persisted.</p><p>Generally speaking major cloud vendors should provide corresponding services, such as Alibaba Cloud&rsquo;s OSS and AWS&rsquo;s S3.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c9e7f93a52a47c5f64f3865a148a8e7e>4.5 - Table Partitioning</h1><p><strong>Note: This feature is still in development, and the API may change in the future.</strong></p><p>This chapter discusses <code>PartitionTable</code>.</p><p>The partition table syntax used by HoraeDB is similar to that of <a href=https://dev.mysql.com/doc/refman/8.0/en/partitioning-types.html>MySQL</a>.</p><p>General partition tables include <code>Range Partitioning</code>, <code>List Partitoning</code>, <code>Hash Partitioning</code>, and <code>Key Partititioning</code>.</p><p>HoraeDB currently only supports <code>Key Partitioning</code>.</p><h2 id=architecture>Architecture</h2><p>Similar to MySQL, different portions of a partition table are stored as separate tables in different locations.</p><p>Currently designed, a partition table can be opened on multiple HoraeDB nodes, supports writing and querying at the same time, and can be expanded horizontally.</p><p>As shown in the figure below, <code>PartitionTable</code> is opened on node0 and node1, and the physical subtables where the actual data are stored on node2 and node3.</p><pre tabindex=0><code>                        ┌───────────────────────┐      ┌───────────────────────┐
                        │Node0                  │      │Node1                  │
                        │   ┌────────────────┐  │      │  ┌────────────────┐   │
                        │   │ PartitionTable │  │      │  │ PartitionTable │   │
                        │   └────────────────┘  │      │  └────────────────┘   │
                        │            │          │      │           │           │
                        └────────────┼──────────┘      └───────────┼───────────┘
                                     │                             │
                                     │                             │
             ┌───────────────────────┼─────────────────────────────┼───────────────────────┐
             │                       │                             │                       │
┌────────────┼───────────────────────┼─────────────┐ ┌─────────────┼───────────────────────┼────────────┐
│Node2       │                       │             │ │Node3        │                       │            │
│            ▼                       ▼             │ │             ▼                       ▼            │
│ ┌─────────────────────┐ ┌─────────────────────┐  │ │  ┌─────────────────────┐ ┌─────────────────────┐ │
│ │                     │ │                     │  │ │  │                     │ │                     │ │
│ │     SubTable_0      │ │     SubTable_1      │  │ │  │     SubTable_2      │ │     SubTable_3      │ │
│ │                     │ │                     │  │ │  │                     │ │                     │ │
│ └─────────────────────┘ └─────────────────────┘  │ │  └─────────────────────┘ └─────────────────────┘ │
│                                                  │ │                                                  │
└──────────────────────────────────────────────────┘ └──────────────────────────────────────────────────┘
</code></pre><h3 id=key-partitioning>Key Partitioning</h3><p><code>Key Partitioning</code> supports one or more column calculations, using the hash algorithm provided by HoraeDB for calculations.</p><p>Use restrictions:</p><ul><li>Only tag column is supported as partition key.</li><li><code>LINEAR KEY</code> is not supported yet.</li></ul><p>The table creation statement for the key partitioning is as follows:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:green;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>TABLE</span><span style=color:#bbb> </span><span style=color:#666>`</span>demo<span style=color:#666>`</span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>`</span>name<span style=color:#666>`</span>string<span style=color:#bbb> </span>TAG,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>`</span>id<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:green>int</span><span style=color:#bbb> </span>TAG,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>`</span>value<span style=color:#666>`</span><span style=color:#bbb> </span>double<span style=color:#bbb> </span><span style=color:green;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>`</span>t<span style=color:#666>`</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>timestamp</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>TIMESTAMP</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>KEY</span>(t)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>)<span style=color:#bbb> </span>PARTITION<span style=color:#bbb> </span><span style=color:green;font-weight:700>BY</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>KEY</span>(name)<span style=color:#bbb> </span>PARTITIONS<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb> </span>ENGINE<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Analytic<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>Refer to <a href=https://dev.mysql.com/doc/refman/5.7/en/partitioning-key.html>MySQL key partitioning</a>.</p><h2 id=query>Query</h2><p>Since the partition table data is actually stored in different physical tables, it is necessary to calculate the actual requested physical table according to the query request when querying.</p><p>The query will calculate the physical table to be queried according to the query parameters, and then remotely request the node where the physical table is located to obtain data through the HoraeDB internal service <a href=https://github.com/apache/incubator-horaedb/blob/89dca646c627de3cee2133e8f3df96d89854c1a3/server/src/grpc/remote_engine_service/mod.rs>remote engine</a> (support predicate pushdown).</p><p>The implementation of the partition table is in <a href=https://github.com/apache/incubator-horaedb/blob/89dca646c627de3cee2133e8f3df96d89854c1a3/analytic_engine/src/table/partition.rs>PartitionTableImpl</a>.</p><ul><li>Step 1: Parse query sql and calculate the physical table to be queried according to the query parameters.</li><li>Step 2: Query data of physical table.</li><li>Step 3: Compute with the raw data.</li></ul><pre tabindex=0><code>                       │
                     1 │
                       │
                       ▼
               ┌───────────────┐
               │Node0          │
               │               │
               │               │
               └───────────────┘
                       ┬
                2      │       2
        ┌──────────────┴──────────────┐
        │              ▲              │
        │       3      │       3      │
        ▼ ─────────────┴───────────── ▼
┌───────────────┐             ┌───────────────┐
│Node1          │             │Node2          │
│               │             │               │
│               │             │               │
└───────────────┘             └───────────────┘
</code></pre><h3 id=key-partitioning-1>Key partitioning</h3><ul><li>Filters like <code>and</code>, <code>or</code>, <code>in</code>, <code>=</code> will choose specific SubTables.</li><li>Fuzzy matching filters like <code>&lt;</code>, <code>></code> are also supported, but may have poor performance since it will scan all physical tables.</li></ul><p><code>Key partitioning</code> rule is implemented in <a href=https://github.com/apache/incubator-horaedb/blob/89dca646c627de3cee2133e8f3df96d89854c1a3/table_engine/src/partition/rule/key.rs>KeyRule</a>.</p><h2 id=write>Write</h2><p>The write process is similar to the query process.</p><p>First, according to the partition rules, the write request is split into different partitioned physical tables, and then sent to different physical nodes through the remote engine for actual data writing.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-87f506fcaf75ce14798677d99f59d7f6>4.6 - Wal</h1><ul><li><a href=/docs/design/wal_on_rocksdb/>WAL on RocksDB</a></li><li><a href=/docs/design/wal_on_kafka/>WAL on Kafka</a></li><li>WAL on OceanBase will be introduced in later.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-0754b13496965933f1163bf7cf753a30>4.7 - WAL on Disk</h1><h2 id=architecture>Architecture</h2><p>This section introduces the implementation of a standalone Write-Ahead Log (WAL, hereinafter referred to as &ldquo;the log&rdquo;) based on a local disk. In this implementation, the log is managed at the region level.</p><pre tabindex=0><code>            ┌────────────────────────────┐
            │          HoraeDB           │
            │                            │
            │ ┌────────────────────────┐ │
            │ │          WAL           │ │         ┌────────────────────────┐
            │ │                        │ │         │                        │
            │ │         ......         │ │         │      File System       │
            │ │                        │ │         │                        │
            │ │ ┌────────────────────┐ │ │ manage  │ ┌────────────────────┐ │
 Write ─────┼─┼─►       Region       ├─┼─┼─────────┼─►     Region Dir     │ │
            │ │ │                    │ │ │         │ │                    │ │
 Read  ─────┼─┼─►   ┌────────────┐   │ │ │  mmap   │ │ ┌────────────────┐ │ │
            │ │ │   │  Segment 0 ├───┼─┼─┼─────────┼─┼─► Segment File 0 │ │ │
            │ │ │   └────────────┘   │ │ │         │ │ └────────────────┘ │ │
Delete ─────┼─┼─►   ┌────────────┐   │ │ │  mmap   │ │ ┌────────────────┐ │ │
            │ │ │   │  Segment 1 ├───┼─┼─┼─────────┼─┼─► Segment File 1 │ │ │
            │ │ │   └────────────┘   │ │ │         │ │ └────────────────┘ │ │
            │ │ │   ┌────────────┐   │ │ │  mmap   │ │ ┌────────────────┐ │ │
            │ │ │   │  Segment 2 ├───┼─┼─┼─────────┼─┼─► Segment File 2 │ │ │
            │ │ │   └────────────┘   │ │ │         │ │ └────────────────┘ │ │
            │ │ │       ......       │ │ │         │ │       ......       │ │
            │ │ └────────────────────┘ │ │         │ └────────────────────┘ │
            │ │         ......         │ │         │         ......         │
            │ └────────────────────────┘ │         └────────────────────────┘
            └────────────────────────────┘
</code></pre><h2 id=data-model>Data Model</h2><h3 id=file-paths>File Paths</h3><p>Each region has its own directory to manage all segments for that region. The directory is named after the region&rsquo;s ID. Each segment is named using the format <code>seg_&lt;id></code>, with IDs starting from 0 and incrementing.</p><h3 id=segment-format>Segment Format</h3><p>Logs for all tables within a region are stored in segments, arranged in ascending order of sequence numbers. The structure of the segment files is as follows:</p><pre tabindex=0><code>   Segment0            Segment1
┌────────────┐      ┌────────────┐
│ Magic Num  │      │ Magic Num  │
├────────────┤      ├────────────┤
│   Record   │      │   Record   │
├────────────┤      ├────────────┤
│   Record   │      │   Record   │
├────────────┤      ├────────────┤   ....
│   Record   │      │   Record   │
├────────────┤      ├────────────┤
│     ...    │      │     ...    │
│            │      │            │
└────────────┘      └────────────┘
    seg_0               seg_1
</code></pre><p>In memory, each segment stores additional information used for read, write, and delete operations:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:green;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>struct</span> <span style=color:#00f;font-weight:700>Segment</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#ba2121;font-style:italic>/// A hashmap storing both min and max sequence numbers of records within
</span></span></span><span style=display:flex><span><span style=color:#ba2121;font-style:italic></span><span style=color:#bbb>    </span><span style=color:#ba2121;font-style:italic>/// this segment for each `TableId`.
</span></span></span><span style=display:flex><span><span style=color:#ba2121;font-style:italic></span><span style=color:#bbb>    </span>table_ranges: <span style=color:#00f;font-weight:700>HashMap</span><span style=color:#666>&lt;</span>TableId,<span style=color:#bbb> </span>(SequenceNumber,<span style=color:#bbb> </span>SequenceNumber)<span style=color:#666>&gt;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#ba2121;font-style:italic>/// An optional vector of positions within the segment.
</span></span></span><span style=display:flex><span><span style=color:#ba2121;font-style:italic></span><span style=color:#bbb>    </span>record_position: <span style=color:green>Vec</span><span style=color:#666>&lt;</span>Position<span style=color:#666>&gt;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#666>..</span>.<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=log-format>Log Format</h3><p>The log format within a segment is as follows:</p><pre tabindex=0><code>+---------+--------+------------+--------------+--------------+-------+
| version |  crc   |  table id  | sequence num | value length | value |
|  (u8)   | (u32)  |   (u64)    |    (u64)     |     (u32)    |(bytes)|
+---------+--------+------------+--------------+--------------+-------+
</code></pre><p>Field Descriptions:</p><ol><li><p><code>version</code>: Log version number.</p></li><li><p><code>crc</code>: Used to ensure data consistency. Computes the CRC checksum from the table id to the end of the record.</p></li><li><p><code>table id</code>: The unique identifier of the table.</p></li><li><p><code>sequence num</code>: The sequence number of the record.</p></li><li><p><code>value length</code>: The byte length of the value.</p></li><li><p><code>value</code>: The value in the general log format.</p></li></ol><p>The region ID is not stored in the log because it can be obtained from the file path.</p><h2 id=main-processes>Main Processes</h2><h3 id=opening-the-wal>Opening the WAL</h3><ol><li><p>Identify all region directories under the WAL directory.</p></li><li><p>In each region directory, identify all segment files.</p></li><li><p>Open each segment file, traverse all logs within it, record the start and end offsets of each log, and record the minimum and maximum sequence numbers of each <code>TableId</code> in the segment, then close the file.</p></li><li><p>If there is no region directory or there are no segment files under the directory, automatically create the corresponding directory and files.</p></li></ol><h3 id=reading-logs>Reading Logs</h3><ol><li><p>Based on the metadata of the segments, determine all segments involved in the current read operation.</p></li><li><p>Open these segments in order of their IDs from smallest to largest, and decode the raw bytes into logs.</p></li></ol><h3 id=writing-logs>Writing Logs</h3><ol><li><p>Serialize the logs to be written into byte data and append them to the segment file with the largest ID.</p></li><li><p>When a segment is created, it pre-allocates a fixed size of 64MB and will not change dynamically. When the pre-allocated space is used up, a new segment is created, and appending continues in the new segment.</p></li><li><p>After each append, <code>flush</code> is not called immediately; by default, <code>flush</code> is performed every ten writes or when the segment file is closed.</p></li><li><p>Update the segment&rsquo;s metadata <code>table_ranges</code> in memory.</p></li></ol><h3 id=deleting-logs>Deleting Logs</h3><p>Suppose logs in the table with ID <code>table_id</code> and sequence numbers less than <code>seq_num</code> need to be marked as deleted:</p><ol><li><p>Update the <code>table_ranges</code> field of the relevant segments in memory, updating the minimum sequence number of the table to <code>seq_num + 1</code>.</p></li><li><p>If after modification, the minimum sequence number of the table in this segment is greater than the maximum sequence number, remove the table from <code>table_ranges</code>.</p></li><li><p>If a segment&rsquo;s <code>table_ranges</code> is empty and it is not the segment with the largest ID, delete the segment file.</p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-12f8303a42cd1145a4db8658c1b26f87>4.8 - WAL on Kafka</h1><h2 id=architecture>Architecture</h2><p>In this section we present a distributed WAL implementation(based on Kafka). Write-ahead logs(hereinafter referred to as logs) of tables are managed here by region, which can be simply understood as a shared log file of multiple tables.</p><p>As shown in the following figure, regions are mapped to topics(with only one partition) in Kafka. And usually two topics are needed by a region, one is used for storing logs and the other is used for storing metadata.</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>                                                 ┌──────────────────────────┐
</span></span><span style=display:flex><span>                                                 │         Kafka            │
</span></span><span style=display:flex><span>                                                 │                          │
</span></span><span style=display:flex><span>                                                 │         ......           │
</span></span><span style=display:flex><span>                                                 │                          │
</span></span><span style=display:flex><span>                                                 │ ┌─────────────────────┐  │
</span></span><span style=display:flex><span>                                                 │ │      Meta Topic     │  │
</span></span><span style=display:flex><span>                                                 │ │                     │  │
</span></span><span style=display:flex><span>                                         Delete  │ │ ┌─────────────────┐ │  │
</span></span><span style=display:flex><span>               ┌──────────────────────┐  ┌───────┼─┼─►    Partition    │ │  │
</span></span><span style=display:flex><span>               │       HoraeDB        │  │       │ │ │                 │ │  │
</span></span><span style=display:flex><span>               │                      │  │       │ │ └─────────────────┘ │  │
</span></span><span style=display:flex><span>               │ ┌──────────────────┐ │  │       │ │                     │  │
</span></span><span style=display:flex><span>               │ │       WAL        │ │  │       │ └─────────────────────┘  │
</span></span><span style=display:flex><span>               │ │      ......      │ │  │       │                          │
</span></span><span style=display:flex><span>               │ │ ┌──────────────┐ │ │  │       │ ┌──────────────────────┐ │
</span></span><span style=display:flex><span>               │ │ │    Region    │ │ │  │       │ │     Data Topic       │ │
</span></span><span style=display:flex><span>               │ │ │              ├─┼─┼──┘       │ │                      │ │
</span></span><span style=display:flex><span>               | | | ┌──────────┐ │ │ │          │ │ ┌──────────────────┐ │ │
</span></span><span style=display:flex><span>               │ │ │ │ Metadata │ │ │ │          │ │ │    Partition     │ │ │
</span></span><span style=display:flex><span>               │ │ │ └──────────┘ │ │ │    Write │ │ │                  │ │ │
</span></span><span style=display:flex><span>Write ─────────┼─┼─►              ├─┼─┼───┐      │ │ │ ┌──┬──┬──┬──┬──┐ │ │ │
</span></span><span style=display:flex><span>               │ │ │ ┌──────────┐ │ │ │   └──────┼─┼─┼─►  │  │  │  │  ├─┼─┼─┼────┐
</span></span><span style=display:flex><span>               │ │ │ │  Client  │ │ │ │          │ │ │ └──┴──┴──┴──┴──┘ │ │ │    │
</span></span><span style=display:flex><span>Read ◄─────────┼─┼─┤ └──────────┘ │ │ │          │ │ │                  │ │ │    │
</span></span><span style=display:flex><span>               │ │ │              │ │ │          │ │ └──────────────────┘ │ │    │
</span></span><span style=display:flex><span>               │ │ └──▲───────────┘ │ │          │ │                      │ │    │
</span></span><span style=display:flex><span>               │ │    │ ......      │ │          │ └──────────────────────┘ │    │
</span></span><span style=display:flex><span>               │ └────┼─────────────┘ │          │         ......           │    │
</span></span><span style=display:flex><span>               │      │               │          └──────────────────────────┘    │
</span></span><span style=display:flex><span>               └──────┼───────────────┘                                          │
</span></span><span style=display:flex><span>                      │                                                          │
</span></span><span style=display:flex><span>                      │                                                          │
</span></span><span style=display:flex><span>                      │                        Read                              │
</span></span><span style=display:flex><span>                      └──────────────────────────────────────────────────────────┘
</span></span></code></pre></td></tr></table></div></div><h2 id=data-model>Data Model</h2><h3 id=log-format>Log Format</h3><p>The common log format described in <a href=/docs/design/wal_on_rocksdb/>WAL on RocksDB</a> is used here.</p><h3 id=metadata>Metadata</h3><p>Each region will maintain its metadata both in memory and in Kafka, we call it <code>RegionMeta</code> here. It can be thought of as a map, taking table id as a key and <code>TableMeta</code> as a value.
We briefly introduce the variables in <code>TableMeta</code> here:</p><ul><li><code>next_seq_num</code>, the sequence number allocated to the next log entry.</li><li><code>latest_marked_deleted</code>, the last flushed sequence number, all logs in the table with a lower sequence number than it can be removed.</li><li><code>current_high_watermark</code>, the high watermark in the Kafka partition after the last writing of this table.</li><li><code>seq_offset_mapping</code>, mapping from sequence numbers to offsets will be done on every write and will removed to the updated <code>latest_marked_deleted</code> after flushing.</li></ul><pre tabindex=0><code>┌─────────────────────────────────────────┐
│              RegionMeta                 │
│                                         │
│ Map&lt;TableId, TableMeta&gt; table_metas     │
└─────────────────┬───────────────────────┘
                  │
                  │
                  │
                  └─────┐
                        │
                        │
 ┌──────────────────────┴──────────────────────────────┐
 │                       TableMeta                     │
 │                                                     │
 │ SequenceNumber next_seq_num                         │
 │                                                     │
 │ SequenceNumber latest_mark_deleted                  │
 │                                                     │
 │ KafkaOffset high_watermark                          │
 │                                                     │
 │ Map&lt;SequenceNumber, KafkaOffset&gt; seq_offset_mapping │
 └─────────────────────────────────────────────────────┘
</code></pre><h2 id=main-process>Main Process</h2><p>We focus on the main process in one region, following process will be introduced:</p><ul><li>Open or create region.</li><li>Write and read logs.</li><li>Delete logs.</li></ul><h3 id=open-or-create-region>Open or Create Region</h3><h4 id=steps>Steps</h4><ul><li>Search the region in the opened namespace.</li><li>If the region found, the most important thing we need to do is to recover its metadata, we will introduce this later.</li><li>If the region not found and auto creating is defined, just create the corresponding topic in Kafka.</li><li>Add the found or created region to cache, return it afterwards.</li></ul><h4 id=recovery>Recovery</h4><p>As mentioned above, the <code>RegionMeta</code> is actually a map of the <code>TableMeta</code>. So here we will focus on recovering a specific <code>TableMeta</code>, and examples will be given to better illustrate this process.</p><ul><li>First, recover the <code>RegionMeta</code> from snapshot. We will take a snapshot of the <code>RegionMeta</code> in some scenarios (e.g. mark logs deleted, clean logs) and put it to the meta topic. The snapshot is actually the <code>RegionMeta</code> at a particular point in time. When recovering a region, we can use it to avoid scanning all logs in the data topic. The following is the example, we recover from the snapshot taken at the time when Kafka high watermark is 64:</li></ul><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>high watermark in snapshot: 64
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> ┌──────────────────────────────┐
</span></span><span style=display:flex><span> │         RegionMeta           │
</span></span><span style=display:flex><span> │                              │
</span></span><span style=display:flex><span> │          ......              │
</span></span><span style=display:flex><span> │ ┌──────────────────────────┐ │
</span></span><span style=display:flex><span> │ │       TableMeta          │ │
</span></span><span style=display:flex><span> │ │                          │ │
</span></span><span style=display:flex><span> │ │ next_seq_num: 5          │ │
</span></span><span style=display:flex><span> │ │                          │ │
</span></span><span style=display:flex><span> │ │ latest_mark_deleted: 2   │ │
</span></span><span style=display:flex><span> │ │                          │ │
</span></span><span style=display:flex><span> │ │ high_watermark: 32       │ │
</span></span><span style=display:flex><span> │ │                          │ │
</span></span><span style=display:flex><span> │ │ seq_offset_mapping:      │ │
</span></span><span style=display:flex><span> │ │                          │ │
</span></span><span style=display:flex><span> │ │ (2, 16) (3, 16) (4, 31)  │ │
</span></span><span style=display:flex><span> │ └──────────────────────────┘ │
</span></span><span style=display:flex><span> │          ......              │
</span></span><span style=display:flex><span> └──────────────────────────────┘
</span></span></code></pre></td></tr></table></div></div><ul><li>Recovering from logs. After recovering from snapshot, we can continue to recover by scanning logs in data topic from the Kafka high watermark when snapshot is taken, and obviously that avoid scanning the whole data topic. Let&rsquo;s see the example:</li></ul><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>┌────────────────────────────────────┐
</span></span><span style=display:flex><span>│                                    │
</span></span><span style=display:flex><span>│    high_watermark in snapshot: 64  │
</span></span><span style=display:flex><span>│                                    │
</span></span><span style=display:flex><span>│  ┌──────────────────────────────┐  │
</span></span><span style=display:flex><span>│  │         RegionMeta           │  │
</span></span><span style=display:flex><span>│  │                              │  │
</span></span><span style=display:flex><span>│  │          ......              │  │
</span></span><span style=display:flex><span>│  │ ┌──────────────────────────┐ │  │
</span></span><span style=display:flex><span>│  │ │       TableMeta          │ │  │
</span></span><span style=display:flex><span>│  │ │                          │ │  │
</span></span><span style=display:flex><span>│  │ │ next_seq_num: 5          │ │  │                  ┌────────────────────────────────┐
</span></span><span style=display:flex><span>│  │ │                          │ │  │                  │          RegionMeta            │
</span></span><span style=display:flex><span>│  │ │ latest_mark_deleted: 2   │ │  │                  │                                │
</span></span><span style=display:flex><span>│  │ │                          │ │  │                  │            ......              │
</span></span><span style=display:flex><span>│  │ │ high_watermark: 32       │ │  │                  │ ┌────────────────────────────┐ │
</span></span><span style=display:flex><span>│  │ │                          │ │  │                  │ │         TableMeta          │ │
</span></span><span style=display:flex><span>│  │ │ seq_offset_mapping:      │ │  │                  │ │                            │ │
</span></span><span style=display:flex><span>│  │ │                          │ │  │                  │ │ next_seq_num: 8            │ │
</span></span><span style=display:flex><span>│  │ │ (2, 16) (3, 16) (4, 31)  │ │  │                  │ │                            │ │
</span></span><span style=display:flex><span>│  │ └──────────────────────────┘ │  │                  │ │ latest_mark_deleted: 2     │ │
</span></span><span style=display:flex><span>│  │          ......              │  │                  │ │                            │ │
</span></span><span style=display:flex><span>│  └──────────────────────────────┘  ├──────────────────► │ high_watermark: 32         │ │
</span></span><span style=display:flex><span>│                                    │                  │ │                            │ │
</span></span><span style=display:flex><span>│ ┌────────────────────────────────┐ │                  │ │ seq_offset_mapping:        │ │
</span></span><span style=display:flex><span>│ │          Data topic            │ │                  │ │                            │ │
</span></span><span style=display:flex><span>│ │                                │ │                  │ │ (2, 16) (3, 16) (4, 31)    │ │
</span></span><span style=display:flex><span>│ │ ┌────────────────────────────┐ │ │                  │ │                            │ │
</span></span><span style=display:flex><span>│ │ │        Partition           │ │ │                  │ │ (5, 72) (6, 81) (7, 90)    │ │
</span></span><span style=display:flex><span>│ │ │                            │ │ │                  │ │                            │ │
</span></span><span style=display:flex><span>│ │ │ ┌────┬────┬────┬────┬────┐ │ │ │                  │ └────────────────────────────┘ │
</span></span><span style=display:flex><span>│ │ │ │ 64 │ 65 │ ...│ 99 │100 │ │ │ │                  │             ......             │
</span></span><span style=display:flex><span>│ │ │ └────┴────┴────┴────┴────┘ │ │ │                  └────────────────────────────────┘
</span></span><span style=display:flex><span>│ │ │                            │ │ │
</span></span><span style=display:flex><span>│ │ └────────────────────────────┘ │ │
</span></span><span style=display:flex><span>│ │                                │ │
</span></span><span style=display:flex><span>│ └────────────────────────────────┘ │
</span></span><span style=display:flex><span>│                                    │
</span></span><span style=display:flex><span>└────────────────────────────────────┘
</span></span></code></pre></td></tr></table></div></div><h3 id=write-and-read-logs>Write and Read Logs</h3><p>The writing and reading process in a region is simple.</p><p>For writing:</p><ul><li>Open the specified region (auto create it if necessary).</li><li>Put the logs to specified Kafka partition by client.</li><li>Update <code>next_seq_num</code>, <code>current_high_watermark</code> and <code>seq_offset_mapping</code> in corresponding <code>TableMeta</code>.</li></ul><p>For reading:</p><ul><li>Open the specified region.</li><li>Just read all the logs of the region, and the split and replay work will be done by the caller.</li></ul><h3 id=delete-logs>Delete Logs</h3><p>Log deletion can be divided into two steps:</p><ul><li>Mark the logs deleted.</li><li>Do delayed cleaning work periodically in a background thread.</li></ul><h4 id=mark>Mark</h4><ul><li>Update <code>latest_mark_deleted</code> and <code>seq_offset_mapping</code>(just retain the entries whose&rsquo;s sequence >= updated latest_mark_deleted) in <code>TableMeta</code>.</li><li>Maybe we need to make and sync the <code>RegionMeta</code> snapshot to Kafka while dropping table.</li></ul><h4 id=clean>Clean</h4><p>The cleaning logic done in a background thread called cleaner:</p><ul><li>Make <code>RegionMeta</code> snapshot.</li><li>Decide whether to clean the logs based on the snapshot.</li><li>If so, sync the snapshot to Kafka first, then clean the logs.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-a98f50743cbedab55a9aa0f5136cd5ff>4.9 - WAL on RocksDB</h1><h2 id=architecture>Architecture</h2><p>In this section we present a standalone WAL implementation (based on RocksDB). Write-ahead logs(hereinafter referred to as logs) of tables are managed here by table, and we call the corresponding storage data structure <code>TableUnit</code>. All related data (logs or some metadata) is stored in a single column family for simplicity.</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>            ┌───────────────────────────────┐
</span></span><span style=display:flex><span>            │         HoraeDB               │
</span></span><span style=display:flex><span>            │                               │
</span></span><span style=display:flex><span>            │ ┌─────────────────────┐       │
</span></span><span style=display:flex><span>            │ │         WAL         │       │
</span></span><span style=display:flex><span>            │ │                     │       │
</span></span><span style=display:flex><span>            │ │        ......       │       │
</span></span><span style=display:flex><span>            │ │                     │       │
</span></span><span style=display:flex><span>            │ │  ┌────────────────┐ │       │
</span></span><span style=display:flex><span> Write ─────┼─┼──►   TableUnit    │ │Delete │
</span></span><span style=display:flex><span>            │ │  │                │ ◄────── │
</span></span><span style=display:flex><span> Read  ─────┼─┼──► ┌────────────┐ │ │       │
</span></span><span style=display:flex><span>            │ │  │ │ RocksDBRef │ │ │       │
</span></span><span style=display:flex><span>            │ │  │ └────────────┘ │ │       │
</span></span><span style=display:flex><span>            │ │  │                | |       |
</span></span><span style=display:flex><span>            │ │  └────────────────┘ │       │
</span></span><span style=display:flex><span>            │ │        ......       │       │
</span></span><span style=display:flex><span>            │ └─────────────────────┘       │
</span></span><span style=display:flex><span>            │                               │
</span></span><span style=display:flex><span>            └───────────────────────────────┘
</span></span></code></pre></td></tr></table></div></div><h2 id=data-model>Data Model</h2><h3 id=common-log-format>Common Log Format</h3><p>We use the common key and value format here.
Here is the defined key format, and the following is introduction for fields in it:</p><ul><li><code>namespace</code>: multiple instances of WAL can exist for different purposes (e.g. manifest also needs wal). The namespace is used to distinguish them.</li><li><code>region_id</code>: in some WAL implementations we may need to manage logs from multiple tables, region is the concept to describe such a set of table logs. Obviously the region id is the identification of the region.</li><li><code>table_id</code>: identification of the table logs to which they belong.</li><li><code>sequence_num</code>: each login table can be assigned an identifier, called a sequence number here.</li><li><code>version</code>: for compatibility with old and new formats.</li></ul><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>+---------------+----------------+-------------------+--------------------+-------------+
</span></span><span style=display:flex><span>| namespace(u8) | region_id(u64) |   table_id(u64)   |  sequence_num(u64) | version(u8) |
</span></span><span style=display:flex><span>+---------------+----------------+-------------------+--------------------+-------------+
</span></span></code></pre></td></tr></table></div></div><p>Here is the defined value format, <code>version</code> is the same as the key format, <code>payload</code> can be understood as encoded log content.</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>+-------------+----------+
</span></span><span style=display:flex><span>| version(u8) | payload  |
</span></span><span style=display:flex><span>+-------------+----------+
</span></span></code></pre></td></tr></table></div></div><h3 id=metadata>Metadata</h3><p>The metadata here is stored in the same key-value format as the log. Actually only the last flushed sequence is stored in this implementation. Here is the defined metadata key format and field instructions:</p><ul><li><code>namespace</code>, <code>table_id</code>, <code>version</code> are the same as the log format.</li><li><code>key_type</code>, used to define the type of metadata. MaxSeq now defines that metadata of this type will only record the most recently flushed sequence in the table.
Because it is only used in wal on RocksDB, which manages the logs at table level, so there is no region id in this key.</li></ul><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>+---------------+--------------+----------------+-------------+
</span></span><span style=display:flex><span>| namespace(u8) | key_type(u8) | table_id(u64)  | version(u8) |
</span></span><span style=display:flex><span>+---------------+--------------+----------------+-------------+
</span></span></code></pre></td></tr></table></div></div><p>Here is the defined metadata value format, as you can see, just the <code>version</code> and <code>max_seq</code>(flushed sequence) in it:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>+-------------+--------------+
</span></span><span style=display:flex><span>| version(u8) | max_seq(u64) |
</span></span><span style=display:flex><span>+-------------+--------------+
</span></span></code></pre></td></tr></table></div></div><h2 id=main-process>Main Process</h2><ul><li>Open <code>TableUnit</code>:<ul><li>Read the latest log entry of all tables to recover the next sequence numbers of tables mainly.</li><li>Scan the metadata to recover next sequence num as a supplement (because some table has just triggered flush and no new written logs after this, so no logs exists now).</li></ul></li><li>Write and read logs. Just write and read key-value from RocksDB.</li><li>Delete logs. For simplicity It will remove corresponding logs synchronously.</li></ul></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class=td-footer__center>Apache HoraeDB is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.<hr><span class=td-footer__copyright>&copy;
2023&ndash;2024
<span class=td-footer__authors><p>The Apache Software Foundation, Licensed under the Apache License, Version 2.0.</p><p>Apache, the names of Apache projects, and the feather logo are either registered trademarks or trademarks of the Apache Software Foundation in the United States and/or other countries.</p></span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span></div></div><hr><div class="row mx-md-2"><div class=td-footer__center><span class=td-footer__copyright>Found a bug in website? <a href=https://github.com/apache/horaedb-docs/issues/new>Open an issue</a> or <a href=https://github.com/apache/horaedb-docs/pulls>submit a pull request</a> on GitHub.</span></div></div><hr></div></footer></div><script src=/js/main.min.f72d00502781aaf278a14088eb2356b1ba2a05ad698a0c43fe86314d74ceab56.js integrity="sha256-9y0AUCeBqvJ4oUCI6yNWsboqBa1pigxD/oYxTXTOq1Y=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>