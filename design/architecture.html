<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Architecture - HoraeDB Documentation</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../style.css">

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><li class="part-title">Introduction</li><li class="chapter-item "><a href="../about.html"><strong aria-hidden="true">1.</strong> What is HoraeDB</a></li><li class="chapter-item "><a href="../quick_start.html"><strong aria-hidden="true">2.</strong> Quick Start</a></li><li class="chapter-item affix "><li class="part-title">User Guide</li><li class="chapter-item "><a href="../sql/README.html"><strong aria-hidden="true">3.</strong> SQL Syntax</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../sql/model/README.html"><strong aria-hidden="true">3.1.</strong> Data Model</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../sql/model/data_types.html"><strong aria-hidden="true">3.1.1.</strong> Data Types</a></li><li class="chapter-item "><a href="../sql/model/special_columns.html"><strong aria-hidden="true">3.1.2.</strong> Special Columns</a></li></ol></li><li class="chapter-item "><a href="../sql/identifier.html"><strong aria-hidden="true">3.2.</strong> Identifier</a></li><li class="chapter-item "><a href="../sql/ddl/README.html"><strong aria-hidden="true">3.3.</strong> Data Definition Statements</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../sql/ddl/create_table.html"><strong aria-hidden="true">3.3.1.</strong> CREATE TABLE</a></li><li class="chapter-item "><a href="../sql/ddl/alter_table.html"><strong aria-hidden="true">3.3.2.</strong> ALTER TABLE</a></li><li class="chapter-item "><a href="../sql/ddl/drop_table.html"><strong aria-hidden="true">3.3.3.</strong> DROP TABLE</a></li></ol></li><li class="chapter-item "><a href="../sql/dml/README.html"><strong aria-hidden="true">3.4.</strong> Data Manipulation Statements</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../sql/dml/insert.html"><strong aria-hidden="true">3.4.1.</strong> INSERT</a></li><li class="chapter-item "><a href="../sql/dml/select.html"><strong aria-hidden="true">3.4.2.</strong> SELECT</a></li></ol></li><li class="chapter-item "><a href="../sql/utility.html"><strong aria-hidden="true">3.5.</strong> Utility Statements</a></li><li class="chapter-item "><a href="../sql/engine_options.html"><strong aria-hidden="true">3.6.</strong> Engine Options</a></li><li class="chapter-item "><a href="../sql/functions/scalar_functions.html"><strong aria-hidden="true">3.7.</strong> Scalar Functions</a></li><li class="chapter-item "><a href="../sql/functions/aggregate_functions.html"><strong aria-hidden="true">3.8.</strong> Aggregate Functions</a></li></ol></li><li class="chapter-item "><a href="../cluster_deployment/README.html"><strong aria-hidden="true">4.</strong> Cluster Deployment</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../cluster_deployment/platform.html"><strong aria-hidden="true">4.1.</strong> Supported Platform</a></li><li class="chapter-item "><a href="../cluster_deployment/no_meta.html"><strong aria-hidden="true">4.2.</strong> NoMeta Mode</a></li><li class="chapter-item "><a href="../cluster_deployment/with_meta.html"><strong aria-hidden="true">4.3.</strong> WithMeta Mode</a></li></ol></li><li class="chapter-item "><a href="../sdk/README.html"><strong aria-hidden="true">5.</strong> SDK</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../sdk/java.html"><strong aria-hidden="true">5.1.</strong> Java</a></li><li class="chapter-item "><a href="../sdk/go.html"><strong aria-hidden="true">5.2.</strong> Go</a></li><li class="chapter-item "><a href="../sdk/python.html"><strong aria-hidden="true">5.3.</strong> Python</a></li><li class="chapter-item "><a href="../sdk/rust.html"><strong aria-hidden="true">5.4.</strong> Rust</a></li></ol></li><li class="chapter-item "><a href="../operation/README.html"><strong aria-hidden="true">6.</strong> Operation</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../operation/table.html"><strong aria-hidden="true">6.1.</strong> Table</a></li><li class="chapter-item "><a href="../operation/system_table.html"><strong aria-hidden="true">6.2.</strong> System Table</a></li><li class="chapter-item "><a href="../operation/block_list.html"><strong aria-hidden="true">6.3.</strong> Block List</a></li><li class="chapter-item "><a href="../operation/observability.html"><strong aria-hidden="true">6.4.</strong> Observability</a></li><li class="chapter-item "><a href="../operation/horaemeta.html"><strong aria-hidden="true">6.5.</strong> HoraeMeta</a></li></ol></li><li class="chapter-item "><a href="../ecosystem/README.html"><strong aria-hidden="true">7.</strong> Ecosystem</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../ecosystem/prometheus.html"><strong aria-hidden="true">7.1.</strong> Prometheus</a></li><li class="chapter-item "><a href="../ecosystem/influxdb.html"><strong aria-hidden="true">7.2.</strong> InfluxDB</a></li><li class="chapter-item "><a href="../ecosystem/opentsdb.html"><strong aria-hidden="true">7.3.</strong> OpenTSDB</a></li></ol></li><li class="chapter-item "><li class="part-title">Dev Guide</li><li class="chapter-item "><a href="../dev/platform.html"><strong aria-hidden="true">8.</strong> Supported Platform</a></li><li class="chapter-item "><a href="../dev/compile_run.html"><strong aria-hidden="true">9.</strong> Compile and Running</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../dev/profiling.html"><strong aria-hidden="true">9.1.</strong> Profile</a></li></ol></li><li class="chapter-item "><a href="../dev/conventional_commit.html"><strong aria-hidden="true">10.</strong> Conventional Commit</a></li><li class="chapter-item "><a href="../dev/style_guide.html"><strong aria-hidden="true">11.</strong> Style guide</a></li><li class="chapter-item "><a href="../dev/roadmap.html"><strong aria-hidden="true">12.</strong> Roadmap</a></li><li class="chapter-item affix "><li class="part-title">Technical and Design</li><li class="chapter-item expanded "><a href="../design/architecture.html" class="active"><strong aria-hidden="true">13.</strong> Architecture</a></li><li class="chapter-item "><a href="../design/clustering.html"><strong aria-hidden="true">14.</strong> Cluster</a></li><li class="chapter-item "><a href="../design/storage.html"><strong aria-hidden="true">15.</strong> Storage</a></li><li class="chapter-item "><a href="../design/wal.html"><strong aria-hidden="true">16.</strong> WAL</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../design/wal_on_rocksdb.html"><strong aria-hidden="true">16.1.</strong> WAL on RocksDB</a></li><li class="chapter-item "><a href="../design/wal_on_kafka.html"><strong aria-hidden="true">16.2.</strong> WAL on Kafka</a></li></ol></li><li class="chapter-item "><a href="../design/table_partitioning.html"><strong aria-hidden="true">17.</strong> Table Partitioning</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">HoraeDB Documentation</h1>

                    <div class="right-buttons">

                        <button id="lang-toggle" class="icon-button" type="button" title="Change language" aria-label="Change language" aria-haspopup="true" aria-expanded="false" aria-controls="lang-list" >
<!--                             <i class="fa fa-globe"></i> -->
                    <i>
                        <svg t="1675840511805" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2677" width="16" height="16"><path d="M511.573333 85.333333C276.053333 85.333333 85.333333 276.48 85.333333 512s190.72 426.666667 426.24 426.666667C747.52 938.666667 938.666667 747.52 938.666667 512S747.52 85.333333 511.573333 85.333333z m295.68 256h-125.866666a667.733333 667.733333 0 0 0-58.88-151.893333A342.613333 342.613333 0 0 1 807.253333 341.333333zM512 172.373333c35.413333 51.2 63.146667 107.946667 81.493333 168.96h-162.986666c18.346667-61.013333 46.08-117.76 81.493333-168.96zM181.76 597.333333C174.933333 570.026667 170.666667 541.44 170.666667 512s4.266667-58.026667 11.093333-85.333333h144.213333c-3.413333 28.16-5.973333 56.32-5.973333 85.333333 0 29.013333 2.56 57.173333 5.973333 85.333333H181.76z m34.986667 85.333334h125.866666c13.653333 53.333333 33.28 104.533333 58.88 151.893333A340.778667 340.778667 0 0 1 216.746667 682.666667z m125.866666-341.333334H216.746667a340.778667 340.778667 0 0 1 184.746666-151.893333A667.733333 667.733333 0 0 0 342.613333 341.333333zM512 851.626667c-35.413333-51.2-63.146667-107.946667-81.493333-168.96h162.986666c-18.346667 61.013333-46.08 117.76-81.493333 168.96zM611.84 597.333333H412.16c-3.84-28.16-6.826667-56.32-6.826667-85.333333 0-29.013333 2.986667-57.6 6.826667-85.333333h199.68c3.84 27.733333 6.826667 56.32 6.826667 85.333333 0 29.013333-2.986667 57.173333-6.826667 85.333333z m10.666667 237.226667c25.6-47.36 45.226667-98.56 58.88-151.893333h125.866666a342.613333 342.613333 0 0 1-184.746666 151.893333zM698.026667 597.333333c3.413333-28.16 5.973333-56.32 5.973333-85.333333 0-29.013333-2.56-57.173333-5.973333-85.333333h144.213333c6.826667 27.306667 11.093333 55.893333 11.093333 85.333333s-4.266667 58.026667-11.093333 85.333333h-144.213333z" fill="#000000" fill-opacity=".87" p-id="2678"></path></svg>
                        <a id="lang_comment"></a>
                    </i>

                        </button>
                        <ul id="lang-list" class="theme-popup" style="left: auto;" aria-label="Languages" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="en">English</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="cn">中文</button></li>
                        </ul>

                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/apache/incubator-horaedb" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/apache/incubator-horaedb-docs/edit/main/docs/src/en/design/architecture.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <script>
                window.onload = function(){
                    var path_lang = window.location.pathname.split('/')[1];
                    document.getElementById('lang_comment').innerHTML = path_lang=='cn'?"Language":"语言";
                };
                </script>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <h1 id="introduction-to-horaedbs-architecture"><a class="header" href="#introduction-to-horaedbs-architecture">Introduction to HoraeDB's Architecture</a></h1>
<h2 id="target"><a class="header" href="#target">Target</a></h2>
<ul>
<li>Provide the overview of HoraeDB to the developers who want to know more about HoraeDB but have no idea where to start.</li>
<li>Make a brief introduction to the important modules of HoraeDB and the connections between these modules but details about their implementations are not be involved.</li>
</ul>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>HoraeDB is a timeseries database (<strong>TSDB</strong>). However, HoraeDB's goal is to handle both timeseries and analytic workloads compared with the classic TSDB, which usually have a poor performance in handling analytic workloads.</p>
<p>In the classic timeseries database, the <code>Tag</code> columns (InfluxDB calls them <code>Tag</code> and Prometheus calls them <code>Label</code>) are normally indexed by generating an inverted index. However, it is found that the cardinality of <code>Tag</code> varies in different scenarios. And in some scenarios the cardinality of <code>Tag</code> is very high (we name this case after analytic workload), and it takes a very high cost to store and retrieve the inverted index. On the other hand, it is observed that scanning+pruning often used by the analytical databases can do a good job to handle such analytic workload.</p>
<p>The basic design idea of HoraeDB is to adopt a hybrid storage format and the corresponding query method for a better performance in processing both timeseries and analytic workloads.</p>
<h2 id="architecture"><a class="header" href="#architecture">Architecture</a></h2>
<pre><code class="language-plaintext">┌──────────────────────────────────────────┐
│       RPC Layer (HTTP/gRPC/MySQL)        │
└──────────────────────────────────────────┘
┌──────────────────────────────────────────┐
│                 SQL Layer                │
│ ┌─────────────────┐  ┌─────────────────┐ │
│ │     Parser      │  │     Planner     │ │
│ └─────────────────┘  └─────────────────┘ │
└──────────────────────────────────────────┘
┌───────────────────┐  ┌───────────────────┐
│    Interpreter    │  │      Catalog      │
└───────────────────┘  └───────────────────┘
┌──────────────────────────────────────────┐
│               Query Engine               │
│ ┌─────────────────┐  ┌─────────────────┐ │
│ │    Optimizer    │  │    Executor     │ │
│ └─────────────────┘  └─────────────────┘ │
└──────────────────────────────────────────┘
┌──────────────────────────────────────────┐
│         Pluggable Table Engine           │
│  ┌────────────────────────────────────┐  │
│  │              Analytic              │  │
│  │┌────────────────┐┌────────────────┐│  │
│  ││      Wal       ││    Memtable    ││  │
│  │└────────────────┘└────────────────┘│  │
│  │┌────────────────┐┌────────────────┐│  │
│  ││     Flush      ││   Compaction   ││  │
│  │└────────────────┘└────────────────┘│  │
│  │┌────────────────┐┌────────────────┐│  │
│  ││    Manifest    ││  Object Store  ││  │
│  │└────────────────┘└────────────────┘│  │
│  └────────────────────────────────────┘  │
│  ┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─   │
│           Another Table Engine        │  │
│  └ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─   │
└──────────────────────────────────────────┘
</code></pre>
<p>The figure above shows the architecture of HoraeDB stand-alone service and the details of some important modules will be described in the following part.</p>
<h3 id="rpc-layer"><a class="header" href="#rpc-layer">RPC Layer</a></h3>
<p>module path: https://github.com/apache/incubator-horaedb/tree/main/server</p>
<p>The current RPC supports multiple protocols including HTTP, gRPC, MySQL.</p>
<p>Basically, HTTP and MySQL are used to debug HoraeDB, query manually and perform DDL operations (such as creating, deleting tables, etc.). And gRPC protocol can be regarded as a customized protocol for high-performance, which is suitable for massive reading and writing operations.</p>
<h3 id="sql-layer"><a class="header" href="#sql-layer">SQL Layer</a></h3>
<p>module path: https://github.com/apache/incubator-horaedb/tree/main/query_frontend</p>
<p>SQL layer takes responsibilities for parsing sql and generating the query plan.</p>
<p>Based on <a href="https://github.com/sqlparser-rs/sqlparser-rs">sqlparser</a> a sql dialect, which introduces some key concepts including <code>Tag</code> and <code>Timestamp</code>, is provided for processing timeseries data. And by utilizing <a href="https://github.com/apache/arrow-datafusion">DataFusion</a> the planner is able to generate both regular logical plans and tailored ones which is used to implement the special operators defined by timeseries queries, e.g <code>PromQL</code>.</p>
<h3 id="interpreter"><a class="header" href="#interpreter">Interpreter</a></h3>
<p>module path: https://github.com/apache/incubator-horaedb/tree/main/interpreters</p>
<p>The <code>Interpreter</code> module encapsulates the SQL <code>CRUD</code> operations. In the query procedure, a sql received by HoraeDB is parsed, converted into the query plan and then executed in some specific interpreter, such as <code>SelectInterpreter</code>, <code>InsertInterpreter</code> and etc.</p>
<h3 id="catalog"><a class="header" href="#catalog">Catalog</a></h3>
<p>module path: https://github.com/apache/incubator-horaedb/tree/main/catalog_impls</p>
<p><code>Catalog</code> is actually the module managing metadata and the levels of metadata adopted by HoraeDB is similar to PostgreSQL: <code>Catalog &gt; Schema &gt; Table</code>, but they are only used as namespace.</p>
<p>At present, <code>Catalog</code> and <code>Schema</code> have two different kinds of implementation for standalone and distributed mode because some strategies to generate ids and ways to persist metadata differ in different mode.</p>
<h3 id="query-engine"><a class="header" href="#query-engine">Query Engine</a></h3>
<p>module path: https://github.com/apache/incubator-horaedb/tree/main/query_engine</p>
<p><code>Query Engine</code> is responsible for optimizing and executing query plan given a basic SQL plan provided by SQL layer and now such work is mainly delegated to <a href="https://github.com/apache/arrow-datafusion">DataFusion</a>.</p>
<p>In addition to the basic functions of SQL, HoraeDB also defines some customized query protocols and optimization rules for some specific query plans by utilizing the extensibility provided by <a href="https://github.com/apache/arrow-datafusion">DataFusion</a>. For example, the implementation of <code>PromQL</code> is implemented in this way and read it if you are interested.</p>
<h3 id="pluggable-table-engine"><a class="header" href="#pluggable-table-engine">Pluggable Table Engine</a></h3>
<p>module path: https://github.com/apache/incubator-horaedb/tree/main/table_engine</p>
<p><code>Table Engine</code> is actually a storage engine for managing tables in HoraeDB and the pluggability of <code>Table Engine</code> is a core design of HoraeDB which matters in achieving our long-term target, e.g supporting handle log or tracing workload by implementing new storage engines. HoraeDB will have multiple kinds of <code>Table Engine</code> for different workloads and the most appropriate one should be chosen as the storage engine according to the workload pattern.</p>
<p>Now the requirements for a <code>Table Engine</code> are:</p>
<ul>
<li>Manage all the shared resources under the engine:
<ul>
<li>Memory</li>
<li>Storage</li>
<li>CPU</li>
</ul>
</li>
<li>Manage metadata of tables such as table schema and table options;</li>
<li>Provide <code>Table</code> instances which provides <code>read</code> and <code>write</code> methods;</li>
<li>Take responsibilities for creating, opening, dropping and closing <code>Table</code> instance;</li>
<li>....</li>
</ul>
<p>Actually the things that a <code>Table Engine</code> needs to process are a little complicated. And now in HoraeDB only one <code>Table Engine</code> called <code>Analytic</code> is provided and does a good job in processing analytical workload, but it is not ready yet to handle the timeseries workload (we plan to enhance it for a better performance by adding some indexes which help handle timeseries workload).</p>
<p>The following part gives a description about details of <code>Analytic Table Engine</code>.</p>
<h4 id="wal"><a class="header" href="#wal">WAL</a></h4>
<p>module path: https://github.com/apache/incubator-horaedb/tree/main/wal</p>
<p>The model of HoraeDB processing data is <code>WAL</code> + <code>MemTable</code> that the recent written data is written to <code>WAL</code> first and then to <code>MemTable</code> and after a certain amount of data in <code>MemTable</code> is accumulated, the data will be organized in a query-friendly form to persistent devices.</p>
<p>Now three implementations of <code>WAL</code> are provided for standalone and distributed mode:</p>
<ul>
<li>For standalone mode, <code>WAL</code> is based on <code>RocksDB</code> and data is persisted on the local disk.</li>
<li>For distributed mode, <code>WAL</code> is required as a distributed component and to be responsible for durability of the newly written data, so now we provide an implementation based on <a href="https://github.com/oceanbase/oceanbase">OceanBase</a>.</li>
<li>For distributed mode, in addition to <a href="https://github.com/oceanbase/oceanbase">OceanBase</a>, we also provide a more lightweight implementation based on <a href="https://github.com/apache/kafka"><code>Apache Kafka</code></a>.</li>
</ul>
<h4 id="memtable"><a class="header" href="#memtable">MemTable</a></h4>
<p>module path: https://github.com/apache/incubator-horaedb/tree/main/analytic_engine/src/memtable</p>
<p>For <code>WAL</code> can't provide efficient data retrieval, the newly written data is also stored in <code>Memtable</code> for efficient data retrieval, after a certain amount of data is reached, HoraeDB organizes the data in <code>MemTable</code> into a query-friendly storage format (<code>SST</code>) and stores it to the persistent device.</p>
<p>The current implementation of <code>MemTable</code> is based on <a href="https://github.com/tikv/agatedb/blob/8510bff2bfde5b766c3f83cf81c00141967d48a4/skiplist">agatedb's skiplist</a>. It allows concurrent reads and writes and can control memory usage based on <a href="https://github.com/apache/incubator-horaedb/tree/main/components/skiplist">Arena</a>.</p>
<h4 id="flush"><a class="header" href="#flush">Flush</a></h4>
<p>module path: https://github.com/apache/incubator-horaedb/blob/main/analytic_engine/src/instance/flush_compaction.rs</p>
<p>What <code>Flush</code> does is that when the memory usage of <code>MemTable</code> reaches the threshold, some <code>MemTables</code> are selected for flushing into query-friendly <code>SST</code>s saved on persistent device.</p>
<p>During the flushing procedure, the data will be divided by a certain time range (which is configured by table option <code>Segment Duration</code>), and any <code>SST</code> is ensured that the timestamps of the data in it are in the same <code>Segment</code>. Actually this is also a common operation in most timeseries databases which organizes data in the time dimension to speed up subsequent time-related operations, such as querying data over a time range and assisting purge data outside the <code>TTL</code>.</p>
<h4 id="compaction"><a class="header" href="#compaction">Compaction</a></h4>
<p>module path: https://github.com/apache/incubator-horaedb/tree/main/analytic_engine/src/compaction</p>
<p>The data of <code>MemTable</code> is flushed as <code>SST</code>s, but the file size of recently flushed <code>SST</code> may be very small. And too small or too many <code>SST</code>s lead to the poor query performance. Therefore, <code>Compaction</code> is then introduced to rearrange the <code>SST</code>s so that the multiple smaller <code>SST</code> files can be compacted into a larger <code>SST</code> file.</p>
<h4 id="manifest"><a class="header" href="#manifest">Manifest</a></h4>
<p>module path: https://github.com/apache/incubator-horaedb/tree/main/analytic_engine/src/meta</p>
<p><code>Manifest</code> takes responsibilities for managing tables' metadata of <code>Analytic Engine</code> including:</p>
<ul>
<li>Table schema and table options;</li>
<li>The sequence number where the newest flush finishes;</li>
<li>The information of all the <code>SST</code>s belonging to the table.</li>
</ul>
<p>Now the <code>Manifest</code> is based on <code>WAL</code> and <code>Object Storage</code>. The newly written updates on the <code>Manifest</code> are persisted as logs in <code>WAL</code>, and in order to avoid infinite expansion of <code>Manifest</code> (actually every <code>Flush</code> leads to an update), <code>Snapshot</code> is also introduced to clean up the history of metadata updates, and the generated <code>Snapshot</code> will be saved to <code>Object Storage</code>.</p>
<h4 id="object-storage"><a class="header" href="#object-storage">Object Storage</a></h4>
<p>module path: https://github.com/apache/incubator-horaedb/tree/main/components/object_store</p>
<p>The <code>SST</code> generated by <code>Flush</code> needs to be persisted and the abstraction of the persistent storage device is <code>ObjectStore</code> including multiple implementations:</p>
<ul>
<li>Based on local file system;</li>
<li>Based on <a href="https://www.alibabacloud.com/product/object-storage-service">Alibaba Cloud OSS</a>.</li>
</ul>
<p>The distributed architecture of HoraeDB separates storage and computing, which requires <code>Object Store</code> needs to be a highly available and reliable service independent of HoraeDB. Therefore, storage systems like <a href="https://aws.amazon.com/s3/">Amazon S3</a>, <a href="https://www.alibabacloud.com/product/object-storage-service">Alibaba Cloud OSS</a> is a good choice and in the future implementations on storage systems of some other cloud service providers is planned to provide.</p>
<h4 id="sst"><a class="header" href="#sst">SST</a></h4>
<p>module path: https://github.com/apache/incubator-horaedb/tree/main/analytic_engine/src/sst</p>
<p><code>SST</code> is actually an abstraction that can have multiple specific implementations. The current implementation is based on <a href="https://parquet.apache.org/">Parquet</a>, which is a column-oriented data file format designed for efficient data storage and retrieval.</p>
<p>The format of <code>SST</code> is very critical for retrieving data and is also the most important part to perform well in handling both timeseries and analytic workloads. At present, our <a href="https://parquet.apache.org/">Parquet</a>-based implementation is good at processing analytic workload but is poor at processing timeseries workload. In our roadmap, we will explore more storage formats in order to achieve a good performance in both workloads.</p>
<h4 id="space"><a class="header" href="#space">Space</a></h4>
<p>module path: https://github.com/apache/incubator-horaedb/blob/main/analytic_engine/src/space.rs</p>
<p>In <code>Analytic Engine</code>, there is a concept called <code>space</code> and here is an explanation for it to resolve some ambiguities when read source code. Actually <code>Analytic Engine</code> does not have the concept of <code>catalog</code> and <code>schema</code> and only provides two levels of relationship: <code>space</code> and <code>table</code>. And in the implementation, the <code>schema id</code> (which should be unique across all <code>catalog</code>s) on the upper layer is actually mapped to <code>space id</code>.</p>
<p>The <code>space</code> in <code>Analytic Engine</code> serves mainly for isolation of resources for different tenants, such as the usage of memory.</p>
<h2 id="critical-path"><a class="header" href="#critical-path">Critical Path</a></h2>
<p>After a brief introduction to some important modules of HoraeDB, we will give a description for some critical paths in code, hoping to provide interested developers with a guide for reading the code.</p>
<h3 id="query"><a class="header" href="#query">Query</a></h3>
<pre><code class="language-plaintext">┌───────┐      ┌───────┐      ┌───────┐
│       │──1──▶│       │──2──▶│       │
│Server │      │  SQL  │      │Catalog│
│       │◀─10──│       │◀─3───│       │
└───────┘      └───────┘      └───────┘
                │    ▲
               4│   9│
                │    │
                ▼    │
┌─────────────────────────────────────┐
│                                     │
│             Interpreter             │
│                                     │
└─────────────────────────────────────┘
                           │    ▲
                          5│   8│
                           │    │
                           ▼    │
                   ┌──────────────────┐
                   │                  │
                   │   Query Engine   │
                   │                  │
                   └──────────────────┘
                           │    ▲
                          6│   7│
                           │    │
                           ▼    │
 ┌─────────────────────────────────────┐
 │                                     │
 │            Table Engine             │
 │                                     │
 └─────────────────────────────────────┘
</code></pre>
<p>Take <code>SELECT</code> SQL as an example. The figure above shows the query procedure and the numbers in it indicates the order of calling between the modules.</p>
<p>Here are the details:</p>
<ul>
<li>Server module chooses a proper rpc module (it may be HTTP, gRPC or mysql) to process the requests according the protocol used by the requests;</li>
<li>Parse SQL in the request by the parser;</li>
<li>With the parsed sql and the information provided by catalog/schema module, <a href="https://github.com/apache/arrow-datafusion">DataFusion</a> can generate the logical plan;</li>
<li>With the logical plan, the corresponding <code>Interpreter</code> is created and logical plan will be executed by it;</li>
<li>For the logical plan of normal <code>Select</code> SQL, it will be executed through <code>SelectInterpreter</code>;</li>
<li>In the <code>SelectInterpreter</code> the specific query logic is executed by the <code>Query Engine</code>:
<ul>
<li>Optimize the logical plan;</li>
<li>Generate the physical plan;</li>
<li>Optimize the physical plan;</li>
<li>Execute the physical plan;</li>
</ul>
</li>
<li>The execution of physical plan involves <code>Analytic Engine</code>:
<ul>
<li>Data is obtained by <code>read</code> method of <code>Table</code> instance provided by <code>Analytic Engine</code>;</li>
<li>The source of the table data is <code>SST</code> and <code>Memtable</code>, and the data can be filtered by the pushed down predicates;</li>
<li>After retrieving the table data, <code>Query Engine</code> will complete the specific computation and generate the final results;</li>
</ul>
</li>
<li><code>SelectInterpreter</code> gets the results and feeds them to the protocol module;</li>
<li>After the protocol layer converts the results, the server module responds to the client with them.</li>
</ul>
<p>The following is the flow of function calls in version <a href="https://github.com/apache/incubator-horaedb/releases/tag/v1.2.2">v1.2.2</a>:</p>
<pre><code>                                                       ┌───────────────────────◀─────────────┐    ┌───────────────────────┐
                                                       │      handle_sql       │────────┐    │    │       parse_sql       │
                                                       └───────────────────────┘        │    │    └────────────────┬──────┘
                                                           │             ▲              │    │           ▲         │
                                                           │             │              │    │           │         │
                                                           │             │              │    └36───┐     │        11
                                                          1│             │              │          │     │         │
                                                           │            8│              │          │     │         │
                                                           │             │              │          │    10         │
                                                           │             │              │          │     │         │
                                                           ▼             │              │          │     │         ▼
                                                       ┌─────────────────┴─────┐       9│         ┌┴─────┴────────────────┐───────12─────────▶┌───────────────────────┐
                                                       │maybe_forward_sql_query│        └────────▶│fetch_sql_query_output │                   │   statement_to_plan   │
                                                       └───┬───────────────────┘                  └────┬──────────────────┘◀───────19─────────└───────────────────────┘
                                                           │             ▲                             │              ▲                           │               ▲
                                                           │             │                             │              │                           │               │
                                                           │             │                             │              │                           │               │
                                                           │             │                             │             35                          13              18
                                                          2│            7│                            20              │                           │               │
                                                           │             │                             │              │                           │               │
                                                           │             │                             │              │                           │               │
                                                           │             │                             │              │                           ▼               │
                                                           ▼             │                             ▼              │                       ┌───────────────────────┐
          ┌───────────────────────┐───────────6───────▶┌─────────────────┴─────┐                    ┌─────────────────┴─────┐                 │Planner::statement_to_p│
          │ forward_with_endpoint │                    │        forward        │                    │execute_plan_involving_│                 │          lan          │
          └───────────────────────┘◀────────5──────────└───┬───────────────────┘                 ┌──│    partition_table    │◀────────┐       └───┬───────────────────┘
                                                           │             ▲                       │  └───────────────────────┘         │           │              ▲
                                                           │             │                       │     │              ▲               │           │              │
                                                           │             │                       │     │              │               │          14             17
           ┌───────────────────────┐                       │            4│                       │     │              │               │           │              │
     ┌─────│ PhysicalPlan::execute │                      3│             │                       │    21              │               │           │              │
     │     └───────────────────────┘◀──┐                   │             │                       │     │             22               │           │              │
     │                                 │                   │             │                       │     │              │               │           ▼              │
     │                                 │                   │             │                       │     │              │               │       ┌────────────────────────┐
     │                                 │                   ▼             │                       │     ▼              │              34       │sql_statement_to_datafus│
     │     ┌───────────────────────┐  30               ┌─────────────────┴─────┐                 │  ┌─────────────────┴─────┐         │       │        ion_plan        │
    31     │ build_df_session_ctx  │   │               │         route         │                 │  │   build_interpreter   │         │       └────────────────────────┘
     │     └────┬──────────────────┘   │               └───────────────────────┘                 │  └───────────────────────┘         │           │              ▲
     │          │           ▲          │                                                         │                                    │           │              │
     │         27          26          │                                                        23                                    │          15             16
     │          ▼           │          │                                                         │                                    │           │              │
     └────▶┌────────────────┴──────┐   │               ┌───────────────────────┐                 │                                    │           │              │
           │ execute_logical_plan  ├───┴────32────────▶│       execute         │──────────┐      │   ┌───────────────────────┐        │           ▼              │
           └────┬──────────────────┘◀────────────25────┴───────────────────────┘         33      │   │interpreter_execute_pla│        │       ┌────────────────────────┐
                │           ▲                                           ▲                 └──────┴──▶│           n           │────────┘       │SqlToRel::sql_statement_│
               28           │                                           └──────────24────────────────┴───────────────────────┘                │   to_datafusion_plan   │
                │          29                                                                                                                 └────────────────────────┘
                ▼           │
           ┌────────────────┴──────┐
           │     optimize_plan     │
           └───────────────────────┘

</code></pre>
<ol>
<li>The received request will be forwarded to <code>handle_sql</code> after various protocol conversions, and since the request may not be processed by this node, it may need to be forwarded to <code>maybe_forward_sql_query</code> to handle the forwarding logic.</li>
<li>After constructing the <code>ForwardRequest</code> in <code>maybe_forward_sql_query</code>, call <code>forward</code></li>
<li>After constructing the <code>RouteRequest</code> in <code>forward</code>, call <code>route</code></li>
<li>Use <code>route</code> to get the destination node <code>endpoint</code> and return to <code>forward</code>.</li>
<li>Call <code>forward_with_endpoint</code> to forward the request</li>
<li>return <code>forward</code></li>
<li>return <code>maybe_forward_sql_query</code></li>
<li>return <code>handle_sql</code></li>
<li>If this is a <code>Local</code> request, call <code>fetch_sql_query_output</code> to process it</li>
<li>Call <code>parse_sql</code> to parse <code>sql</code> into <code>Statment</code></li>
<li>return <code>fetch_sql_query_output</code></li>
<li>Call <code>statement_to_plan</code> with <code>Statment</code></li>
<li>Construct <code>Planner</code> with <code>ctx</code> and <code>Statment</code>, and call the <code>statement_to_plan</code> method of <code>Planner</code></li>
<li>The <code>planner</code> will call the corresponding <code>planner</code> method for the requested category, at this point our <code>sql</code> is a query and will call <code>sql_statement_to_plan</code></li>
<li>Call <code>sql_statement_to_datafusion_plan</code> , which will generate the <code>datafusion</code> object, and then call <code>SqlToRel::sql_statement_to_plan</code></li>
<li>The generated logical plan is returned from <code>SqlToRel::sql_statement_to_plan</code></li>
<li>return</li>
<li>return</li>
<li>return</li>
<li>Call <code>execute_plan_involving_partition_table</code> (in the default configuration) for subsequent optimization and execution of this logical plan</li>
<li>Call <code>build_interpreter</code> to generate <code>Interpreter</code></li>
<li>return</li>
<li>Call <code>Interpreter's</code> <code>interpreter_execute_plan</code> method for logical plan execution.</li>
<li>The corresponding <code>execute</code> function is called, at this time the <code>sql</code> is a query, so the execute of the <code>SelectInterpreter</code> will be called</li>
<li>call <code>execute_logical_plan</code> , which will call <code>build_df_session_ctx</code> to generate the optimizer</li>
<li><code>build_df_session_ctx</code> will use the <code>config</code> information to generate the corresponding context, first using datafusion and some custom optimization rules (in logical_optimize_rules()) to generate the logical plan optimizer, using <code>apply_adapters_for_physical_optimize_rules</code> to generate the physical plan optimizer</li>
<li>return optimizer</li>
<li>Call <code>optimize_plan</code>, using the optimizer just generated to first optimize the logical plan and then the physical plan</li>
<li>Return to optimized physical plan</li>
<li>execute physical plan</li>
<li>returned after execution</li>
<li>After collecting the results of all slices, return</li>
<li>return</li>
<li>return</li>
<li>return</li>
<li>Return to the upper layer for network protocol conversion and finally return to the request sender</li>
</ol>
<h3 id="write"><a class="header" href="#write">Write</a></h3>
<pre><code class="language-plaintext">┌───────┐      ┌───────┐      ┌───────┐
│       │──1──▶│       │──2──▶│       │
│Server │      │  SQL  │      │Catalog│
│       │◀─8───│       │◀─3───│       │
└───────┘      └───────┘      └───────┘
                │    ▲
               4│   7│
                │    │
                ▼    │
┌─────────────────────────────────────┐
│                                     │
│             Interpreter             │
│                                     │
└─────────────────────────────────────┘
      │    ▲
      │    │
      │    │
      │    │
      │    │       ┌──────────────────┐
      │    │       │                  │
     5│   6│       │   Query Engine   │
      │    │       │                  │
      │    │       └──────────────────┘
      │    │
      │    │
      │    │
      ▼    │
 ┌─────────────────────────────────────┐
 │                                     │
 │            Table Engine             │
 │                                     │
 └─────────────────────────────────────┘
</code></pre>
<p>Take <code>INSERT</code> SQL as an example. The figure above shows the query procedure and the numbers in it indicates the order of calling between the modules.</p>
<p>Here are the details:</p>
<ul>
<li>Server module chooses a proper rpc module (it may be HTTP, gRPC or mysql) to process the requests according the protocol used by the requests;</li>
<li>Parse SQL in the request by the parser;</li>
<li>With the parsed sql and the catalog/schema module, <a href="https://github.com/apache/arrow-datafusion">DataFusion</a> can generate the logical plan;</li>
<li>With the logical plan, the corresponding <code>Interpreter</code> is created and logical plan will be executed by it;</li>
<li>For the logical plan of normal <code>INSERT</code> SQL, it will be executed through <code>InsertInterpreter</code>;</li>
<li>In the <code>InsertInterpreter</code>, <code>write</code> method of <code>Table</code> provided <code>Analytic Engine</code> is called:
<ul>
<li>Write the data into <code>WAL</code> first;</li>
<li>Write the data into <code>MemTable</code> then;</li>
</ul>
</li>
<li>Before writing to <code>MemTable</code>, the memory usage will be checked. If the memory usage is too high, the flush process will be triggered:
<ul>
<li>Persist some old MemTables as <code>SST</code>s;</li>
<li>Store updates about the new <code>SST</code>s and the flushed sequence number of <code>WAL</code> to <code>Manifest</code>;</li>
<li>Delete the corresponding <code>WAL</code> entries;</li>
</ul>
</li>
<li>Server module responds to the client with the execution result.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../dev/roadmap.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../design/clustering.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../dev/roadmap.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../design/clustering.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        <footer>
          <div>
            <p> Apache HoraeDB is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF. </p>
            <p>
              Copyright © 2024 The Apache Software Foundation, Licensed under the Apache License, Version 2.0. <br/>
              Apache HoraeDB, HoraeDB, Apache, and its feather logo, and the feather logo are either registered trademarks or trademarks of the Apache Software Foundation in the United States and/or other countries.
            </p>
          </div>
        </footer>
        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" charset="utf-8"></script>
        <script src="../mark.min.js" charset="utf-8"></script>
        <script src="../searcher.js" charset="utf-8"></script>

        <script src="../clipboard.min.js" charset="utf-8"></script>
        <script src="../highlight.js" charset="utf-8"></script>
        <script src="../book.js" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script src="../sidebar.js"></script>


        <script type="text/javascript">
         let langs = [
                                'cn',
                                'en'
                            ];

        (function langs() {
            var html = document.querySelector('html');
            var langToggleButton = document.getElementById('lang-toggle');
            var langPopup = document.getElementById('lang-list');

            function showLangs() {
                langPopup.style.display = 'block';
                langToggleButton.setAttribute('aria-expanded', true);
            }

            function hideLangs() {
                langPopup.style.display = 'none';
                langToggleButton.setAttribute('aria-expanded', false);
                langToggleButton.focus();
            }

            langToggleButton.addEventListener('click', function () {
                if (langPopup.style.display === 'block') {
                    hideLangs();
                } else {
                    showLangs();
                }
            });

            langPopup.addEventListener('click', function (e) {
               let langs = [
                        'cn',
                        'en'
                    ];
                var lang = e.target.id || e.target.parentElement.id;
                var path_list=[];
                window.location.pathname.split('/').map((s, idx) => {
                    if (idx == 1){
                        if(!langs.includes(s)){
                            path_list.push(lang);
                            path_list.push(s);
                        }else{
                            path_list.push(lang);
                        }
                    }else{
                        path_list.push(s);
                    }
                });
                console.log("path:");
                window.location.pathname = path_list.join('/');
            });

            langPopup.addEventListener('focusout', function(e) {
                // e.relatedTarget is null in Safari and Firefox on macOS (see workaround below)
                if (!!e.relatedTarget && !langToggleButton.contains(e.relatedTarget) && !langPopup.contains(e.relatedTarget)) {
                    hideLangs();
                }
            });

            // Should not be needed, but it works around an issue on macOS & iOS: https://github.com/rust-lang-nursery/mdBook/issues/628
            document.addEventListener('click', function(e) {
                if (langPopup.style.display === 'block' && !langToggleButton.contains(e.target) && !langPopup.contains(e.target)) {
                    hideLangs();
                }
            });

        })();
        </script>

    </body>
</html>
