<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Cluster - HoraeDB Documentation</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../style.css">

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><li class="part-title">Introduction</li><li class="chapter-item "><a href="../about.html"><strong aria-hidden="true">1.</strong> What is HoraeDB</a></li><li class="chapter-item "><a href="../quick_start.html"><strong aria-hidden="true">2.</strong> Quick Start</a></li><li class="chapter-item affix "><li class="part-title">User Guide</li><li class="chapter-item "><a href="../sql/README.html"><strong aria-hidden="true">3.</strong> SQL Syntax</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../sql/model/README.html"><strong aria-hidden="true">3.1.</strong> Data Model</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../sql/model/data_types.html"><strong aria-hidden="true">3.1.1.</strong> Data Types</a></li><li class="chapter-item "><a href="../sql/model/special_columns.html"><strong aria-hidden="true">3.1.2.</strong> Special Columns</a></li></ol></li><li class="chapter-item "><a href="../sql/identifier.html"><strong aria-hidden="true">3.2.</strong> Identifier</a></li><li class="chapter-item "><a href="../sql/ddl/README.html"><strong aria-hidden="true">3.3.</strong> Data Definition Statements</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../sql/ddl/create_table.html"><strong aria-hidden="true">3.3.1.</strong> CREATE TABLE</a></li><li class="chapter-item "><a href="../sql/ddl/alter_table.html"><strong aria-hidden="true">3.3.2.</strong> ALTER TABLE</a></li><li class="chapter-item "><a href="../sql/ddl/drop_table.html"><strong aria-hidden="true">3.3.3.</strong> DROP TABLE</a></li></ol></li><li class="chapter-item "><a href="../sql/dml/README.html"><strong aria-hidden="true">3.4.</strong> Data Manipulation Statements</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../sql/dml/insert.html"><strong aria-hidden="true">3.4.1.</strong> INSERT</a></li><li class="chapter-item "><a href="../sql/dml/select.html"><strong aria-hidden="true">3.4.2.</strong> SELECT</a></li></ol></li><li class="chapter-item "><a href="../sql/utility.html"><strong aria-hidden="true">3.5.</strong> Utility Statements</a></li><li class="chapter-item "><a href="../sql/engine_options.html"><strong aria-hidden="true">3.6.</strong> Engine Options</a></li><li class="chapter-item "><a href="../sql/functions/scalar_functions.html"><strong aria-hidden="true">3.7.</strong> Scalar Functions</a></li><li class="chapter-item "><a href="../sql/functions/aggregate_functions.html"><strong aria-hidden="true">3.8.</strong> Aggregate Functions</a></li></ol></li><li class="chapter-item "><a href="../cluster_deployment/README.html"><strong aria-hidden="true">4.</strong> Cluster Deployment</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../cluster_deployment/platform.html"><strong aria-hidden="true">4.1.</strong> Supported Platform</a></li><li class="chapter-item "><a href="../cluster_deployment/no_meta.html"><strong aria-hidden="true">4.2.</strong> NoMeta Mode</a></li><li class="chapter-item "><a href="../cluster_deployment/with_meta.html"><strong aria-hidden="true">4.3.</strong> WithMeta Mode</a></li></ol></li><li class="chapter-item "><a href="../sdk/README.html"><strong aria-hidden="true">5.</strong> SDK</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../sdk/java.html"><strong aria-hidden="true">5.1.</strong> Java</a></li><li class="chapter-item "><a href="../sdk/go.html"><strong aria-hidden="true">5.2.</strong> Go</a></li><li class="chapter-item "><a href="../sdk/python.html"><strong aria-hidden="true">5.3.</strong> Python</a></li><li class="chapter-item "><a href="../sdk/rust.html"><strong aria-hidden="true">5.4.</strong> Rust</a></li></ol></li><li class="chapter-item "><a href="../operation/README.html"><strong aria-hidden="true">6.</strong> Operation</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../operation/table.html"><strong aria-hidden="true">6.1.</strong> Table</a></li><li class="chapter-item "><a href="../operation/system_table.html"><strong aria-hidden="true">6.2.</strong> System Table</a></li><li class="chapter-item "><a href="../operation/block_list.html"><strong aria-hidden="true">6.3.</strong> Block List</a></li><li class="chapter-item "><a href="../operation/observability.html"><strong aria-hidden="true">6.4.</strong> Observability</a></li><li class="chapter-item "><a href="../operation/horaemeta.html"><strong aria-hidden="true">6.5.</strong> HoraeMeta</a></li></ol></li><li class="chapter-item "><a href="../ecosystem/README.html"><strong aria-hidden="true">7.</strong> Ecosystem</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../ecosystem/prometheus.html"><strong aria-hidden="true">7.1.</strong> Prometheus</a></li><li class="chapter-item "><a href="../ecosystem/influxdb.html"><strong aria-hidden="true">7.2.</strong> InfluxDB</a></li><li class="chapter-item "><a href="../ecosystem/opentsdb.html"><strong aria-hidden="true">7.3.</strong> OpenTSDB</a></li></ol></li><li class="chapter-item "><li class="part-title">Dev Guide</li><li class="chapter-item "><a href="../dev/platform.html"><strong aria-hidden="true">8.</strong> Supported Platform</a></li><li class="chapter-item "><a href="../dev/compile_run.html"><strong aria-hidden="true">9.</strong> Compile and Running</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../dev/profiling.html"><strong aria-hidden="true">9.1.</strong> Profile</a></li></ol></li><li class="chapter-item "><a href="../dev/sdk_develop.html"><strong aria-hidden="true">10.</strong> SDK Development</a></li><li class="chapter-item "><a href="../dev/conventional_commit.html"><strong aria-hidden="true">11.</strong> Conventional Commit</a></li><li class="chapter-item "><a href="../dev/style_guide.html"><strong aria-hidden="true">12.</strong> Style guide</a></li><li class="chapter-item "><a href="../dev/roadmap.html"><strong aria-hidden="true">13.</strong> Roadmap</a></li><li class="chapter-item affix "><li class="part-title">Technical and Design</li><li class="chapter-item "><a href="../design/architecture.html"><strong aria-hidden="true">14.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="../design/clustering.html" class="active"><strong aria-hidden="true">15.</strong> Cluster</a></li><li class="chapter-item "><a href="../design/storage.html"><strong aria-hidden="true">16.</strong> Storage</a></li><li class="chapter-item "><a href="../design/wal.html"><strong aria-hidden="true">17.</strong> WAL</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../design/wal_on_rocksdb.html"><strong aria-hidden="true">17.1.</strong> WAL on RocksDB</a></li><li class="chapter-item "><a href="../design/wal_on_kafka.html"><strong aria-hidden="true">17.2.</strong> WAL on Kafka</a></li></ol></li><li class="chapter-item "><a href="../design/table_partitioning.html"><strong aria-hidden="true">18.</strong> Table Partitioning</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">HoraeDB Documentation</h1>

                    <div class="right-buttons">

                        <button id="lang-toggle" class="icon-button" type="button" title="Change language" aria-label="Change language" aria-haspopup="true" aria-expanded="false" aria-controls="lang-list" >
<!--                             <i class="fa fa-globe"></i> -->
                    <i>
                        <svg t="1675840511805" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2677" width="16" height="16"><path d="M511.573333 85.333333C276.053333 85.333333 85.333333 276.48 85.333333 512s190.72 426.666667 426.24 426.666667C747.52 938.666667 938.666667 747.52 938.666667 512S747.52 85.333333 511.573333 85.333333z m295.68 256h-125.866666a667.733333 667.733333 0 0 0-58.88-151.893333A342.613333 342.613333 0 0 1 807.253333 341.333333zM512 172.373333c35.413333 51.2 63.146667 107.946667 81.493333 168.96h-162.986666c18.346667-61.013333 46.08-117.76 81.493333-168.96zM181.76 597.333333C174.933333 570.026667 170.666667 541.44 170.666667 512s4.266667-58.026667 11.093333-85.333333h144.213333c-3.413333 28.16-5.973333 56.32-5.973333 85.333333 0 29.013333 2.56 57.173333 5.973333 85.333333H181.76z m34.986667 85.333334h125.866666c13.653333 53.333333 33.28 104.533333 58.88 151.893333A340.778667 340.778667 0 0 1 216.746667 682.666667z m125.866666-341.333334H216.746667a340.778667 340.778667 0 0 1 184.746666-151.893333A667.733333 667.733333 0 0 0 342.613333 341.333333zM512 851.626667c-35.413333-51.2-63.146667-107.946667-81.493333-168.96h162.986666c-18.346667 61.013333-46.08 117.76-81.493333 168.96zM611.84 597.333333H412.16c-3.84-28.16-6.826667-56.32-6.826667-85.333333 0-29.013333 2.986667-57.6 6.826667-85.333333h199.68c3.84 27.733333 6.826667 56.32 6.826667 85.333333 0 29.013333-2.986667 57.173333-6.826667 85.333333z m10.666667 237.226667c25.6-47.36 45.226667-98.56 58.88-151.893333h125.866666a342.613333 342.613333 0 0 1-184.746666 151.893333zM698.026667 597.333333c3.413333-28.16 5.973333-56.32 5.973333-85.333333 0-29.013333-2.56-57.173333-5.973333-85.333333h144.213333c6.826667 27.306667 11.093333 55.893333 11.093333 85.333333s-4.266667 58.026667-11.093333 85.333333h-144.213333z" fill="#000000" fill-opacity=".87" p-id="2678"></path></svg>
                        <a id="lang_comment"></a>
                    </i>

                        </button>
                        <ul id="lang-list" class="theme-popup" style="left: auto;" aria-label="Languages" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="en">English</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="cn">中文</button></li>
                        </ul>

                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/apache/incubator-horaedb" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/apache/incubator-horaedb-docs/edit/main/docs/src/en/design/clustering.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <script>
                window.onload = function(){
                    var path_lang = window.location.pathname.split('/')[1];
                    document.getElementById('lang_comment').innerHTML = path_lang=='cn'?"Language":"语言";
                };
                </script>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <p>Note: Some of the features mentioned in the article have not yet been implemented.</p>
<h1 id="introduction-to-architecture-of-horaedb-cluster"><a class="header" href="#introduction-to-architecture-of-horaedb-cluster">Introduction to Architecture of HoraeDB Cluster</a></h1>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<pre><code class="language-plaintext">┌───────────────────────────────────────────────────────────────────────┐
│                                                                       │
│                           HoraeMeta Cluster                           │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘
                              ▲               ▲                 ▲
                              │               │                 │
                              │               │                 │
                              ▼               ▼                 ▼
┌───────┐Route Info ┌HoraeDB─────┬┬─┐ ┌HoraeDB─────┬┬─┐ ┌HoraeDB─────┬┬─┐
│client │◀────────▶ │  │  │TableN││ │ │  │  │TableN││ │ │  │  │TableN││ │
└───────┘Write/Query└──Shard(L)──┴┴─┘ └──Shard(F)──┴┴─┘ └──Shard(F)──┴┴─┘
                            ▲ │                 ▲               ▲
                              │                 │               │
                            │ Write─────────┐   ├────Sync───────┘
                                            │   │
                            │     ┌────────┬▼───┴────┬──────────────────┐
              Upload/Download     │        │         │                  │
                    SST     │     │WAL     │Region N │                  │
                                  │Service │         │                  │
                            │     └────────┴─────────┴──────────────────┘

                            ▼
┌───────────────────────────────────────────────────────────────────────┐
│                                                                       │
│                            Object Storage                             │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘
</code></pre>
<p>The diagram above describes the architecture of a HoraeDB cluster, where some key concepts need to be explained:</p>
<ul>
<li><code>HoraeMeta Cluster</code>: Takes responsibilities for managing the metadata and resource scheduling of the cluster;</li>
<li><code>Shard(L)/Shard(F)</code>: Leader shard and follower shard consisting of multiple tables;</li>
<li><code>HoraeDB</code>: One HoraeDB instance consisting of multiple shards;</li>
<li><code>WAL Service</code>: Write-ahead log service for storing new-written real-time data;</li>
<li><code>Object Storage</code>: Object storage service for storing SST converted from memtable;</li>
</ul>
<p>From the architecture diagram above, it can be concluded that the compute and storage are separated in the HoraeDB cluster, which makes it easy to implement useful distributed features, such as elastic autoscaling of compute/storage resources, high availability, load balancing, and so on.</p>
<p>Let's dive into some of the key components mentioned above before explaining how these features are implemented.</p>
<h3 id="shard"><a class="header" href="#shard">Shard</a></h3>
<p><code>Shard</code> is the basic scheduling unit in the cluster, which consists of a group of tables. And the tables in a shard share the same region for better storage locality in the <code>WAL Service</code>, and because of this, it is efficient to recover the data of all tables in the shard by scanning the entire WAL region. For most of implementations of <code>WAL Service</code>, without the shard concept, it costs a lot to recover the table data one by one due to massive random IO, and this case will deteriorate sharply when the number of tables grows to a certain level.</p>
<p>A specific role, <code>Leader</code> or <code>Follower</code>, should be assigned to a shard. A pair of leader-follower shards share the same set of tables, and the leader shard can serve the write and query requests from the client while the follower shard can only serve the read-only requests, and must synchronize the newly written data from the WAL service in order to provide the latest snapshot for data retrieval. Actually, the follower is not needed if the high availability is not required, while with at least one follower, it takes only a short time to resume service by simply switching the <code>Follower</code> to <code>Leader</code> when the HoraeDB instance on which the leader shard exists crashes.</p>
<p>The diagram below concludes the relationship between HoraeDB instance, <code>Shard</code>, <code>Table</code>. As shown in the diagram, the leader and follower shards are interleaved on the HoraeDB instance.</p>
<pre><code class="language-plaintext">┌─HoraeDB Instance0──────┐     ┌─HoraeDB Instance1──────┐
│  ┌─Shard0(L)────────┐  │     │  ┌─Shard0(F)────────┐  │
│  │ ┌────┬────┬────┐ │  │     │  │ ┌────┬────┬────┐ │  │
│  │ │ T0 │ T1 │ T2 │ │  │     │  │ │ T0 │ T1 │ T2 │ │  │
│  │ └────┴────┴────┘ │  │     │  │ └────┴────┴────┘ │  │
│  └──────────────────┘  │     │  └──────────────────┘  │
│                        │     │                        │
│  ┌─Shard1(F)────────┐  │     │  ┌─Shard1(L)────────┐  │
│  │ ┌────┬────┬────┐ │  │     │  │ ┌────┬────┬────┐ │  │
│  │ │ T0 │ T1 │ T2 │ │  │     │  │ │ T0 │ T1 │ T2 │ │  │
│  │ └────┴────┴────┘ │  │     │  │ └────┴────┴────┘ │  │
│  └──────────────────┘  │     │  └──────────────────┘  │
└────────────────────────┘     └────────────────────────┘
</code></pre>
<p>Since <code>Shard</code> is the basic scheduling unit, it is natural to introduce some basic shard operations:</p>
<ul>
<li>Create/Drop table to/from a shard;</li>
<li>Open/Close a shard;</li>
<li>Split one shard into two shards;</li>
<li>Merge two shards into one shard;</li>
<li>Switch the role of a shard;</li>
</ul>
<p>With these basic shard operations, some complex scheduling logic can be implemented, e.g. perform an expansion by splitting one shard into two shards and migrating one of them to the new HoraeDB instance.</p>
<h3 id="horaemeta"><a class="header" href="#horaemeta">HoraeMeta</a></h3>
<p><code>HoraeMeta</code> is implemented by embedding an ETCD inside to ensure consistency and takes responsibilities for cluster metadata management and scheduling.</p>
<p>The cluster metadata includes:</p>
<ul>
<li>Table information, such as table name, table ID, and which cluster the table belongs to;</li>
<li>The mapping between table and shard and between shard and HoraeDB instance;</li>
<li>...</li>
</ul>
<p>As for the cluster scheduling work, it mainly includes:</p>
<ul>
<li>Receiving the heartbeats from the HoraeDB instances and determining the online status of these registered instances;</li>
<li>Assigning specific role shards to the registered HoraeDB instances;</li>
<li>Participating in table creation by assigning a unique table ID and the most appropriate shard to the table;</li>
<li>Performing load balancing through shard operations according to the load information sent with the heartbeats;</li>
<li>Performing expansion through shard operations when new instances are registered;</li>
<li>Initiating failover through shard operations when old instances go offline;</li>
</ul>
<h3 id="route"><a class="header" href="#route">Route</a></h3>
<p>In order to avoid the overhead of forwarding requests, the communication between clients and the HoraeDB instances is peer-to-peer, that is to say, the client should retrieve routing information from the server before sending any specific write/query requests.</p>
<p>Actually, the routing information is decided by the <code>HoraeMeta</code>, but clients are only allowed the access to it through the HoraeDB instances rather than <code>HoraeMeta</code>, to avoid potential performance issues on the <code>HoraeMeta</code>.</p>
<h3 id="wal-service--object-storage"><a class="header" href="#wal-service--object-storage">WAL Service &amp; Object Storage</a></h3>
<p>In the HoraeDB cluster, <code>WAL Service</code> and <code>Object Storage</code> exist as separate distributed systems featured with HA, data replication and scalability. Current distributed implementations for <code>WAL Service</code> includes <code>Kafka</code> and <code>OBKV</code> (access <code>OceanBase</code> by its table api), and the implementations for <code>Object Storage</code> include popular object storage services, such as AWS S3, Azure object storage and Aliyun OSS.</p>
<p>The two components are similar in that they are introduced to serve as the underlying storage layer for separating compute and storage, while the difference between two components is obvious that <code>WAL Service</code> is used to store the newly written data from the real-time write requests whose individual size is small but quantity is large, and <code>Object Storage</code> is used to store the read-friendly data files (SST) organized in the background, whose individual size is large and aggregate size is much larger.</p>
<p>The two components make it much easier to implement the horaedb cluster, which features horizontal scalability, high availability and load balancing.</p>
<h2 id="scalability"><a class="header" href="#scalability">Scalability</a></h2>
<p>Scalability is an important feature for a distributed system. Let's take a look at to how the horizontal scalability of the HoraeDB cluster is achieved.</p>
<p>First, the two storage components (<code>WAL Service</code> and <code>Object Storage</code>) should be horizontally scalable when deciding on the actual implementations for them, so the two storage services can be expanded separately if the storage capacity is not sufficient.</p>
<p>It will be a little bit complex when discussing the scalability of the compute service. Basically, these cases will bring the capacity problem:</p>
<ul>
<li>Massive queries on massive tables;</li>
<li>Massive queries on a single large table;</li>
<li>Massive queries on a normal table;</li>
</ul>
<p>For the first case, it is easy to achieve horizontal scalability just by assigning shards that are created or split from old shards to expanded HoraeDB instances.</p>
<p>For the second case, the table partitioning is proposed and after partitioning, massive queries are distributed across multiple HoraeDB instances.</p>
<p>And the last case is the most important and the most difficult. Actually, the follower shard can handle part of the queries, but the number of follower shards is limited by the throughput threshold of the synchronization from the WAL regions. As shown in the diagram below, a pure compute shard can be introduced if the followers are not enough to handle the massive queries. Such a shard is not required to synchronize data with the leader shard, and retrieves the newly written data from the leader/follower shard only when the query comes. As for the SSTs required by the query, they will be downloaded from <code>Object Storage</code> and cached afterwards. With the two parts of the data, the compute resources are fully utilized to execute the CPU-intensive query plan. As we can see, such a shard can be added with only a little overhead (retrieving some data from the leader/follower shard when it needs), so to some extent, the horizontal scalability is achieved.</p>
<pre><code class="language-plaintext">                                             ┌HoraeDB─────┬┬─┐
                            ┌──newly written─│  │  │TableN││ │
                            ▼                └──Shard(L/F)┴┴─┘
┌───────┐  Query  ┌HoraeDB─────┬┬─┐
│client │────────▶│  │  │TableN││ │
└───────┘         └──Shard─────┴┴─┘          ┌───────────────┐
                            ▲                │    Object     │
                            └───old SST──────│    Storage    │
                                             └───────────────┘
</code></pre>
<h2 id="high-availability"><a class="header" href="#high-availability">High Availability</a></h2>
<p>Assuming that <code>WAL service</code> and <code>Object Storage</code> are highly available, the high availability of the HoraeDB cluster can be achieved by such a procedure:</p>
<ul>
<li>When detecting that the heartbeat is broken, <code>HoraeMeta</code> determines that the HoraeDB instance is offline;</li>
<li>The follower shards whose paired leader shards exist on the offline instance are switched to leader shards for fast failover;</li>
<li>A slow failover can be achieved by opening the crashed shards on another instance if such follower shards don't exist.</li>
</ul>
<pre><code class="language-plaintext">┌─────────────────────────────────────────────────────────┐
│                                                         │
│                    HoraeMeta Cluster                    │
│                                                         │
└─────────────────────────────────────────────────────────┘
                             ▲
             ┌ ─ Heartbeat ─ ┤
                   Broken    │
             │               │
┌ HoraeDB Instance0 ─ ─ ─    │   ┌─HoraeDB Instance1──────┐                   ┌─HoraeDB Instance1──────┐
   ┌─Shard0(L)────────┐  │   │   │  ┌─Shard0(F)────────┐  │                   │  ┌─Shard0(L)────────┐  │
│  │ ┌────┬────┬────┐ │      │   │  │ ┌────┬────┬────┐ │  │                   │  │ ┌────┬────┬────┐ │  │
   │ │ T0 │ T1 │ T2 │ │  │   ├───│  │ │ T0 │ T1 │ T2 │ │  │                   │  │ │ T0 │ T1 │ T2 │ │  │
│  │ └────┴────┴────┘ │      │   │  │ └────┴────┴────┘ │  │                   │  │ └────┴────┴────┘ │  │
   └──────────────────┘  │   │   │  └──────────────────┘  │     Failover      │  └──────────────────┘  │
│                            │   ├─HoraeDB Instance2──────┤   ───────────▶    ├─HoraeDB Instance2──────┤
   ┌─Shard1(L)────────┐  │   │   │  ┌─Shard1(F)────────┐  │                   │  ┌─Shard1(L)────────┐  │
│  │ ┌────┬────┬────┐ │      │   │  │ ┌────┬────┬────┐ │  │                   │  │ ┌────┬────┬────┐ │  │
   │ │ T0 │ T1 │ T2 │ │  │   └───│  │ │ T0 │ T1 │ T2 │ │  │                   │  │ │ T0 │ T1 │ T2 │ │  │
│  │ └────┴────┴────┘ │          │  │ └────┴────┴────┘ │  │                   │  │ └────┴────┴────┘ │  │
   └──────────────────┘  │       │  └──────────────────┘  │                   │  └──────────────────┘  │
└ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─        └────────────────────────┘                   └────────────────────────┘
</code></pre>
<h2 id="load-balancing"><a class="header" href="#load-balancing">Load Balancing</a></h2>
<p>HoraeMeta collects the instance load information contained in the received heartbeats to create a load overview of the whole cluster, according to which the load balancing can be implemented as an automatic mechanism:</p>
<ul>
<li>Pick a shard on a low-load instance for the newly created table;</li>
<li>Migrate a shard from a high-load instance load to another low-load instance;</li>
<li>Split the large shard on the high-load instance and migrate the split shards to other low-load instances;</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../design/architecture.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../design/storage.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../design/architecture.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../design/storage.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        <footer>
          <div>
            <p> Apache HoraeDB is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF. </p>
            <p>
              Copyright © 2024 The Apache Software Foundation, Licensed under the Apache License, Version 2.0. <br/>
              Apache HoraeDB, HoraeDB, Apache, and its feather logo, and the feather logo are either registered trademarks or trademarks of the Apache Software Foundation in the United States and/or other countries.
            </p>
          </div>
        </footer>
        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" charset="utf-8"></script>
        <script src="../mark.min.js" charset="utf-8"></script>
        <script src="../searcher.js" charset="utf-8"></script>

        <script src="../clipboard.min.js" charset="utf-8"></script>
        <script src="../highlight.js" charset="utf-8"></script>
        <script src="../book.js" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script src="../sidebar.js"></script>


        <script type="text/javascript">
         let langs = [
                                'cn',
                                'en'
                            ];

        (function langs() {
            var html = document.querySelector('html');
            var langToggleButton = document.getElementById('lang-toggle');
            var langPopup = document.getElementById('lang-list');

            function showLangs() {
                langPopup.style.display = 'block';
                langToggleButton.setAttribute('aria-expanded', true);
            }

            function hideLangs() {
                langPopup.style.display = 'none';
                langToggleButton.setAttribute('aria-expanded', false);
                langToggleButton.focus();
            }

            langToggleButton.addEventListener('click', function () {
                if (langPopup.style.display === 'block') {
                    hideLangs();
                } else {
                    showLangs();
                }
            });

            langPopup.addEventListener('click', function (e) {
               let langs = [
                        'cn',
                        'en'
                    ];
                var lang = e.target.id || e.target.parentElement.id;
                var path_list=[];
                window.location.pathname.split('/').map((s, idx) => {
                    if (idx == 1){
                        if(!langs.includes(s)){
                            path_list.push(lang);
                            path_list.push(s);
                        }else{
                            path_list.push(lang);
                        }
                    }else{
                        path_list.push(s);
                    }
                });
                console.log("path:");
                window.location.pathname = path_list.join('/');
            });

            langPopup.addEventListener('focusout', function(e) {
                // e.relatedTarget is null in Safari and Firefox on macOS (see workaround below)
                if (!!e.relatedTarget && !langToggleButton.contains(e.relatedTarget) && !langPopup.contains(e.relatedTarget)) {
                    hideLangs();
                }
            });

            // Should not be needed, but it works around an issue on macOS & iOS: https://github.com/rust-lang-nursery/mdBook/issues/628
            document.addEventListener('click', function(e) {
                if (langPopup.style.display === 'block' && !langToggleButton.contains(e.target) && !langPopup.contains(e.target)) {
                    hideLangs();
                }
            });

        })();
        </script>

    </body>
</html>
