<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>WAL on Kafka - HoraeDB Documentation</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../style.css">

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><li class="part-title">Introduction</li><li class="chapter-item "><a href="../about.html"><strong aria-hidden="true">1.</strong> What is HoraeDB</a></li><li class="chapter-item "><a href="../quick_start.html"><strong aria-hidden="true">2.</strong> Quick Start</a></li><li class="chapter-item affix "><li class="part-title">User Guide</li><li class="chapter-item "><a href="../sql/README.html"><strong aria-hidden="true">3.</strong> SQL Syntax</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../sql/model/README.html"><strong aria-hidden="true">3.1.</strong> Data Model</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../sql/model/data_types.html"><strong aria-hidden="true">3.1.1.</strong> Data Types</a></li><li class="chapter-item "><a href="../sql/model/special_columns.html"><strong aria-hidden="true">3.1.2.</strong> Special Columns</a></li></ol></li><li class="chapter-item "><a href="../sql/identifier.html"><strong aria-hidden="true">3.2.</strong> Identifier</a></li><li class="chapter-item "><a href="../sql/ddl/README.html"><strong aria-hidden="true">3.3.</strong> Data Definition Statements</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../sql/ddl/create_table.html"><strong aria-hidden="true">3.3.1.</strong> CREATE TABLE</a></li><li class="chapter-item "><a href="../sql/ddl/alter_table.html"><strong aria-hidden="true">3.3.2.</strong> ALTER TABLE</a></li><li class="chapter-item "><a href="../sql/ddl/drop_table.html"><strong aria-hidden="true">3.3.3.</strong> DROP TABLE</a></li></ol></li><li class="chapter-item "><a href="../sql/dml/README.html"><strong aria-hidden="true">3.4.</strong> Data Manipulation Statements</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../sql/dml/insert.html"><strong aria-hidden="true">3.4.1.</strong> INSERT</a></li><li class="chapter-item "><a href="../sql/dml/select.html"><strong aria-hidden="true">3.4.2.</strong> SELECT</a></li></ol></li><li class="chapter-item "><a href="../sql/utility.html"><strong aria-hidden="true">3.5.</strong> Utility Statements</a></li><li class="chapter-item "><a href="../sql/engine_options.html"><strong aria-hidden="true">3.6.</strong> Engine Options</a></li><li class="chapter-item "><a href="../sql/functions/scalar_functions.html"><strong aria-hidden="true">3.7.</strong> Scalar Functions</a></li><li class="chapter-item "><a href="../sql/functions/aggregate_functions.html"><strong aria-hidden="true">3.8.</strong> Aggregate Functions</a></li></ol></li><li class="chapter-item "><a href="../cluster_deployment/README.html"><strong aria-hidden="true">4.</strong> Cluster Deployment</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../cluster_deployment/platform.html"><strong aria-hidden="true">4.1.</strong> Supported Platform</a></li><li class="chapter-item "><a href="../cluster_deployment/no_meta.html"><strong aria-hidden="true">4.2.</strong> NoMeta Mode</a></li><li class="chapter-item "><a href="../cluster_deployment/with_meta.html"><strong aria-hidden="true">4.3.</strong> WithMeta Mode</a></li></ol></li><li class="chapter-item "><a href="../sdk/README.html"><strong aria-hidden="true">5.</strong> SDK</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../sdk/java.html"><strong aria-hidden="true">5.1.</strong> Java</a></li><li class="chapter-item "><a href="../sdk/go.html"><strong aria-hidden="true">5.2.</strong> Go</a></li><li class="chapter-item "><a href="../sdk/python.html"><strong aria-hidden="true">5.3.</strong> Python</a></li><li class="chapter-item "><a href="../sdk/rust.html"><strong aria-hidden="true">5.4.</strong> Rust</a></li></ol></li><li class="chapter-item "><a href="../operation/README.html"><strong aria-hidden="true">6.</strong> Operation</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../operation/table.html"><strong aria-hidden="true">6.1.</strong> Table</a></li><li class="chapter-item "><a href="../operation/system_table.html"><strong aria-hidden="true">6.2.</strong> System Table</a></li><li class="chapter-item "><a href="../operation/block_list.html"><strong aria-hidden="true">6.3.</strong> Block List</a></li><li class="chapter-item "><a href="../operation/observability.html"><strong aria-hidden="true">6.4.</strong> Observability</a></li><li class="chapter-item "><a href="../operation/horaemeta.html"><strong aria-hidden="true">6.5.</strong> HoraeMeta</a></li></ol></li><li class="chapter-item "><a href="../ecosystem/README.html"><strong aria-hidden="true">7.</strong> Ecosystem</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../ecosystem/prometheus.html"><strong aria-hidden="true">7.1.</strong> Prometheus</a></li><li class="chapter-item "><a href="../ecosystem/influxdb.html"><strong aria-hidden="true">7.2.</strong> InfluxDB</a></li><li class="chapter-item "><a href="../ecosystem/opentsdb.html"><strong aria-hidden="true">7.3.</strong> OpenTSDB</a></li></ol></li><li class="chapter-item "><li class="part-title">Dev Guide</li><li class="chapter-item "><a href="../dev/platform.html"><strong aria-hidden="true">8.</strong> Supported Platform</a></li><li class="chapter-item "><a href="../dev/compile_run.html"><strong aria-hidden="true">9.</strong> Compile and Running</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../dev/profiling.html"><strong aria-hidden="true">9.1.</strong> Profile</a></li></ol></li><li class="chapter-item "><a href="../dev/conventional_commit.html"><strong aria-hidden="true">10.</strong> Conventional Commit</a></li><li class="chapter-item "><a href="../dev/style_guide.html"><strong aria-hidden="true">11.</strong> Style guide</a></li><li class="chapter-item "><a href="../dev/roadmap.html"><strong aria-hidden="true">12.</strong> Roadmap</a></li><li class="chapter-item affix "><li class="part-title">Technical and Design</li><li class="chapter-item "><a href="../design/architecture.html"><strong aria-hidden="true">13.</strong> Architecture</a></li><li class="chapter-item "><a href="../design/clustering.html"><strong aria-hidden="true">14.</strong> Cluster</a></li><li class="chapter-item "><a href="../design/storage.html"><strong aria-hidden="true">15.</strong> Storage</a></li><li class="chapter-item expanded "><a href="../design/wal.html"><strong aria-hidden="true">16.</strong> WAL</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../design/wal_on_rocksdb.html"><strong aria-hidden="true">16.1.</strong> WAL on RocksDB</a></li><li class="chapter-item expanded "><a href="../design/wal_on_kafka.html" class="active"><strong aria-hidden="true">16.2.</strong> WAL on Kafka</a></li></ol></li><li class="chapter-item "><a href="../design/table_partitioning.html"><strong aria-hidden="true">17.</strong> Table Partitioning</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">HoraeDB Documentation</h1>

                    <div class="right-buttons">

                        <button id="lang-toggle" class="icon-button" type="button" title="Change language" aria-label="Change language" aria-haspopup="true" aria-expanded="false" aria-controls="lang-list" >
<!--                             <i class="fa fa-globe"></i> -->
                    <i>
                        <svg t="1675840511805" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2677" width="16" height="16"><path d="M511.573333 85.333333C276.053333 85.333333 85.333333 276.48 85.333333 512s190.72 426.666667 426.24 426.666667C747.52 938.666667 938.666667 747.52 938.666667 512S747.52 85.333333 511.573333 85.333333z m295.68 256h-125.866666a667.733333 667.733333 0 0 0-58.88-151.893333A342.613333 342.613333 0 0 1 807.253333 341.333333zM512 172.373333c35.413333 51.2 63.146667 107.946667 81.493333 168.96h-162.986666c18.346667-61.013333 46.08-117.76 81.493333-168.96zM181.76 597.333333C174.933333 570.026667 170.666667 541.44 170.666667 512s4.266667-58.026667 11.093333-85.333333h144.213333c-3.413333 28.16-5.973333 56.32-5.973333 85.333333 0 29.013333 2.56 57.173333 5.973333 85.333333H181.76z m34.986667 85.333334h125.866666c13.653333 53.333333 33.28 104.533333 58.88 151.893333A340.778667 340.778667 0 0 1 216.746667 682.666667z m125.866666-341.333334H216.746667a340.778667 340.778667 0 0 1 184.746666-151.893333A667.733333 667.733333 0 0 0 342.613333 341.333333zM512 851.626667c-35.413333-51.2-63.146667-107.946667-81.493333-168.96h162.986666c-18.346667 61.013333-46.08 117.76-81.493333 168.96zM611.84 597.333333H412.16c-3.84-28.16-6.826667-56.32-6.826667-85.333333 0-29.013333 2.986667-57.6 6.826667-85.333333h199.68c3.84 27.733333 6.826667 56.32 6.826667 85.333333 0 29.013333-2.986667 57.173333-6.826667 85.333333z m10.666667 237.226667c25.6-47.36 45.226667-98.56 58.88-151.893333h125.866666a342.613333 342.613333 0 0 1-184.746666 151.893333zM698.026667 597.333333c3.413333-28.16 5.973333-56.32 5.973333-85.333333 0-29.013333-2.56-57.173333-5.973333-85.333333h144.213333c6.826667 27.306667 11.093333 55.893333 11.093333 85.333333s-4.266667 58.026667-11.093333 85.333333h-144.213333z" fill="#000000" fill-opacity=".87" p-id="2678"></path></svg>
                        <a id="lang_comment"></a>
                    </i>

                        </button>
                        <ul id="lang-list" class="theme-popup" style="left: auto;" aria-label="Languages" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="en">English</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="cn">中文</button></li>
                        </ul>

                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/apache/incubator-horaedb" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/apache/incubator-horaedb-docs/edit/main/docs/src/en/design/wal_on_kafka.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <script>
                window.onload = function(){
                    var path_lang = window.location.pathname.split('/')[1];
                    document.getElementById('lang_comment').innerHTML = path_lang=='cn'?"Language":"语言";
                };
                </script>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <h1 id="wal-on-kafka"><a class="header" href="#wal-on-kafka">WAL on Kafka</a></h1>
<h2 id="architecture"><a class="header" href="#architecture">Architecture</a></h2>
<p>In this section we present a distributed WAL implementation(based on Kafka). Write-ahead logs(hereinafter referred to as logs) of tables are managed here by region, which can be simply understood as a shared log file of multiple tables.</p>
<p>As shown in the following figure, regions are mapped to topics(with only one partition) in Kafka. And usually two topics are needed by a region, one is used for storing logs and the other is used for storing metadata.</p>
<pre><code class="language-text">                                                 ┌──────────────────────────┐
                                                 │         Kafka            │
                                                 │                          │
                                                 │         ......           │
                                                 │                          │
                                                 │ ┌─────────────────────┐  │
                                                 │ │      Meta Topic     │  │
                                                 │ │                     │  │
                                         Delete  │ │ ┌─────────────────┐ │  │
               ┌──────────────────────┐  ┌───────┼─┼─►    Partition    │ │  │
               │       HoraeDB        │  │       │ │ │                 │ │  │
               │                      │  │       │ │ └─────────────────┘ │  │
               │ ┌──────────────────┐ │  │       │ │                     │  │
               │ │       WAL        │ │  │       │ └─────────────────────┘  │
               │ │      ......      │ │  │       │                          │
               │ │ ┌──────────────┐ │ │  │       │ ┌──────────────────────┐ │
               │ │ │    Region    │ │ │  │       │ │     Data Topic       │ │
               │ │ │              ├─┼─┼──┘       │ │                      │ │
               | | | ┌──────────┐ │ │ │          │ │ ┌──────────────────┐ │ │
               │ │ │ │ Metadata │ │ │ │          │ │ │    Partition     │ │ │
               │ │ │ └──────────┘ │ │ │    Write │ │ │                  │ │ │
Write ─────────┼─┼─►              ├─┼─┼───┐      │ │ │ ┌──┬──┬──┬──┬──┐ │ │ │
               │ │ │ ┌──────────┐ │ │ │   └──────┼─┼─┼─►  │  │  │  │  ├─┼─┼─┼────┐
               │ │ │ │  Client  │ │ │ │          │ │ │ └──┴──┴──┴──┴──┘ │ │ │    │
Read ◄─────────┼─┼─┤ └──────────┘ │ │ │          │ │ │                  │ │ │    │
               │ │ │              │ │ │          │ │ └──────────────────┘ │ │    │
               │ │ └──▲───────────┘ │ │          │ │                      │ │    │
               │ │    │ ......      │ │          │ └──────────────────────┘ │    │
               │ └────┼─────────────┘ │          │         ......           │    │
               │      │               │          └──────────────────────────┘    │
               └──────┼───────────────┘                                          │
                      │                                                          │
                      │                                                          │
                      │                        Read                              │
                      └──────────────────────────────────────────────────────────┘
</code></pre>
<h2 id="data-model"><a class="header" href="#data-model">Data Model</a></h2>
<h3 id="log-format"><a class="header" href="#log-format">Log Format</a></h3>
<p>The common log format described in <a href="wal_on_rocksdb.html">WAL on RocksDB</a> is used here.</p>
<h3 id="metadata"><a class="header" href="#metadata">Metadata</a></h3>
<p>Each region will maintain its metadata both in memory and in Kafka, we call it <code>RegionMeta</code> here. It can be thought of as a map, taking table id as a key and <code>TableMeta</code> as a value.
We briefly introduce the variables in <code>TableMeta</code> here:</p>
<ul>
<li><code>next_seq_num</code>, the sequence number allocated to the next log entry.</li>
<li><code>latest_marked_deleted</code>, the last flushed sequence number, all logs in the table with a lower sequence number than it can be removed.</li>
<li><code>current_high_watermark</code>, the high watermark in the Kafka partition after the last writing of this table.</li>
<li><code>seq_offset_mapping</code>, mapping from sequence numbers to offsets will be done on every write and will removed to the updated <code>latest_marked_deleted</code> after flushing.</li>
</ul>
<pre><code>┌─────────────────────────────────────────┐
│              RegionMeta                 │
│                                         │
│ Map&lt;TableId, TableMeta&gt; table_metas     │
└─────────────────┬───────────────────────┘
                  │
                  │
                  │
                  └─────┐
                        │
                        │
 ┌──────────────────────┴──────────────────────────────┐
 │                       TableMeta                     │
 │                                                     │
 │ SequenceNumber next_seq_num                         │
 │                                                     │
 │ SequenceNumber latest_mark_deleted                  │
 │                                                     │
 │ KafkaOffset high_watermark                          │
 │                                                     │
 │ Map&lt;SequenceNumber, KafkaOffset&gt; seq_offset_mapping │
 └─────────────────────────────────────────────────────┘
</code></pre>
<h2 id="main-process"><a class="header" href="#main-process">Main Process</a></h2>
<p>We focus on the main process in one region, following process will be introduced:</p>
<ul>
<li>Open or create region.</li>
<li>Write and read logs.</li>
<li>Delete logs.</li>
</ul>
<h3 id="open-or-create-region"><a class="header" href="#open-or-create-region">Open or Create Region</a></h3>
<h4 id="steps"><a class="header" href="#steps">Steps</a></h4>
<ul>
<li>Search the region in the opened namespace.</li>
<li>If the region found, the most important thing we need to do is to recover its metadata, we will introduce this later.</li>
<li>If the region not found and auto creating is defined, just create the corresponding topic in Kafka.</li>
<li>Add the found or created region to cache, return it afterwards.</li>
</ul>
<h4 id="recovery"><a class="header" href="#recovery">Recovery</a></h4>
<p>As mentioned above, the <code>RegionMeta</code> is actually a map of the <code>TableMeta</code>. So here we will focus on recovering a specific <code>TableMeta</code>, and examples will be given to better illustrate this process.</p>
<ul>
<li>First, recover the <code>RegionMeta</code> from snapshot. We will take a snapshot of the <code>RegionMeta</code> in some scenarios (e.g. mark logs deleted, clean logs) and put it to the meta topic. The snapshot is actually the <code>RegionMeta</code> at a particular point in time. When recovering a region, we can use it to avoid scanning all logs in the data topic. The following is the example, we recover from the snapshot taken at the time when Kafka high watermark is 64:</li>
</ul>
<pre><code class="language-text">high watermark in snapshot: 64

 ┌──────────────────────────────┐
 │         RegionMeta           │
 │                              │
 │          ......              │
 │ ┌──────────────────────────┐ │
 │ │       TableMeta          │ │
 │ │                          │ │
 │ │ next_seq_num: 5          │ │
 │ │                          │ │
 │ │ latest_mark_deleted: 2   │ │
 │ │                          │ │
 │ │ high_watermark: 32       │ │
 │ │                          │ │
 │ │ seq_offset_mapping:      │ │
 │ │                          │ │
 │ │ (2, 16) (3, 16) (4, 31)  │ │
 │ └──────────────────────────┘ │
 │          ......              │
 └──────────────────────────────┘
</code></pre>
<ul>
<li>Recovering from logs. After recovering from snapshot, we can continue to recover by scanning logs in data topic from the Kafka high watermark when snapshot is taken, and obviously that avoid scanning the whole data topic. Let's see the example:</li>
</ul>
<pre><code class="language-text">┌────────────────────────────────────┐
│                                    │
│    high_watermark in snapshot: 64  │
│                                    │
│  ┌──────────────────────────────┐  │
│  │         RegionMeta           │  │
│  │                              │  │
│  │          ......              │  │
│  │ ┌──────────────────────────┐ │  │
│  │ │       TableMeta          │ │  │
│  │ │                          │ │  │
│  │ │ next_seq_num: 5          │ │  │                  ┌────────────────────────────────┐
│  │ │                          │ │  │                  │          RegionMeta            │
│  │ │ latest_mark_deleted: 2   │ │  │                  │                                │
│  │ │                          │ │  │                  │            ......              │
│  │ │ high_watermark: 32       │ │  │                  │ ┌────────────────────────────┐ │
│  │ │                          │ │  │                  │ │         TableMeta          │ │
│  │ │ seq_offset_mapping:      │ │  │                  │ │                            │ │
│  │ │                          │ │  │                  │ │ next_seq_num: 8            │ │
│  │ │ (2, 16) (3, 16) (4, 31)  │ │  │                  │ │                            │ │
│  │ └──────────────────────────┘ │  │                  │ │ latest_mark_deleted: 2     │ │
│  │          ......              │  │                  │ │                            │ │
│  └──────────────────────────────┘  ├──────────────────► │ high_watermark: 32         │ │
│                                    │                  │ │                            │ │
│ ┌────────────────────────────────┐ │                  │ │ seq_offset_mapping:        │ │
│ │          Data topic            │ │                  │ │                            │ │
│ │                                │ │                  │ │ (2, 16) (3, 16) (4, 31)    │ │
│ │ ┌────────────────────────────┐ │ │                  │ │                            │ │
│ │ │        Partition           │ │ │                  │ │ (5, 72) (6, 81) (7, 90)    │ │
│ │ │                            │ │ │                  │ │                            │ │
│ │ │ ┌────┬────┬────┬────┬────┐ │ │ │                  │ └────────────────────────────┘ │
│ │ │ │ 64 │ 65 │ ...│ 99 │100 │ │ │ │                  │             ......             │
│ │ │ └────┴────┴────┴────┴────┘ │ │ │                  └────────────────────────────────┘
│ │ │                            │ │ │
│ │ └────────────────────────────┘ │ │
│ │                                │ │
│ └────────────────────────────────┘ │
│                                    │
└────────────────────────────────────┘
</code></pre>
<h3 id="write-and-read-logs"><a class="header" href="#write-and-read-logs">Write and Read Logs</a></h3>
<p>The writing and reading process in a region is simple.</p>
<p>For writing:</p>
<ul>
<li>Open the specified region (auto create it if necessary).</li>
<li>Put the logs to specified Kafka partition by client.</li>
<li>Update <code>next_seq_num</code>, <code>current_high_watermark</code> and <code>seq_offset_mapping</code> in corresponding <code>TableMeta</code>.</li>
</ul>
<p>For reading:</p>
<ul>
<li>Open the specified region.</li>
<li>Just read all the logs of the region, and the split and replay work will be done by the caller.</li>
</ul>
<h3 id="delete-logs"><a class="header" href="#delete-logs">Delete Logs</a></h3>
<p>Log deletion can be divided into two steps:</p>
<ul>
<li>Mark the logs deleted.</li>
<li>Do delayed cleaning work periodically in a background thread.</li>
</ul>
<h4 id="mark"><a class="header" href="#mark">Mark</a></h4>
<ul>
<li>Update <code>latest_mark_deleted</code> and <code>seq_offset_mapping</code>(just retain the entries whose's sequence &gt;= updated latest_mark_deleted) in <code>TableMeta</code>.</li>
<li>Maybe we need to make and sync the <code>RegionMeta</code> snapshot to Kafka while dropping table.</li>
</ul>
<h4 id="clean"><a class="header" href="#clean">Clean</a></h4>
<p>The cleaning logic done in a background thread called cleaner:</p>
<ul>
<li>Make <code>RegionMeta</code> snapshot.</li>
<li>Decide whether to clean the logs based on the snapshot.</li>
<li>If so, sync the snapshot to Kafka first, then clean the logs.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../design/wal_on_rocksdb.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../design/table_partitioning.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../design/wal_on_rocksdb.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../design/table_partitioning.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        <footer>
          <div>
            <p> Apache HoraeDB is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF. </p>
            <p>
              Copyright © 2024 The Apache Software Foundation, Licensed under the Apache License, Version 2.0. <br/>
              Apache HoraeDB, HoraeDB, Apache, and its feather logo, and the feather logo are either registered trademarks or trademarks of the Apache Software Foundation in the United States and/or other countries.
            </p>
          </div>
        </footer>
        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" charset="utf-8"></script>
        <script src="../mark.min.js" charset="utf-8"></script>
        <script src="../searcher.js" charset="utf-8"></script>

        <script src="../clipboard.min.js" charset="utf-8"></script>
        <script src="../highlight.js" charset="utf-8"></script>
        <script src="../book.js" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script src="../sidebar.js"></script>


        <script type="text/javascript">
         let langs = [
                                'cn',
                                'en'
                            ];

        (function langs() {
            var html = document.querySelector('html');
            var langToggleButton = document.getElementById('lang-toggle');
            var langPopup = document.getElementById('lang-list');

            function showLangs() {
                langPopup.style.display = 'block';
                langToggleButton.setAttribute('aria-expanded', true);
            }

            function hideLangs() {
                langPopup.style.display = 'none';
                langToggleButton.setAttribute('aria-expanded', false);
                langToggleButton.focus();
            }

            langToggleButton.addEventListener('click', function () {
                if (langPopup.style.display === 'block') {
                    hideLangs();
                } else {
                    showLangs();
                }
            });

            langPopup.addEventListener('click', function (e) {
               let langs = [
                        'cn',
                        'en'
                    ];
                var lang = e.target.id || e.target.parentElement.id;
                var path_list=[];
                window.location.pathname.split('/').map((s, idx) => {
                    if (idx == 1){
                        if(!langs.includes(s)){
                            path_list.push(lang);
                            path_list.push(s);
                        }else{
                            path_list.push(lang);
                        }
                    }else{
                        path_list.push(s);
                    }
                });
                console.log("path:");
                window.location.pathname = path_list.join('/');
            });

            langPopup.addEventListener('focusout', function(e) {
                // e.relatedTarget is null in Safari and Firefox on macOS (see workaround below)
                if (!!e.relatedTarget && !langToggleButton.contains(e.relatedTarget) && !langPopup.contains(e.relatedTarget)) {
                    hideLangs();
                }
            });

            // Should not be needed, but it works around an issue on macOS & iOS: https://github.com/rust-lang-nursery/mdBook/issues/628
            document.addEventListener('click', function(e) {
                if (langPopup.style.display === 'block' && !langToggleButton.contains(e.target) && !langPopup.contains(e.target)) {
                    hideLangs();
                }
            });

        })();
        </script>

    </body>
</html>
